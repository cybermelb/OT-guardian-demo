<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian App (V3 - Finalized Deployment)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Print/PDF Optimization for Reports -->
    <style>
        @media print {
            .print-hide { display: none !important; }
            .print-full { max-width: none !important; margin: 0 !important; padding: 0 !important; }
            body, .bg-gray-100 { background-color: white !important; }
            .table-responsive td, .table-responsive th { white-space: normal !important; }
        }
    </style>

    <!-- Load Firebase SDKs as a module for global use -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase services globally for the main Vanilla JS script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken,
            onAuthStateChanged, signOut, getFirestore, doc, setDoc,
            collection, query, onSnapshot, serverTimestamp, setLogLevel
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-[Inter]">
    <!-- Root Container -->
    <div id="root" class="min-h-screen"></div>

    <script>
        // --- HARDCODED FIREBASE CONFIGURATION (User provided values) ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAyDKqA-j9yjp4KeGPGR49Cr6_q_drxBVs",
            authDomain: "otgaurdian.firebaseapp.com",
            projectId: "otgaurdian",
            storageBucket: "otgaurdian.firebasestorage.app",
            messagingSenderId: "719542806938",
            appId: "1:719542806938:web:ed9376fcc7d04851e47223",
            measurementId: "G-9FMPGC5C93"
        };
        const DEFAULT_APP_ID = MANUAL_FIREBASE_CONFIG.projectId;

        // --- GLOBAL APP STATE ---
        const appState = {
            currentView: 'riskDashboard',
            isAuthenticated: false,
            isAuthReady: false,
            isFirebaseReady: false,
            userId: null,
            userRole: 'Engineer',
            data: { assets: [], controls: [], risks: [], tasks: [] },
            deploymentStatus: { status: 'Unknown', message: 'Initializing...', lastCheck: null },
            error: null,
            db: null,
            auth: null,
            appId: DEFAULT_APP_ID, // Default to hardcoded project ID
            dataInitialized: false
        };

        // --- HELPER FUNCTIONS ---
       
        function createElement(tag, classes = '', content = '') {
            const el = document.createElement(tag);
            if (classes) el.className = classes;
            if (typeof content === 'string') {
                el.innerHTML = content;
            } else if (content instanceof Node) {
                el.appendChild(content);
            } else if (Array.isArray(content)) {
                content.forEach(c => el.appendChild(c));
            }
            return el;
        }

        function getIcon(name, classes = 'w-5 h-5') {
            const iconElement = document.createElement('i');
            iconElement.className = classes;
            iconElement.innerHTML = `<svg data-lucide="${name}" class="${classes}"></svg>`;
            return iconElement;
        }

        function createMessageBox(type, message, onClose) {
            if (!message) return createElement('div');
            let colorClass, IconName;
            switch (type) {
                case 'success':
                    colorClass = "bg-green-100 text-green-800 border border-green-300";
                    IconName = 'check-circle';
                    break;
                case 'error':
                    colorClass = "bg-red-100 text-red-800 border border-red-300";
                    IconName = 'alert-triangle';
                    break;
                default:
                    colorClass = "bg-blue-100 text-blue-800 border border-blue-300";
                    IconName = 'info';
            }
            const box = createElement('div', `p-4 rounded-xl shadow-lg flex items-center mb-4 transition-all duration-300 ${colorClass}`);
            box.appendChild(getIcon(IconName, 'w-5 h-5 mr-3 flex-shrink-0'));
            box.appendChild(createElement('span', 'text-sm font-medium flex-grow', message));
            if (onClose) {
                const closeBtn = createElement('button', 'ml-4 text-gray-500 hover:text-gray-700');
                closeBtn.appendChild(getIcon('x', 'w-4 h-4'));
                closeBtn.addEventListener('click', onClose);
                box.appendChild(closeBtn);
            }
            return box;
        }
       
        function getSeverityClass(severity) {
            switch (severity) {
                case 'Critical': return 'bg-red-100 text-red-800 border-red-500';
                case 'High': return 'bg-yellow-100 text-yellow-800 border-yellow-500';
                case 'Medium': return 'bg-orange-100 text-orange-800 border-orange-500';
                default: return 'bg-blue-100 text-blue-800 border-blue-500';
            }
        }

        // --- EXPORT FUNCTIONS ---
        function exportToCSV(filename, data, columns) {
            if (data.length === 0) {
                console.error("No data to export!");
                return;
            }
            const header = columns.map(col => `"${col.header}"`).join(',');
            const rows = data.map(row => {
                return columns.map(col => {
                    const value = row[col.field] !== undefined && row[col.field] !== null ? String(row[col.field]).replace(/"/g, '""') : '';
                    return `"${value}"`;
                }).join(',');
            }).join('\n');
            const csvContent = header + '\n' + rows;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.warn("Your browser does not support CSV download.");
            }
        }
       
        function exportToPDF() {
            window.print();
        }
       
        // --- VIEW CREATION FUNCTIONS (Auditor, Dashboard, Admin) ---
       
        function createLoadingView() {
            const container = createElement('div', 'flex flex-col justify-center items-center h-96');
            const spinner = createElement('div', 'animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500');
            const text = createElement('p', 'mt-4 text-lg text-gray-600', 'Authenticating and loading real-time data...');
            container.append(spinner, text);
            return container;
        }

        function createRiskDashboardView(data) {
            // (Dashboard content implementation - same as previous version)
            const container = createElement('div', 'space-y-6');
            container.appendChild(createElement('h2', 'text-3xl font-extrabold text-gray-900 border-b pb-2', 'OT Risk Dashboard'));
           
            // Key Metrics Cards
            const criticalCount = data.risks.filter(r => r.severity === 'Critical').length;
            const cardsData = [
                { title: "Total Assets", value: data.assets.length, icon: 'cpu', color: "text-indigo-500", bg: "bg-indigo-50" },
                { title: "Critical Risks", value: criticalCount, icon: 'shield', color: criticalCount > 0 ? "text-red-500" : "text-green-500", bg: criticalCount > 0 ? "bg-red-50" : "bg-green-50" },
                { title: "Controls Deployed", value: data.controls.filter(c => c.status === 'Deployed').length, icon: 'check-circle', color: "text-green-500", bg: "bg-green-50" },
            ];

            const cardsGrid = createElement('div', 'grid grid-cols-1 md:grid-cols-3 gap-6');
            cardsData.forEach(card => {
                const cardEl = createElement('div', `p-6 rounded-xl shadow-lg ${card.bg} border-l-4 border-indigo-400`);
                const content = createElement('div', 'flex items-center');
                content.appendChild(getIcon(card.icon, `w-8 h-8 ${card.color} mr-4`));
                content.appendChild(createElement('div', '', [
                    createElement('p', 'text-sm font-medium text-gray-500', card.title),
                    createElement('p', 'text-3xl font-bold text-gray-900', card.value.toString())
                ]));
                cardEl.appendChild(content);
                cardsGrid.appendChild(cardEl);
            });
            container.appendChild(cardsGrid);

            // Risk Breakdown Table
            container.appendChild(createElement('h3', 'text-2xl font-semibold text-gray-800 pt-4', 'Top 5 Outstanding Risks'));
           
            const tableContainer = createElement('div', 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive border');
            const table = createElement('table', 'min-w-full divide-y divide-gray-200');
            const thead = createElement('thead', 'bg-gray-50');
            const trHead = createElement('tr');
            ['Risk ID', 'Description', 'Asset', 'Severity', 'Status'].forEach(header => {
                trHead.appendChild(createElement('th', 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider', header));
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = createElement('tbody', 'bg-white divide-y divide-gray-200');
            data.risks.sort((a, b) => {
                const severityOrder = { 'Critical': 1, 'High': 2, 'Medium': 3, 'Low': 4 };
                return severityOrder[a.severity] - severityOrder[b.severity];
            }).slice(0, 5).forEach(risk => {
                const trBody = createElement('tr', 'hover:bg-gray-50 transition-colors');
                const assetName = data.assets.find(a => a.id === risk.assetId)?.name || 'N/A';
               
                const severityClass = getSeverityClass(risk.severity);

                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900', risk.id.substring(0, 8)));
                trBody.appendChild(createElement('td', 'px-6 py-4 text-sm text-gray-500', risk.description));
                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500', assetName));
               
                const severityTd = createElement('td', 'px-6 py-4 whitespace-nowrap text-sm font-semibold');
                severityTd.appendChild(createElement('span', `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${severityClass}`, risk.severity));
                trBody.appendChild(severityTd);
               
                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500', risk.status));
               
                tbody.appendChild(trBody);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);

            return container;
        }

        function createAuditorReportView(data) {
            // (Auditor Report content implementation - same as previous version, including CSV/PDF)
            const container = createElement('div', 'space-y-6');
            container.appendChild(createElement('h2', 'text-3xl font-extrabold text-gray-900 border-b pb-2 flex items-center', [
                getIcon('file-text', 'w-7 h-7 mr-2 text-indigo-600'),
                createElement('span', '', 'Auditor Risk Summary Report')
            ]));

            // --- Aggregation Logic ---
            const riskCounts = data.risks.reduce((acc, risk) => {
                acc.severity[risk.severity] = (acc.severity[risk.severity] || 0) + 1;
                acc.status[risk.status] = (acc.status[risk.status] || 0) + 1;
                return acc;
            }, { severity: {}, status: {} });
           
            const totalRisks = data.risks.length;
            const severityKeys = ['Critical', 'High', 'Medium', 'Low'];
            const statusKeys = ['Open', 'In Progress', 'Closed', 'False Positive'];

            // --- Export Controls ---
            const exportDiv = createElement('div', 'flex space-x-4 print-hide');
           
            const csvBtn = createElement('button', 'flex items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-all');
            csvBtn.append(getIcon('file-text', 'w-5 h-5 mr-2'), document.createTextNode('Download Risk CSV'));
            csvBtn.addEventListener('click', () => {
                const columns = [
                    { header: 'ID', field: 'id' },
                    { header: 'Description', field: 'description' },
                    { header: 'Asset ID', field: 'assetId' },
                    { header: 'Severity', field: 'severity' },
                    { header: 'Status', field: 'status' },
                ];
                exportToCSV('OT_Guardian_Risk_Report.csv', data.risks, columns);
            });
            exportDiv.appendChild(csvBtn);
           
            const pdfBtn = createElement('button', 'flex items-center px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-all');
            pdfBtn.append(getIcon('printer', 'w-5 h-5 mr-2'), document.createTextNode('Export PDF (Print)'));
            pdfBtn.addEventListener('click', exportToPDF);
            exportDiv.appendChild(pdfBtn);

            container.appendChild(exportDiv);


            // --- Summary Aggregation Tables ---
           
            // 1. Severity Summary
            container.appendChild(createElement('h3', 'text-2xl font-semibold text-gray-800 pt-6 pb-2', '1. Risk Severity Breakdown'));
           
            const severityTableContainer = createElement('div', 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive border');
            const severityTable = createElement('table', 'min-w-full divide-y divide-gray-200');
           
            severityTable.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${severityKeys.map(key => {
                        const count = riskCounts.severity[key] || 0;
                        const percentage = totalRisks > 0 ? ((count / totalRisks) * 100).toFixed(1) : 0;
                        const severityClass = getSeverityClass(key);
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full ${severityClass}">${key}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${count}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${percentage}%</td>
                            </tr>
                        `;
                    }).join('')}
                    <tr>
                        <td class="px-6 py-4 text-lg font-extrabold text-gray-900">TOTAL</td>
                        <td class="px-6 py-4 text-lg font-extrabold text-gray-900">${totalRisks}</td>
                        <td class="px-6 py-4 text-lg font-extrabold text-gray-900">100.0%</td>
                    </tr>
                </tbody>
            `;
            severityTableContainer.appendChild(severityTable);
            container.appendChild(severityTableContainer);


            // 2. Status Summary
            container.appendChild(createElement('h3', 'text-2xl font-semibold text-gray-800 pt-6 pb-2', '2. Risk Status Summary'));
           
            const statusTableContainer = createElement('div', 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive border');
            const statusTable = createElement('table', 'min-w-full divide-y divide-gray-200');
           
            statusTable.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resolution %</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${statusKeys.map(key => {
                        const count = riskCounts.status[key] || 0;
                        const resolutionRate = key === 'Closed' ? (count / totalRisks) * 100 : 0;
                        const statusClass = key === 'Closed' ? 'bg-green-100 text-green-800' :
                                            key === 'Open' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full ${statusClass}">${key}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${count}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${resolutionRate > 0 ? resolutionRate.toFixed(1) + '%' : 'N/A'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            statusTableContainer.appendChild(statusTable);
            container.appendChild(statusTableContainer);
           
            return container;
        }

        function createAdminView() {
            // (Admin view implementation - same as previous version)
            const { userId, userRole, isFirebaseReady } = appState;
           
            const mockUsers = [
                { id: 1, email: 'cybermel@gmail.com', role: 'Admin (Mock)', lastLogin: '2025-11-28' },
                { id: 2, email: 'faysalhasn2001@yahoo.com', role: 'Engineer (Mock)', lastLogin: '2025-11-27' },
                { id: 3, email: 'auditor@otg.com', role: 'Auditor (Mock)', lastLogin: '2025-11-29' },
            ];

            let userEmail = 'N/A (Anonymous/Uninitialized)';
            if (isFirebaseReady && appState.auth && appState.auth.currentUser) {
                userEmail = appState.auth.currentUser.email || 'Anonymous';
            }

            const currentUserInfo = {
                id: 99,
                email: userEmail,
                role: userRole || 'Loading...',
                lastLogin: new Date().toLocaleDateString(),
                isCurrent: true
            };

            const allUsers = [currentUserInfo, ...mockUsers.filter(u => u.email !== currentUserInfo.email && u.email !== userEmail)];

            const container = createElement('div', 'space-y-6');
            container.appendChild(createElement('h2', 'text-3xl font-extrabold text-gray-900 border-b pb-2 flex items-center', [
                getIcon('users', 'w-7 h-7 mr-2 text-indigo-600'),
                createElement('span', '', 'User & Application Management')
            ]));
           
            const statusBox = createElement('div', 'bg-indigo-50 border-l-4 border-indigo-400 text-indigo-700 p-4 rounded-xl shadow-md');
            statusBox.appendChild(createElement('p', 'font-bold', 'Your Current Role Status:'));
            statusBox.appendChild(createElement('p', 'text-sm', `User ID (UID): ` + `<span class="font-mono bg-indigo-100 p-1 rounded text-xs">${userId || 'N/A'}</span>`));
            statusBox.appendChild(createElement('p', 'text-sm', `Authenticated Role (from token claims): ` + `<span class="font-bold text-lg text-indigo-900">${userRole}</span>`));
            container.appendChild(statusBox);

            container.appendChild(createElement('h3', 'text-2xl font-semibold text-gray-800 pt-4', 'Mock User Management (Demonstration)'));

            const tableContainer = createElement('div', 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive border');
            const table = createElement('table', 'min-w-full divide-y divide-gray-200');
           
            // Table Head
            const thead = createElement('thead', 'bg-gray-50');
            const trHead = createElement('tr');
            ['Email', 'Role', 'Last Login', 'Status'].forEach(header => {
                trHead.appendChild(createElement('th', 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider', header));
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Table Body
            const tbody = createElement('tbody', 'bg-white divide-y divide-gray-200');
            allUsers.forEach(user => {
                const trBody = createElement('tr', `${user.isCurrent ? 'bg-indigo-50 font-bold' : 'hover:bg-gray-50'} transition-colors`);
               
                const roleClass = user.role.includes('Admin') ? 'bg-red-100 text-red-800' :
                                  user.role.includes('Engineer') ? 'bg-green-100 text-green-800' :
                                  'bg-blue-100 text-blue-800';

                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-900', user.email));
               
                const roleTd = createElement('td', 'px-6 py-4 whitespace-nowrap text-sm font-semibold');
                roleTd.appendChild(createElement('span', `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}`, user.role));
                trBody.appendChild(roleTd);
               
                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500', user.lastLogin));
               
                const statusTd = createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500');
                statusTd.innerHTML = user.isCurrent ? '<span class="text-indigo-600 font-bold">Current User</span>' : 'Active';
                trBody.appendChild(statusTd);
               
                tbody.appendChild(trBody);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);

            return container;
        }

        function createPlaceholderView(title, roleRequired) {
            const container = createElement('div', 'p-6 bg-gray-50 rounded-xl shadow-inner');
            container.appendChild(createElement('h2', 'text-2xl font-bold text-gray-800', title));
            container.appendChild(createElement('p', 'text-indigo-600 mt-2 font-medium', `[Feature Development Required] - Full CRUD functionality for this section needs to be implemented.`));
            container.appendChild(createElement('p', 'text-gray-600 mt-1', `Access: ${roleRequired}`));
            return container;
        }

        // --- MAIN RENDER LOOP ---

        function render() {
            const root = document.getElementById('root');
            if (!root) return; // Guard clause in case DOM is not ready
            root.innerHTML = '';

            const container = createElement('div', 'min-h-screen bg-gray-100 print-full');
            const maxWDiv = createElement('div', 'max-w-7xl mx-auto');
            container.appendChild(maxWDiv);

            // 1. Message Box Area
            const msgArea = createElement('div', 'p-4 pt-8 print-hide');
            const message = appState.error || (appState.isFirebaseReady && appState.isAuthenticated ?
                `Welcome, User ID: ${appState.userId.substring(0, 8)}... Current Role: ${appState.userRole}` :
                "Connecting/Authenticating...");
            const type = appState.error ? 'error' : (appState.isAuthenticated ? 'success' : 'info');
           
            msgArea.appendChild(createMessageBox(type, message, () => {
                appState.error = null;
                render();
            }));
            maxWDiv.appendChild(msgArea);

            // 2. Header
            const header = createElement('header', 'flex justify-between items-center p-4 bg-white shadow-md rounded-b-xl print-hide');
            const logo = createElement('div', 'flex items-center');
            logo.appendChild(getIcon('shield', 'w-8 h-8 text-indigo-600 mr-3'));
            logo.appendChild(createElement('h1', 'text-2xl font-bold text-gray-900', 'OT Guardian <span class="text-indigo-600">Demo</span>'));
            header.appendChild(logo);

            const userControls = createElement('div', 'flex items-center space-x-4');
            userControls.appendChild(createElement('span', 'text-sm font-medium text-gray-600 hidden sm:block',
                `Role: <span class="font-semibold ${appState.userRole === 'Admin' ? 'text-red-600' : 'text-indigo-600'}">${appState.userRole}</span>`
            ));
           
            if (appState.isAuthenticated) {
                const signOutBtn = createElement('button', 'flex items-center p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-all shadow-md', getIcon('log-out', 'w-5 h-5'));
                signOutBtn.title = "Sign Out";
                signOutBtn.addEventListener('click', handleSignOut);
                userControls.appendChild(signOutBtn);
            }
            header.appendChild(userControls);
            maxWDiv.appendChild(header);

            // 3. Navigation Bar
            const nav = createElement('nav', 'flex space-x-1 p-3 border-b bg-white shadow-inner rounded-xl mt-4 mx-4 overflow-x-auto whitespace-nowrap print-hide');
           
            const navItems = [
                { view: 'riskDashboard', label: 'Dashboard', icon: 'bar-chart-2', roles: ['Engineer', 'Auditor', 'Admin'] },
                { view: 'assetBuilder', label: 'Assets', icon: 'cpu', roles: ['Engineer', 'Admin'] },
                { view: 'securityControls', label: 'Controls', icon: 'check-circle', roles: ['Engineer', 'Auditor', 'Admin'] },
                { view: 'remediationTasks', label: 'Remediation', icon: 'hard-hat', roles: ['Engineer', 'Admin'] },
                { view: 'auditorReport', label: 'Auditor Report', icon: 'file-text', roles: ['Auditor', 'Admin'] },
                { view: 'admin', label: 'Admin', icon: 'users', roles: ['Admin'] },
            ];

            navItems.forEach(item => {
                if (!item.roles.includes(appState.userRole)) return;

                const btn = createElement('button', `flex items-center px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-150`);
                btn.classList.add(appState.currentView === item.view ? 'bg-indigo-700' 'text-white' 'shadow-md' : 'text-gray-700' 'hover:bg-indigo-100');
               
                const icon = getIcon(item.icon, 'w-4 h-4 mr-2');
                const label = document.createTextNode(item.label);
               
                btn.append(icon, label);
                btn.addEventListener('click', () => {
                    appState.currentView = item.view;
                    render();
                });
                nav.appendChild(btn);
            });
            maxWDiv.appendChild(nav);

            // 4. Deployment Status Bar
            const statusClass = appState.deploymentStatus.status === 'Online' ? 'bg-green-100 text-green-800' :
                                appState.deploymentStatus.status === 'Warning' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800';
           
            const lastCheckTime = appState.deploymentStatus.lastCheck?.seconds ?
                new Date(appState.deploymentStatus.lastCheck.seconds * 1000).toLocaleString() : 'N/A';

            const statusBar = createElement('div', `p-3 text-sm font-semibold rounded-xl text-center shadow-md mt-4 mx-4 ${statusClass} print-hide`);
            statusBar.innerHTML = `${getIcon('zap', 'w-4 h-4 inline mr-1').outerHTML} Deployment Status: ${appState.deploymentStatus.status} | Last Check: ${lastCheckTime}`;
            maxWDiv.appendChild(statusBar);


            // 5. Main Content Area
            const main = createElement('main', 'p-4 sm:p-6');
            const contentBox = createElement('div', 'bg-white p-6 rounded-xl shadow-2xl');
            main.appendChild(contentBox);

            let contentElement;

            if (!appState.isAuthReady) {
                contentElement = createLoadingView();
            } else if (!appState.isFirebaseReady) {
                // Mock Mode View Fallback
                const mockModeContainer = createElement('div', 'text-center p-12');
                mockModeContainer.appendChild(createElement('h2', 'text-3xl font-bold text-red-600 mb-4', 'MOCK DATA MODE (OFFLINE)'));
                mockModeContainer.appendChild(createElement('p', 'text-xl text-gray-700 mb-8', 'Authentication failed or Firebase connection is offline. Displaying static data.'));
                contentElement = mockModeContainer;
            } else {
                const currentData = appState.data.risks.length > 0 ? appState.data : appState.mockData;

                switch (appState.currentView) {
                    case 'riskDashboard':
                        contentElement = createRiskDashboardView(currentData);
                        break;
                    case 'assetBuilder':
                    case 'securityControls':
                    case 'remediationTasks':
                        const requiredRole = appState.currentView === 'securityControls' ? 'Engineer/Auditor/Admin' : 'Engineer/Admin';
                        contentElement = createPlaceholderView(appState.currentView.split(/(?=[A-Z])/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '), requiredRole);
                        break;
                    case 'auditorReport':
                        if (appState.userRole === 'Auditor' || appState.userRole === 'Admin') {
                            contentElement = createAuditorReportView(currentData);
                        } else {
                            contentElement = createElement('div', 'p-6 text-red-500 font-bold', 'Access Denied: Requires Auditor or Admin role.');
                        }
                        break;
                    case 'admin':
                        if (appState.userRole === 'Admin') {
                            contentElement = createAdminView();
                        } else {
                            contentElement = createElement('div', 'p-6 text-red-500 font-bold', 'Access Denied: Requires Admin role.');
                        }
                        break;
                    default:
                        contentElement = createRiskDashboardView(currentData);
                }
            }
           
            contentBox.appendChild(contentElement);
            maxWDiv.appendChild(main);
            root.appendChild(container);

            window.lucide.createIcons();
        }

        // --- FIREBASE LOGIC ---

        async function updateAuthState(user) {
            if (user) {
                appState.isAuthenticated = true;
                appState.userId = user.uid;
               
                try {
                    // Force token refresh to read custom claims (role)
                    const idTokenResult = await user.getIdTokenResult(true);
                    const role = idTokenResult.claims.role || 'Engineer';
                    appState.userRole = role;
                    console.log(`User UID: ${user.uid} | Role set from token claims: ${role}`);
                } catch (e) {
                    console.error("Failed to get ID token result, defaulting role:", e);
                    appState.userRole = 'Engineer';
                }
            } else {
                appState.isAuthenticated = false;
                appState.userId = null;
                appState.userRole = 'Engineer';
            }
            appState.isAuthReady = true;
            render();
           
            if (appState.isFirebaseReady && appState.isAuthenticated && !appState.dataInitialized) {
                initializeDataListeners();
            }
        }

        async function initializeDataListeners() {
            if (!appState.db || !appState.userId || appState.dataInitialized) return;

            appState.dataInitialized = true;
            const userIdPath = appState.userId;

            const collectionsToListen = [
                { stateKey: 'assets', path: `artifacts/${appState.appId}/users/${userIdPath}/assets` },
                { stateKey: 'controls', path: `artifacts/${appState.appId}/users/${userIdPath}/controls` },
                { stateKey: 'risks', path: `artifacts/${appState.appId}/users/${userIdPath}/risks` },
                { stateKey: 'tasks', path: `artifacts/${appState.appId}/users/${userIdPath}/tasks` },
            ];

            collectionsToListen.forEach(({ stateKey, path }) => {
                const colRef = window.firebase.collection(appState.db, path);
                const q = window.firebase.query(colRef);
                window.firebase.onSnapshot(q, (snapshot) => {
                    appState.data[stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (err) => {
                    console.error(`Error fetching ${stateKey}:`, err);
                    appState.error = `Failed to load ${stateKey} data. Check Firestore rules.`;
                    render();
                });
            });

            // Deployment status listener (public data)
            const statusDocRef = window.firebase.doc(appState.db, `artifacts/${appState.appId}/public/data/deployment/status`);
            window.firebase.onSnapshot(statusDocRef, (doc) => {
                if (doc.exists()) {
                    appState.deploymentStatus = doc.data();
                } else {
                    const defaultStatus = { status: 'Warning', lastCheck: window.firebase.serverTimestamp(), message: 'Status document missing. Initializing...' };
                    window.firebase.setDoc(statusDocRef, defaultStatus, { merge: true }).catch(e => console.error("Error setting default status:", e));
                    appState.deploymentStatus = defaultStatus;
                }
                render();
            }, (err) => {
                console.error("Error fetching deployment status:", err);
                render();
            });
        }

        async function signInUser() {
            if (!appState.auth) return;
            try {
                // Determine which config/token to use
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
               
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(appState.auth, initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(appState.auth);
                }
            } catch (e) {
                console.error("Authentication Error:", e.message);
                appState.error = "Authentication failed. App will run in mock mode.";
                appState.isAuthReady = true;
                appState.isFirebaseReady = false; // Force mock mode if auth fails
                render();
            }
        }

        async function handleSignOut() {
            if (appState.auth) {
                try {
                    await window.firebase.signOut(appState.auth);
                    appState.currentView = 'riskDashboard';
                    appState.error = "Successfully signed out.";
                    render();
                } catch (e) {
                    console.error("Sign out error:", e);
                    appState.error = "Failed to sign out.";
                    render();
                }
            }
        }

        // --- MOCK DATA (For display when persistence fails) ---
        appState.mockData = {
            assets: [
                { id: 'a1', name: 'PLC-101 (MOCK)', location: 'Floor 1', type: 'Controller' },
                { id: 'a2', name: 'HMI-203 (MOCK)', location: 'Control Room', type: 'Interface' },
                { id: 'a3', name: 'Sensor Array 5 (MOCK)', location: 'Assembly Line', type: 'Sensor' }
            ],
            controls: [
                { id: 'c1', name: 'Network Segmentation', status: 'Deployed' },
                { id: 'c2', name: 'Endpoint Protection', status: 'Deployed' },
                { id: 'c3', name: 'Patch Management', status: 'In Progress' }
            ],
            risks: [
                { id: 'r1', description: 'Unpatched firmware on PLC-101', assetId: 'a1', severity: 'Critical', status: 'Open' },
                { id: 'r2', description: 'Weak password policy on HMI-203', assetId: 'a2', severity: 'High', status: 'Open' },
                { id: 'r3', description: 'Missing network baseline for Sensor Array 5', assetId: 'a3', severity: 'Medium', status: 'In Progress' },
                { id: 'r4', description: 'Potential phishing vector', assetId: 'a3', severity: 'Low', status: 'Closed' },
                { id: 'r5', description: 'Zero-day vulnerability in SCADA server', assetId: 'a1', severity: 'Critical', status: 'Open' },
                { id: 'r6', description: 'Unused old port open on PLC-101', assetId: 'a1', severity: 'Medium', status: 'Closed' }
            ],
            tasks: []
        };


        // --- INITIALIZATION ENTRY POINT ---
        window.onload = function() {
            // Check for Firebase availability (from the module script above)
            if (typeof window.firebase === 'undefined' || !window.firebase.initializeApp) {
                console.error("Firebase services failed to load from CDN. Check network connection.");
                appState.error = "CRITICAL: Firebase services failed to load. Cannot connect to database.";
                appState.isAuthReady = true;
                render();
                return;
            }

            try {
                // Initialize using the hardcoded configuration
                const app = window.firebase.initializeApp(MANUAL_FIREBASE_CONFIG);
                appState.db = window.firebase.getFirestore(app);
                appState.auth = window.firebase.getAuth(app);
                window.firebase.setLogLevel('debug');
                appState.isFirebaseReady = true;
                appState.appId = MANUAL_FIREBASE_CONFIG.projectId;
               
                // Set up auth listener (this updates appState.isAuthReady and calls render/data listeners)
                window.firebase.onAuthStateChanged(appState.auth, updateAuthState);

                // Start the sign-in process
                signInUser();

            } catch (e) {
                console.error("Fatal Firebase Initialization Error:", e);
                appState.error = "Fatal Firebase Error: Check console for configuration details.";
                appState.isAuthReady = true;
                appState.isFirebaseReady = false;
                render();
            }
        };
    </script>
</body>
</html>


