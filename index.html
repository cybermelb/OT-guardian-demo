<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian Production Ready Deployment</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, ReactDOM, and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Lucide Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Custom styling for print optimization -->
    <style>
        /* Set font to Inter */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Responsive & Print Styles */
        @media print {
            header, nav, .status-bar, .no-print {
                display: none !important;
            }
            body {
                background-color: #fff;
                margin: 0;
            }
            .main-content {
                padding: 0;
            }
            .page-break {
                page-break-before: always;
            }
        }
        
        /* Ensure all interactive elements have rounded corners */
        .rounded-xl, .rounded-lg, .rounded-full {
            border-radius: 0.75rem; /* Tailwind default for xl */
        }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import all necessary Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services globally for the React component (required for Babel/script interop)
        window.firebase = {
            initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel, deleteDoc
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // Lucide icons
        const { X, CheckCircle, AlertTriangle, Cpu, HardHat, BarChart2, Shield, Settings, User, LogOut, Zap, Download, ArrowDownUp } = lucide;

        // --- FIREBASE GLOBALS AND CONFIGURATION ---
        const { 
            initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel, deleteDoc
        } = window.firebase || {};

        let firebaseConfig = {};
        let appId = 'default-app-id';

        // Set the user's specific Firebase configuration as the default fallback
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAyDKqA-j9yjp4KeGPGR49Cr6_q_drxBVs",
            authDomain: "otgaurdian.firebaseapp.com",
            projectId: "otgaurdian",
            storageBucket: "otgaurdian.firebasestorage.app",
            messagingSenderId: "719542806938",
            appId: "1:719542806938:web:ed9376fcc7d04851e47223",
            measurementId: "G-9FMPGC5C93"
        };
        
        // Demo UIDs for role assignment (Admin and Engineer roles)
        const TEST_UIDS = {
            admin: "ZP6wE0ha6FWY9G4wJGXaVhRHioj2", 
            engineer: "JzUrZlEonaPM59hJEEM3waNzNOk2", 
        };

        try {
            // Use global config if available, otherwise use the user's explicit config
            const fConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : USER_FIREBASE_CONFIG;
            const aId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            if (fConfig && fConfig.apiKey && fConfig.projectId) {
                firebaseConfig = fConfig;
                appId = aId;
                if(setLogLevel) setLogLevel('debug'); // Enable debug logging for Firestore
            }
        } catch (error) {
            console.error("Error parsing Firebase configuration:", error);
        }

        // Firestore Paths (All public data for multi-user collaboration)
        const USER_ROLES_PATH = `artifacts/${appId}/public/data/user_roles`;
        const ASSETS_PATH = `artifacts/${appId}/public/data/assets`;
        const CONTROLS_PATH = `artifacts/${appId}/public/data/security_controls`;
        const TASKS_PATH = `artifacts/${appId}/public/data/remediation_tasks`;
        const RISK_LOG_PATH = `artifacts/${appId}/public/data/risk_log`;
        const DEPLOYMENT_PATH = `artifacts/${appId}/public/data/deployment_status`;

        // --- DATA MODEL (Mock Data for initial state) ---
        const initialAssets = [
            { id: 'plc-001', name: 'PLC-A1', type: 'PLC', ip: '192.168.1.10', location: 'Cell 1', firmwareVersion: 'v3.2.1', protocol: 'Modbus', status: 'Active', vulnerabilityScore: 75, lastUpdated: new Date() },
            { id: 'hmi-002', name: 'HMI-B1', type: 'HMI', ip: '192.168.1.20', location: 'Control Room', firmwareVersion: 'v1.5.0', protocol: 'Ethernet/IP', status: 'Active', vulnerabilityScore: 40, lastUpdated: new Date() },
            { id: 'server-003', name: 'Historian SVR', type: 'Server', ip: '192.168.10.5', location: 'Data Center', firmwareVersion: 'Windows Svr 2019', protocol: 'TCP/IP', status: 'Inactive', vulnerabilityScore: 90, lastUpdated: new Date() },
        ];

        const initialControls = [
            { id: 'c-001', name: 'Network Segmentation', category: 'Access Control', status: 'Implemented', riskReduction: 30, compliance: ['NIST', 'IEC 62443'], description: 'Isolate OT network from IT.' },
            { id: 'c-002', name: 'Patch Management Policy', category: 'Maintenance', status: 'Planned', riskReduction: 10, compliance: ['NIST'], description: 'Routine patching of non-critical assets.' },
            { id: 'c-003', name: 'Strong Authentication', category: 'Access Control', status: 'Auditing', riskReduction: 20, compliance: ['IEC 62443'], description: 'Enforce multi-factor authentication on critical systems.' },
        ];

        const initialTasks = [
            { id: 't-001', name: 'Patch PLC-A1 Firmware', assetId: 'plc-001', priority: 'High', status: 'Open', assignedTo: 'Engineer', controlId: 'c-002', due: '2025-12-31', notes: 'Urgent patch required for CVE-2025-1010.' },
            { id: 't-002', name: 'Review Firewall Rules', assetId: 'server-003', priority: 'Medium', status: 'In Progress', assignedTo: 'Admin', controlId: 'c-001', due: '2026-01-15', notes: 'Ensure only necessary ports are open.' },
            { id: 't-003', name: 'Update HMI OS', assetId: 'hmi-002', priority: 'Low', status: 'Closed', assignedTo: 'Engineer', controlId: null, due: '2025-11-01', notes: 'Completed OS upgrade.' },
        ];

        const initialRiskLog = [
            { id: 'r-001', type: 'Phishing Attempt', severity: 'High', timestamp: { seconds: Date.now() / 1000 - 86400, nanoseconds: 0 }, details: 'Targeted email attack on Control Room staff.', status: 'Contained' },
            { id: 'r-002', type: 'Unauthorized Access', severity: 'Medium', timestamp: { seconds: Date.now() / 1000 - 3600, nanoseconds: 0 }, details: 'Failed login attempts on Historian SVR.', status: 'Mitigated' },
        ];

        // --- AUTH HOOK & ROLE MANAGEMENT ---
        const useAuth = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userRole, setUserRole] = useState('guest');
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Function to check if a user is one of the hardcoded demo UIDs
            const getDemoRole = (currentUserId) => {
                if (currentUserId === TEST_UIDS.admin) return 'admin';
                if (currentUserId === TEST_UIDS.engineer) return 'engineer';
                return null;
            }

            const fetchUserRole = useCallback((currentUserId, firestoreDb) => {
                if (!currentUserId || !firestoreDb) return 'guest';

                // 1. Check for demo role
                const demoRole = getDemoRole(currentUserId);
                if (demoRole) { 
                    setUserRole(demoRole); 
                    return; 
                }

                // 2. Fallback to Firestore role listener
                try {
                    const roleDocRef = doc(firestoreDb, USER_ROLES_PATH, currentUserId);
                    const unsubscribe = onSnapshot(roleDocRef, (docSnap) => {
                        if (docSnap.exists() && docSnap.data().role) {
                            setUserRole(docSnap.data().role);
                        } else {
                            setUserRole('guest');
                        }
                    }, (error) => {
                        console.error("Error fetching user role:", error);
                        setUserRole('guest');
                    });
                    return unsubscribe;
                } catch (error) {
                    console.error("Failed to set up role listener:", error);
                    return 'guest';
                }
            }, []);

            useEffect(() => {
                if (!initializeApp || !firebaseConfig.projectId) {
                    setIsAuthReady(true);
                    setUserId(crypto.randomUUID());
                    return;
                }
                
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app);
                    const firebaseAuth = getAuth(app);
                    setDb(firestoreDb);
                    setAuth(firebaseAuth);

                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    const authListener = onAuthStateChanged(firebaseAuth, async (currentUser) => {
                        if (currentUser) {
                            const currentUserId = currentUser.uid;
                            setUser(currentUser);
                            setUserId(currentUserId);
                            
                            // Fetch role based on UID (checking demo UIDs first, then Firestore)
                            const unsubscribeRole = fetchUserRole(currentUserId, firestoreDb);
                            if (typeof unsubscribeRole === 'function') return () => unsubscribeRole();
                            
                        } else {
                            // Sign in anonymously if no token or user is present
                            await firebaseAuth.signInAnonymously().catch(e => {
                                console.error("Anonymous sign-in failed:", e);
                            });
                            
                            // Set a temporary UUID if anonymous sign-in fails or is slow
                            setUserId(crypto.randomUUID()); 
                            setUserRole('guest');
                        }
                        
                        setIsAuthReady(true);
                    });

                    // Sign in with custom token if available (provided by Canvas)
                    if (initialAuthToken) {
                        signInWithCustomToken(firebaseAuth, initialAuthToken).catch(e => {
                            console.error("Custom token sign-in failed:", e);
                        });
                    }

                    return () => {
                        if (authListener) authListener();
                    };

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    setIsAuthReady(true);
                }
            }, [fetchUserRole]);

            const logout = useCallback(async () => {
                if (auth) {
                    try {
                        // Sign out and attempt to sign in anonymously again to maintain a session
                        await signOut(auth);
                        await auth.signInAnonymously();
                        setUser(null);
                        setUserId(auth.currentUser?.uid || crypto.randomUUID());
                        setUserRole('guest');
                    } catch (error) {
                        console.error("Logout failed:", error);
                    }
                }
            }, [auth]);

            return { db, userId, user, userRole, isAuthReady, logout, auth };
        };

        // --- ACCESS CONTROL FUNCTIONS ---
        const checkAdminAccess = (role) => role === 'admin';
        const checkEngineerOrAdminAccess = (role) => role === 'engineer' || role === 'admin';

        // --- EXPORT UTILITY ---
        const handleExportCsv = (data, filename = 'export.csv') => {
            if (!data || data.length === 0) {
                console.warn("No data to export.");
                return;
            }

            // Keys to exclude from the CSV (internal timestamps, IDs, etc.)
            const keysToExclude = ['id', 'lastUpdated', 'updatedBy', 'createdBy', 'createdAt', 'controlId', 'due', 'notes', 'timestamp'];
            const headerKeys = Object.keys(data[0]).filter(key => !keysToExclude.includes(key));
            const csvRows = [];
            
            // 1. Headers
            csvRows.push(headerKeys.join(','));

            // 2. Data rows
            for (const row of data) {
                const values = headerKeys.map(header => {
                    const value = row[header];
                    let output = '';
                    if (value !== null && value !== undefined) {
                        output = String(value).replace(/"/g, '""'); // Escape double quotes
                    }
                    if (output.includes(',') || output.includes('\n') || output.includes('"')) {
                        output = `"${output}"`; // Quote if special characters exist
                    }
                    return output;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };


        // --- COMPONENTS ---

        // Custom Confirmation Modal (Replaces window.confirm)
        const ConfirmModal = ({ title, message, onConfirm, onCancel, isOpen }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex justify-center items-center p-4 z-50 transition-opacity duration-300">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
                        <div className="p-6 text-center">
                            <AlertTriangle className="w-10 h-10 mx-auto text-red-500 mb-4" />
                            <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                            <p className="text-gray-600 mb-6">{message}</p>
                            <div className="flex justify-center space-x-3">
                                <button
                                    onClick={onCancel}
                                    className="px-4 py-2 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors"
                                >
                                    Confirm Deletion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // Generic Modal Component
        const Modal = ({ title, children, onClose, isOpen }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex justify-center items-center p-4 z-50 transition-opacity duration-300">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                                <X className="w-6 h-6" />
                            </button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // Component for handling data operations (Create, Update, Delete)
        const DataForm = ({ db, userId, role, dataPath, initialData, assetsList = [], isEdit = false, onClose }) => {
            const isAuthorized = checkEngineerOrAdminAccess(role);
            const [formData, setFormData] = useState(initialData || {});
            const [isSaving, setIsSaving] = useState(false);
            const [error, setError] = useState(null);
            const [isConfirmOpen, setIsConfirmOpen] = useState(false); 

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            
            // Client-side validation
            const validate = (data) => {
                let errors = [];
                if (dataPath === ASSETS_PATH) {
                    if (data.ip && !/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(data.ip)) {
                        errors.push("IP Address must be in IPv4 format (e.g., 192.168.1.1).");
                    }
                    const score = Number(data.vulnerabilityScore);
                    if (!isNaN(score) && (score < 0 || score > 100)) {
                        errors.push("Vulnerability Score must be between 0 and 100.");
                    }
                }
                if (!data.name || data.name.trim() === "") {
                    errors.push("Name field is required.");
                }
                return errors;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!isAuthorized) {
                    setError("Unauthorized: You do not have permission to modify this data.");
                    return;
                }
                
                const validationErrors = validate(formData);
                if (validationErrors.length > 0) {
                    setError(validationErrors.join(' '));
                    return;
                }

                setIsSaving(true);
                setError(null);

                try {
                    const dataToSave = {
                        ...formData,
                        // Ensure vulnerability score is stored as a number
                        vulnerabilityScore: formData.vulnerabilityScore ? Number(formData.vulnerabilityScore) : 0, 
                        lastUpdated: serverTimestamp(),
                        updatedBy: userId,
                    };

                    if (isEdit) {
                        const docRef = doc(db, dataPath, dataToSave.id);
                        await setDoc(docRef, dataToSave, { merge: true });
                    } else {
                        const newDocRef = doc(collection(db, dataPath));
                        await setDoc(newDocRef, { ...dataToSave, id: newDocRef.id, createdBy: userId, createdAt: serverTimestamp() });
                    }
                    onClose();
                } catch (err) {
                    console.error("Error saving document:", err);
                    setError(`Failed to save data: ${err.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDelete = async () => {
                if (!isEdit || !isAuthorized) return;
                setIsConfirmOpen(true);
            };

            const handleConfirmDelete = async () => {
                setIsConfirmOpen(false);
                setIsSaving(true);
                setError(null);
                try {
                    const docRef = doc(db, dataPath, formData.id);
                    await deleteDoc(docRef);
                    onClose();
                } catch (err) {
                    console.error("Error deleting document:", err);
                    setError(`Failed to delete data: ${err.message}`);
                } finally {
                    setIsSaving(false);
                }
            };
            
            // Define form fields dynamically
            const fields = useMemo(() => {
                switch (dataPath) {
                    case ASSETS_PATH:
                        return [
                            { name: 'name', label: 'Asset Name', type: 'text', required: true },
                            { name: 'type', label: 'Type (e.g., PLC, HMI, Server)', type: 'text', required: true },
                            { name: 'ip', label: 'IP Address', type: 'text', required: true },
                            { name: 'location', label: 'Location', type: 'text', required: true },
                            { name: 'firmwareVersion', label: 'Firmware Version', type: 'text', required: false },
                            { name: 'protocol', label: 'Protocol', type: 'text', required: false },
                            { name: 'status', label: 'Status', type: 'select', options: ['Active', 'Inactive', 'Maintenance'], required: true },
                            { name: 'vulnerabilityScore', label: 'Vulnerability Score (0-100)', type: 'number', required: false },
                        ];
                    case CONTROLS_PATH:
                        return [
                            { name: 'name', label: 'Control Name', type: 'text', required: true },
                            { name: 'category', label: 'Category', type: 'text', required: true },
                            { name: 'status', label: 'Status', type: 'select', options: ['Implemented', 'Auditing', 'Planned', 'Failed'], required: true },
                            { name: 'riskReduction', label: 'Risk Reduction %', type: 'number', required: false },
                            { name: 'description', label: 'Description', type: 'textarea', required: false },
                        ];
                    case TASKS_PATH:
                        const assetOptions = assetsList.map(a => a.id).sort();
                        return [
                            { name: 'name', label: 'Task Name', type: 'text', required: true },
                            { name: 'assetId', label: 'Linked Asset ID', type: 'select', options: ['None', ...assetOptions], required: false },
                            { name: 'priority', label: 'Priority', type: 'select', options: ['High', 'Medium', 'Low'], required: true },
                            { name: 'status', label: 'Status', type: 'select', options: ['Open', 'In Progress', 'Closed'], required: true },
                            { name: 'assignedTo', label: 'Assigned To', type: 'text', required: false },
                            { name: 'due', label: 'Due Date', type: 'date', required: false },
                            { name: 'notes', label: 'Notes', type: 'textarea', required: false },
                        ];
                    default:
                        return [];
                }
            }, [dataPath, assetsList]);

            if (!isAuthorized && (isEdit || Object.keys(initialData).length === 0)) {
                return (
                    <div className="p-4 text-center text-red-600 bg-red-50 rounded-lg">
                        <AlertTriangle className="w-6 h-6 inline mr-2" />
                        Access Denied: Only Engineers and Admins can create or edit data.
                    </div>
                );
            }

            return (
                <>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        {error && <div className="p-3 bg-red-100 text-red-700 rounded-lg">{error}</div>}
                        
                        {fields.map(field => (
                            <div key={field.name}>
                                <label className="block text-sm font-medium text-gray-700 mb-1">{field.label}{field.required ? ' *' : ''}</label>
                                {field.type === 'select' ? (
                                    <select
                                        name={field.name}
                                        value={formData[field.name] || (field.options && field.options[0]) || ''}
                                        onChange={handleChange}
                                        required={field.required}
                                        disabled={!isAuthorized || isSaving}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-50"
                                    >
                                        {field.options.map(option => (
                                            <option key={option} value={option}>{option}</option>
                                        ))}
                                    </select>
                                ) : field.type === 'textarea' ? (
                                    <textarea
                                        name={field.name}
                                        value={formData[field.name] || ''}
                                        onChange={handleChange}
                                        required={field.required}
                                        disabled={!isAuthorized || isSaving}
                                        rows="3"
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-50"
                                    />
                                ) : (
                                    <input
                                        type={field.type}
                                        name={field.name}
                                        value={formData[field.name] || ''}
                                        onChange={handleChange}
                                        required={field.required}
                                        disabled={!isAuthorized || isSaving}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-50"
                                        min={field.type === 'number' ? 0 : undefined}
                                        max={field.name === 'vulnerabilityScore' ? 100 : undefined}
                                    />
                                )}
                            </div>
                        ))}
                        
                        <div className="flex justify-between pt-4">
                            {isEdit && (
                                <button
                                    type="button"
                                    onClick={handleDelete}
                                    disabled={!isAuthorized || isSaving}
                                    className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors disabled:bg-red-300"
                                >
                                    Delete
                                </button>
                            )}
                            <div className={isEdit ? 'ml-auto space-x-2' : 'w-full text-right'}>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="px-4 py-2 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={!isAuthorized || isSaving}
                                    className="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-300"
                                >
                                    {isSaving ? 'Saving...' : (isEdit ? 'Update' : 'Create')}
                                </button>
                            </div>
                        </div>
                    </form>
                    <ConfirmModal
                        title="Confirm Deletion"
                        message={`Are you sure you want to permanently delete this ${dataPath.split('/').pop().slice(0, -1)} entry? This action cannot be undone.`}
                        isOpen={isConfirmOpen}
                        onConfirm={handleConfirmDelete}
                        onCancel={() => setIsConfirmOpen(false)}
                    />
                </>
            );
        };

        // Generic Table View Component
        const TableView = ({ title, icon, data, columns, dataPath, db, userId, role, onCreate, onEdit }) => {
            const isAuthorized = checkEngineerOrAdminAccess(role);
            const [filter, setFilter] = useState('');
            const [sortKey, setSortKey] = useState(null);
            const [sortDirection, setSortDirection] = useState('asc');

            const handleSort = (key) => {
                if (sortKey === key) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortKey(key);
                    setSortDirection('asc');
                }
            };

            const filteredAndSortedData = useMemo(() => {
                let items = data.filter(item => 
                    Object.values(item).some(val => 
                        String(val).toLowerCase().includes(filter.toLowerCase())
                    )
                );

                if (sortKey) {
                    items.sort((a, b) => {
                        const aVal = a[sortKey];
                        const bVal = b[sortKey];
                        // Handle numeric and string comparisons
                        if (!isNaN(Number(aVal)) && !isNaN(Number(bVal))) {
                            if (Number(aVal) < Number(bVal)) return sortDirection === 'asc' ? -1 : 1;
                            if (Number(aVal) > Number(bVal)) return sortDirection === 'asc' ? 1 : -1;
                        } else {
                            if (String(aVal) < String(bVal)) return sortDirection === 'asc' ? -1 : 1;
                            if (String(aVal) > String(bVal)) return sortDirection === 'asc' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return items;
            }, [data, filter, sortKey, sortDirection]);

            const exportFilename = `${dataPath.split('/').pop()}_report_${new Date().toISOString().slice(0, 10)}.csv`;

            return (
                <div className="p-6 bg-white rounded-xl shadow-lg main-content">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 no-print">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center mb-4 sm:mb-0">
                            {icon} {title}
                        </h2>
                        <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                             <button
                                onClick={() => handleExportCsv(data, exportFilename)}
                                className="flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors shadow-md"
                            >
                                <Download className="w-4 h-4 mr-1" /> Export CSV
                            </button>
                            <button
                                onClick={() => window.print()}
                                className="flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors shadow-md"
                            >
                                <Download className="w-4 h-4 mr-1 transform rotate-90" /> Print/PDF
                            </button>
                            {isAuthorized && (
                                <button
                                    onClick={onCreate}
                                    className="flex items-center justify-center px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md"
                                >
                                    <X className="w-4 h-4 mr-1 transform rotate-45" /> Add New
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="mb-4 no-print">
                        <input
                            type="text"
                            placeholder="Filter table..."
                            value={filter}
                            onChange={(e) => setFilter(e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        />
                    </div>

                    <div className="overflow-x-auto rounded-lg border border-gray-200">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    {columns.map(col => (
                                        <th
                                            key={col.key}
                                            onClick={() => col.sortable && handleSort(col.key)}
                                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors"
                                        >
                                            <div className="flex items-center">
                                                {col.header}
                                                {col.sortable && (
                                                    <ArrowDownUp className={`w-3 h-3 ml-1 transition-transform ${sortKey === col.key ? 'text-indigo-600' : 'text-gray-400'} ${sortKey === col.key && sortDirection === 'desc' ? 'rotate-180' : ''}`} />
                                                )}
                                            </div>
                                        </th>
                                    ))}
                                    {isAuthorized && <th className="px-6 py-3 no-print"></th>}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredAndSortedData.length === 0 ? (
                                    <tr>
                                        <td colSpan={columns.length + (isAuthorized ? 1 : 0)} className="px-6 py-4 text-center text-gray-500">
                                            No records found.
                                        </td>
                                    </tr>
                                ) : (
                                    filteredAndSortedData.map(item => (
                                        <tr key={item.id} className="hover:bg-indigo-50 transition-colors">
                                            {columns.map(col => (
                                                <td key={`${item.id}-${col.key}`} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {col.render ? col.render(item[col.key], item) : String(item[col.key])}
                                                </td>
                                            ))}
                                            {isAuthorized && (
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                                                    <button 
                                                        onClick={() => onEdit(item)} 
                                                        className="text-indigo-600 hover:text-indigo-900 transition-colors font-semibold"
                                                    >
                                                        Edit
                                                    </button>
                                                </td>
                                            )}
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- VIEW COMPONENTS ---

        const RiskDashboardView = ({ riskLog, assets, tasks }) => {
            const totalAssets = assets.length;
            const activeAssets = assets.filter(a => a.status === 'Active').length;
            const highRiskAlerts = riskLog.filter(r => r.severity === 'High' && r.status !== 'Closed' && r.status !== 'Contained').length;
            const avgVulnerability = (assets.reduce((sum, a) => sum + (a.vulnerabilityScore || 0), 0) / totalAssets) || 0;
            
            const taskCounts = tasks.reduce((acc, task) => {
                acc[task.status] = (acc[task.status] || 0) + 1;
                acc.total = (acc.total || 0) + 1;
                return acc;
            }, { 'Open': 0, 'In Progress': 0, 'Closed': 0, total: 0 });

            const riskBins = assets.reduce((acc, a) => {
                const score = a.vulnerabilityScore || 0;
                if (score >= 70) acc.High++;
                else if (score >= 40) acc.Medium++;
                else acc.Low++;
                return acc;
            }, { High: 0, Medium: 0, Low: 0 });
            
            const riskTypes = ['High', 'Medium', 'Low'];
            const maxCount = Math.max(...Object.values(riskBins), 1);
            
            const getSeverityColor = (severity) => {
                switch (severity) {
                    case 'High': return 'bg-red-500 text-red-700';
                    case 'Medium': return 'bg-yellow-500 text-yellow-700';
                    case 'Low': return 'bg-green-500 text-green-700';
                    default: return 'bg-gray-400 text-gray-700';
                }
            };
            
            const getTaskColor = (status) => {
                switch (status) {
                    case 'Open': return 'bg-red-500 text-red-700';
                    case 'In Progress': return 'bg-blue-500 text-blue-700';
                    case 'Closed': return 'bg-green-500 text-green-700';
                    default: return 'bg-gray-400 text-gray-700';
                }
            };
            
            const StatCard = ({ title, value, icon, color = 'indigo' }) => (
                <div className="bg-white p-5 rounded-xl shadow-md flex items-center justify-between transition-transform duration-300 hover:scale-[1.02]">
                    <div>
                        <p className="text-sm font-medium text-gray-500">{title}</p>
                        <p className="text-3xl font-bold text-gray-900 mt-1">{value}</p>
                    </div>
                    <div className={`p-3 bg-${color}-100 rounded-full`}>
                        {React.cloneElement(icon, { className: `w-6 h-6 text-${color}-500` })}
                    </div>
                </div>
            );

            return (
                <div className="space-y-6">
                    <h1 className="text-3xl font-extrabold text-gray-900 flex items-center">
                        <Shield className="w-8 h-8 mr-3 text-indigo-600" />
                        Operational Technology Risk Dashboard
                    </h1>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Total Assets" value={totalAssets} icon={<Cpu />} />
                        <StatCard title="Active Assets" value={activeAssets} icon={<CheckCircle />} color="teal" />
                        <StatCard title="Open High-Risk Alerts" value={highRiskAlerts} icon={<AlertTriangle />} color="red" />
                        <StatCard title="Avg. Vulnerability Score" value={avgVulnerability.toFixed(1)} icon={<BarChart2 />} color="yellow" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Risk Score Distribution */}
                        <div className="p-6 bg-white rounded-xl shadow-lg lg:col-span-1">
                            <h3 className="text-xl font-semibold mb-4 border-b pb-2 text-gray-800">Asset Risk Distribution</h3>
                            <div className="space-y-4">
                                {riskTypes.map(severity => (
                                    <div key={severity} className="flex items-center">
                                        <span className={`w-20 font-medium text-sm ${getSeverityColor(severity).replace('bg', 'text')}`}>{severity}</span>
                                        <div className="flex-1 ml-4 h-6 rounded-full bg-gray-200 overflow-hidden">
                                            <div 
                                                className={`${getSeverityColor(severity).split(' ')[0]} h-full transition-all duration-500`}
                                                style={{ width: `${(riskBins[severity] || 0) / maxCount * 100}%` }}
                                            ></div>
                                        </div>
                                        <span className="ml-3 font-bold text-gray-800">{riskBins[severity] || 0}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Task Status Breakdown */}
                         <div className="p-6 bg-white rounded-xl shadow-lg lg:col-span-1">
                            <h3 className="text-xl font-semibold mb-4 border-b pb-2 text-gray-800">Remediation Task Status</h3>
                            <p className="text-gray-500 text-sm mb-4">Total Tasks: {taskCounts.total}</p>
                            <div className="space-y-4">
                                {['Open', 'In Progress', 'Closed'].map(status => (
                                    <div key={status} className="flex items-center">
                                        <span className={`w-20 font-medium text-sm ${getTaskColor(status).replace('bg', 'text')}`}>{status}</span>
                                        <div className="flex-1 ml-4 h-6 rounded-full bg-gray-200 overflow-hidden">
                                            <div 
                                                className={`${getTaskColor(status).split(' ')[0]} h-full transition-all duration-500`}
                                                style={{ width: `${(taskCounts[status] || 0) / taskCounts.total * 100}%` }}
                                            ></div>
                                        </div>
                                        <span className="ml-3 font-bold text-gray-800">{taskCounts[status] || 0}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Recent Risk Log Entries */}
                        <div className="p-6 bg-white rounded-xl shadow-lg lg:col-span-1">
                            <h3 className="text-xl font-semibold mb-4 border-b pb-2 text-gray-800">Recent Risk Log Entries</h3>
                            <div className="space-y-3 max-h-80 overflow-y-auto">
                                {riskLog.slice(0, 5).map(log => {
                                    const severityColor = (severity) => {
                                        switch (severity) {
                                            case 'High': return 'bg-red-500 text-white';
                                            case 'Medium': return 'bg-yellow-500 text-gray-800';
                                            case 'Low': return 'bg-green-500 text-white';
                                            default: return 'bg-gray-400 text-white';
                                        }
                                    };
                                    
                                    const timestamp = log.timestamp && log.timestamp.seconds 
                                        ? new Date(log.timestamp.seconds * 1000) 
                                        : new Date(); 

                                    return (
                                        <div key={log.id} className="p-3 border-l-4 border-gray-200 hover:bg-gray-50 rounded-lg flex justify-between items-start transition-colors" style={{borderColor: log.severity === 'High' ? '#ef4444' : log.severity === 'Medium' ? '#f59e0b' : '#10b981'}}>
                                            <div>
                                                <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${severityColor(log.severity)}`}>
                                                    {log.severity}
                                                </span>
                                                <p className="text-gray-900 font-medium mt-1">{log.type}</p>
                                                <p className="text-gray-500 text-xs truncate max-w-xs">{log.details}</p>
                                            </div>
                                            <div className="text-right">
                                                <span className="text-xs text-gray-400 block">{timestamp.toLocaleTimeString()}</span>
                                                <span className="text-xs font-semibold text-indigo-600 mt-1">{log.status}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AssetBuilderView = ({ assets, dataPath, db, userId, role }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editData, setEditData] = useState(null);

            const columns = [
                { header: 'ID', key: 'id', sortable: true },
                { header: 'Name', key: 'name', sortable: true },
                { header: 'Type', key: 'type', sortable: true },
                { header: 'IP Address', key: 'ip', sortable: true },
                { header: 'FW Version', key: 'firmwareVersion', sortable: true },
                { header: 'Protocol', key: 'protocol', sortable: true },
                { header: 'Score', key: 'vulnerabilityScore', sortable: true, render: (score) => (
                    <span className={`font-semibold ${score >= 70 ? 'text-red-600' : score >= 40 ? 'text-yellow-600' : 'text-green-600'}`}>
                        {score || 'N/A'}
                    </span>
                ) },
                { header: 'Status', key: 'status', sortable: true, render: (val) => (
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        val === 'Active' ? 'bg-green-100 text-green-800' : val === 'Inactive' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                    }`}>
                        {val}
                    </span>
                ) },
            ];

            const handleCreate = () => {
                setEditData({ vulnerabilityScore: 50, status: 'Active', firmwareVersion: '', protocol: '' });
                setIsModalOpen(true);
            };

            const handleEdit = (asset) => {
                setEditData(asset);
                setIsModalOpen(true);
            };

            const handleClose = () => {
                setIsModalOpen(false);
                setEditData(null);
            };

            return (
                <>
                    <TableView
                        title="OT Asset Inventory"
                        icon={<Cpu className="w-6 h-6 mr-2 text-indigo-600" />}
                        data={assets}
                        columns={columns}
                        dataPath={ASSETS_PATH}
                        db={db}
                        userId={userId}
                        role={role}
                        onCreate={handleCreate}
                        onEdit={handleEdit}
                    />
                    <Modal title={editData && editData.id ? "Edit Asset" : "Create New Asset"} isOpen={isModalOpen} onClose={handleClose}>
                        <DataForm 
                            db={db} 
                            userId={userId}
                            role={role}
                            dataPath={ASSETS_PATH} 
                            initialData={editData} 
                            isEdit={!!editData?.id}
                            onClose={handleClose}
                        />
                    </Modal>
                </>
            );
        };

        const SecurityControlsView = ({ controls, dataPath, db, userId, role }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editData, setEditData] = useState(null);

            const columns = [
                { header: 'ID', key: 'id', sortable: true },
                { header: 'Control Name', key: 'name', sortable: true },
                { header: 'Category', key: 'category', sortable: true },
                { header: 'Risk Reduction (%)', key: 'riskReduction', sortable: true, render: (val) => <span className="text-teal-600 font-semibold">{val}%</span> },
                { header: 'Status', key: 'status', sortable: true, render: (val) => (
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        val === 'Implemented' ? 'bg-green-100 text-green-800' : val === 'Planned' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                    }`}>
                        {val}
                    </span>
                ) },
                { header: 'Compliance', key: 'compliance', sortable: false, render: (val) => (val || []).join(', ') },
            ];

            const handleCreate = () => {
                setEditData({ status: 'Planned', riskReduction: 0, compliance: [] });
                setIsModalOpen(true);
            };

            const handleEdit = (control) => {
                setEditData(control);
                setIsModalOpen(true);
            };

            const handleClose = () => {
                setIsModalOpen(false);
                setEditData(null);
            };

            return (
                <>
                    <TableView
                        title="Security Controls Inventory"
                        icon={<CheckCircle className="w-6 h-6 mr-2 text-indigo-600" />}
                        data={controls}
                        columns={columns}
                        dataPath={CONTROLS_PATH}
                        db={db}
                        userId={userId}
                        role={role}
                        onCreate={handleCreate}
                        onEdit={handleEdit}
                    />
                    <Modal title={editData && editData.id ? "Edit Control" : "Create New Control"} isOpen={isModalOpen} onClose={handleClose}>
                        <DataForm 
                            db={db} 
                            userId={userId}
                            role={role}
                            dataPath={CONTROLS_PATH} 
                            initialData={editData} 
                            isEdit={!!editData?.id}
                            onClose={handleClose}
                        />
                    </Modal>
                </>
            );
        };

        const RemediationTasksView = ({ tasks, dataPath, db, userId, role, assets }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editData, setEditData] = useState(null);

            const columns = [
                { header: 'ID', key: 'id', sortable: true },
                { header: 'Task Name', key: 'name', sortable: true },
                { header: 'Asset ID', key: 'assetId', sortable: true, render: (val) => val && val !== 'None' ? <span className="font-mono text-blue-600">{val}</span> : 'N/A' },
                { header: 'Priority', key: 'priority', sortable: true, render: (val) => (
                    <span className={`font-semibold ${val === 'High' ? 'text-red-600' : val === 'Medium' ? 'text-yellow-600' : 'text-green-600'}`}>{val}</span>
                ) },
                { header: 'Assigned To', key: 'assignedTo', sortable: true },
                { header: 'Due Date', key: 'due', sortable: true },
                { header: 'Status', key: 'status', sortable: true, render: (val) => (
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        val === 'Closed' ? 'bg-green-100 text-green-800' : val === 'In Progress' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'
                    }`}>
                        {val}
                    </span>
                ) },
            ];

            const handleCreate = () => {
                setEditData({ priority: 'Medium', status: 'Open', assetId: 'None', assignedTo: 'Engineer' });
                setIsModalOpen(true);
            };

            const handleEdit = (task) => {
                setEditData(task);
                setIsModalOpen(true);
            };

            const handleClose = () => {
                setIsModalOpen(false);
                setEditData(null);
            };

            return (
                <>
                    <TableView
                        title="Remediation Tasks"
                        icon={<HardHat className="w-6 h-6 mr-2 text-indigo-600" />}
                        data={tasks}
                        columns={columns}
                        dataPath={TASKS_PATH}
                        db={db}
                        userId={userId}
                        role={role}
                        onCreate={handleCreate}
                        onEdit={handleEdit}
                    />
                    <Modal title={editData && editData.id ? "Edit Task" : "Create New Task"} isOpen={isModalOpen} onClose={handleClose}>
                        <DataForm 
                            db={db} 
                            userId={userId}
                            role={role}
                            dataPath={TASKS_PATH} 
                            initialData={editData} 
                            isEdit={!!editData?.id}
                            assetsList={assets} // Pass assets to link tasks
                            onClose={handleClose}
                        />
                    </Modal>
                </>
            );
        };
        
        const AdminView = ({ db, userId, role, setRoleOverride }) => {
            const isAuthorized = checkAdminAccess(role);

            const handleSetRole = async (targetUserId, newRole) => {
                if (!isAuthorized || !db) return;
                
                try {
                    const roleDocRef = doc(db, USER_ROLES_PATH, targetUserId);
                    await setDoc(roleDocRef, { role: newRole, lastUpdated: serverTimestamp() }, { merge: true });
                    console.log(`Set role for ${targetUserId} to ${newRole}`);
                    // Update current user's role immediately if they change their own
                    if (targetUserId === userId) {
                        setRoleOverride({ id: userId, role: newRole });
                    }
                } catch (error) {
                    console.error("Error setting user role:", error);
                }
            };
            
            // Display list including current user and demo users
            const usersForDisplay = useMemo(() => {
                // Start with the explicit demo UIDs
                const testUserEntries = Object.entries(TEST_UIDS).map(([roleName, uid]) => ({
                    id: uid,
                    role: roleName,
                    isTestUser: true,
                }));
                
                // Add current user if not already in the list
                const currentUser = { id: userId, role: role, isCurrentUser: true };
                
                let displayList = [...testUserEntries];
                if (!displayList.some(u => u.id === userId)) {
                    displayList.push(currentUser);
                }
                
                // Map to display properties and filter duplicates
                return displayList.map(u => ({
                    ...u,
                    displayRole: u.role.charAt(0).toUpperCase() + u.role.slice(1),
                })).filter((v, i, a) => a.findIndex(t => (t.id === v.id)) === i);
                
            }, [userId, role]);


            if (!isAuthorized) {
                return (
                    <div className="p-6 bg-red-50 rounded-xl shadow-lg text-center">
                        <AlertTriangle className="w-8 h-8 mx-auto text-red-600 mb-2" />
                        <h1 className="text-3xl font-extrabold text-red-700">Access Denied</h1>
                        <p className="text-red-500 mt-2">You must be an Admin to view this page.</p>
                    </div>
                );
            }

            return (
                <div className="p-6 bg-white rounded-xl shadow-lg">
                    <h1 className="text-3xl font-extrabold text-gray-900 flex items-center mb-6 border-b pb-3">
                        <Settings className="w-8 h-8 mr-3 text-indigo-600" />
                        User Role Management (Admin)
                    </h1>
                    
                    <p className="mb-4 text-gray-600">
                        The following UIDs correspond to the demo accounts and the current user. Use the buttons to assign persistent roles in the shared Firebase database.
                    </p>
                    
                    <div className="overflow-x-auto rounded-lg border border-gray-200">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Role</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {usersForDisplay.map((u) => (
                                    <tr key={u.id} className="hover:bg-indigo-50 transition-colors">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900 break-all">
                                            {u.id} {u.id === userId && <span className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full font-bold ml-2"> (You) </span>}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            <span className={`font-semibold ${u.role === 'admin' ? 'text-red-600' : u.role === 'engineer' ? 'text-teal-600' : 'text-gray-600'}`}>
                                                {u.displayRole}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                            <button
                                                onClick={() => handleSetRole(u.id, 'admin')}
                                                className="text-xs px-3 py-1 bg-red-100 text-red-700 rounded-full hover:bg-red-200 transition-colors disabled:opacity-50"
                                                disabled={u.role === 'admin'}
                                            >
                                                Set Admin
                                            </button>
                                            <button
                                                onClick={() => handleSetRole(u.id, 'engineer')}
                                                className="text-xs px-3 py-1 bg-teal-100 text-teal-700 rounded-full hover:bg-teal-200 transition-colors disabled:opacity-50"
                                                disabled={u.role === 'engineer'}
                                            >
                                                Set Engineer
                                            </button>
                                            <button
                                                onClick={() => handleSetRole(u.id, 'guest')}
                                                className="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50"
                                                disabled={u.role === 'guest'}
                                            >
                                                Set Guest
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };


        // --- MAIN APP COMPONENT ---
        const App = () => {
            const { db, userId, user, userRole, isAuthReady, logout } = useAuth();
            const [currentView, setCurrentView] = useState('riskDashboard');
            const [assets, setAssets] = useState([]);
            const [controls, setControls] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [riskLog, setRiskLog] = useState([]);
            const [deploymentStatus, setDeploymentStatus] = useState(null);
            const [roleOverride, setRoleOverride] = useState(null); 
            
            const effectiveUserId = user?.uid || userId;
            const effectiveUserRole = roleOverride ? roleOverride.role : userRole;
            
            const checkAdminAccessApp = useCallback(() => effectiveUserRole === 'admin', [effectiveUserRole]);


            // Effect to set up Firestore listeners
            useEffect(() => {
                if (!db || !isAuthReady || !effectiveUserId) return;
                
                const setupListener = (path, setter, initialData) => {
                    // Use initial data as a fallback if the collection is empty, but listen for real-time changes
                    const q = query(collection(db, path));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // If no documents exist, seed with initial data (only runs once on first load)
                        if (data.length === 0 && initialData.length > 0) {
                            console.log(`Seeding initial data for ${path}`);
                            initialData.forEach(item => {
                                setDoc(doc(db, path, item.id), item).catch(e => console.error(`Failed to seed ${item.id}`, e));
                            });
                        }
                        setter(data);
                    }, (error) => {
                        console.error(`Error fetching data from ${path}:`, error);
                        setter(initialData);
                    });
                    return unsubscribe;
                };

                const unsubAssets = setupListener(ASSETS_PATH, setAssets, initialAssets);
                const unsubControls = setupListener(CONTROLS_PATH, setControls, initialControls);
                const unsubTasks = setupListener(TASKS_PATH, setTasks, initialTasks);
                const unsubRiskLog = setupListener(RISK_LOG_PATH, setRiskLog, initialRiskLog);
                
                // Deployment status (single document)
                const deploymentDocRef = doc(db, DEPLOYMENT_PATH, 'current');
                const unsubDeployment = onSnapshot(deploymentDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setDeploymentStatus(docSnap.data());
                    } else {
                        // Set initial deployment status if it doesn't exist
                        setDeploymentStatus({ status: 'Offline', lastCheck: { seconds: Date.now() / 1000 } });
                        setDoc(deploymentDocRef, { status: 'Offline', lastCheck: serverTimestamp() }, { merge: true }).catch(e => console.error("Error setting initial deployment status:", e));
                    }
                }, (error) => {
                    console.error("Error fetching deployment status:", error);
                });

                return () => {
                    unsubAssets();
                    unsubControls();
                    unsubTasks();
                    unsubRiskLog();
                    unsubDeployment();
                };
            }, [db, isAuthReady, effectiveUserId]);

            
            // Render current view based on state
            const renderView = () => {
                const viewProps = { db, userId: effectiveUserId, role: effectiveUserRole };
                switch (currentView) {
                    case 'riskDashboard':
                        return <RiskDashboardView riskLog={riskLog} assets={assets} tasks={tasks} />;
                    case 'assetBuilder':
                        return <AssetBuilderView assets={assets} dataPath={ASSETS_PATH} {...viewProps} />;
                    case 'securityControls':
                        return <SecurityControlsView controls={controls} dataPath={CONTROLS_PATH} {...viewProps} />;
                    case 'remediationTasks':
                        return <RemediationTasksView tasks={tasks} assets={assets} dataPath={TASKS_PATH} {...viewProps} />;
                    case 'admin':
                        return <AdminView db={db} userId={effectiveUserId} role={effectiveUserRole} setRoleOverride={setRoleOverride} />;
                    default:
                        return <RiskDashboardView riskLog={riskLog} assets={assets} tasks={tasks} />;
                }
            };
            
            // Helper to determine role text and color
            const getRoleDisplay = () => {
                switch (effectiveUserRole) {
                    case 'admin':
                        return <span className="text-red-600 font-bold flex items-center"><User className="w-4 h-4 mr-1"/> Admin</span>;
                    case 'engineer':
                        return <span className="text-teal-600 font-bold flex items-center"><HardHat className="w-4 h-4 mr-1"/> Engineer</span>;
                    default:
                        return <span className="text-gray-600 font-bold flex items-center"><User className="w-4 h-4 mr-1"/> Guest</span>;
                }
            };
            
            if (!isAuthReady) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gray-100">
                        <div className="text-xl font-semibold text-gray-700 p-8 bg-white rounded-xl shadow-lg">
                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading Application and Authentication...
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <header className="bg-white shadow-md rounded-b-xl px-4 py-3 flex justify-between items-center sticky top-0 z-20">
                            <div className="flex items-center">
                                <Shield className="w-8 h-8 text-indigo-600 mr-3" />
                                <h1 className="text-2xl font-bold text-gray-800">OT Guardian</h1>
                            </div>
                            
                            <div className="flex items-center space-x-4">
                                <div className="text-sm text-gray-600 hidden sm:block">
                                    <span className="font-medium">UID:</span> 
                                    <span className="font-mono text-gray-800 ml-1 break-all">{effectiveUserId}</span>
                                </div>
                                {getRoleDisplay()}
                                
                                <button 
                                    onClick={logout} 
                                    title="Logout"
                                    className="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors"
                                >
                                    <LogOut className='w-5 h-5' />
                                </button>
                            </div>
                        </header>

                        {/* Navigation Bar */}
                        <nav className="flex space-x-1 p-3 border-b bg-white overflow-x-auto whitespace-nowrap sticky top-[72px] z-10 rounded-xl shadow-md mt-4 no-print">
                            {[
                                { view: 'riskDashboard', label: 'Risk Dashboard', icon: <Shield className="w-4 h-4 mr-2" /> },
                                { view: 'assetBuilder', label: 'Asset Builder', icon: <Cpu className="w-4 h-4 mr-2" /> },
                                { view: 'securityControls', label: 'Controls', icon: <CheckCircle className="w-4 h-4 mr-2" /> },
                                { view: 'remediationTasks', label: 'Remediation', icon: <HardHat className="w-4 h-4 mr-2" /> },
                                ...(checkAdminAccessApp() ? [{ view: 'admin', label: 'Admin', icon: <User className="w-4 h-4 mr-2" /> }] : [] ),
                            ].map(item => (
                                <button
                                    key={item.view}
                                    onClick={() => setCurrentView(item.view)}
                                    className={`flex items-center px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-150 ${
                                        currentView === item.view ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-700 hover:bg-indigo-100'
                                    }`}
                                >
                                    {item.icon}
                                    {item.label}
                                </button>
                            ))}
                        </nav>

                        {/* Deployment Status Bar */}
                        <div className={`p-3 text-sm font-semibold rounded-xl text-center shadow-md mt-4 status-bar ${
                            deploymentStatus?.status === 'Online' ? 'bg-green-100 text-green-800' : 
                            deploymentStatus?.status === 'Warning' ? 'bg-yellow-100 text-yellow-800' : 
                            'bg-red-100 text-red-800'
                        }`}>
                            <Zap className="w-4 h-4 inline mr-1" />
                            Deployment Status: {deploymentStatus?.status || 'Loading...'} | 
                            Last Check: {deploymentStatus?.lastCheck?.seconds ? new Date(deploymentStatus.lastCheck.seconds * 1000).toLocaleString() : 'N/A'}
                        </div>

                        {/* Main Content Area */}
                        <main className="p-6 main-content">
                            {renderView()}
                        </main>
                    </div>
                </div>
            );
        };

        // Standard React 18 rendering code
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>