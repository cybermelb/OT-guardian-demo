<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian Security Posture Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Vanilla JS compatible) -->
    <script src="https://unpkg.com/lucide@latest"></script>
   
    <style>
        @media print {
            .print-hide { display: none !important; }
            .print-full { max-width: none !important; margin: 0 !important; padding: 0 !important; }
            body, .bg-gray-100 { background-color: white !important; }
            .table-responsive td, .table-responsive th { white-space: normal !important; }
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="module">
        // --- FIREBASE IMPORTS (ES Modules) ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, setDoc, updateDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- GLOBAL STATE & CONFIGURATION ---
        let app, db, auth;
        let state = {
            userId: null,
            isAuthReady: false,
            firebaseError: null,
            userRole: 'admin', // Default role
            assets: [],
            tasks: [],
            currentView: 'riskDashboard',
            isModalOpen: false,
        };

        // Get config from global scope (provided by Canvas environment)
        let firebaseConfig = {};
        let appId = 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
       
        try {
            const fConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const aId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
           
            if (fConfig && fConfig.apiKey) {
                firebaseConfig = fConfig;
                appId = aId;
            } else {
                console.error("Firebase config is missing or invalid.");
            }
        } catch (e) {
            console.error("Failed to parse Firebase configuration:", e);
        }

        const PUBLIC_DATA_PATH = `/artifacts/${appId}/public/data`;
        const CONTROL_STATUSES = ['Not Assessed', 'Implemented', 'Partially Implemented', 'Not Implemented', 'Not Applicable'];
        const PURDUE_ZONES = ['Level 0: Process', 'Level 1: Basic Control', 'Level 2: Supervisory', 'Level 3: Operations', 'Level 4: Enterprise'];
        const MOCK_USERS = [
            { id: 'admin-temp-id', email: 'admin@otg.com', role: 'admin', uid: 'admin-UID-123456' },
            { id: 'manager-temp-id', email: 'manager@otg.com', role: 'manager', uid: 'manager-UID-123456' },
            { id: 'engineer-temp-id', email: 'engineer@otg.com', role: 'engineer', uid: 'engineer-UID-123456' },
        ];
       
        // --- UTILITY FUNCTIONS ---

        const notify = (message, type = 'info') => {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // In a real app, this would show a floating toast/modal instead of alert()
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.innerHTML = message;
                messageBox.className = `p-3 rounded-xl mb-4 text-sm font-semibold ${
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'success' ? 'bg-green-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                messageBox.style.display = 'block';
                setTimeout(() => messageBox.style.display = 'none', 3000);
            }
        };

        const hasAccess = (requiredRoles) => requiredRoles.includes(state.userRole);

        // Simple state update and re-render function
        const updateState = (newState) => {
            state = { ...state, ...newState };
            renderApp();
        };

        // --- DATA FACTORIES & HELPERS ---

        const createInitialIEC62443 = () => ([
            { fr: 'FR1', name: 'Identification & Authentication Control (IAC)', targetSL: 3, controls: [
                { cid: 'IAC1', requirement: 'Unique User IDs', status: 'Not Assessed', notes: '' },
                { cid: 'IAC2', requirement: 'Password Complexity', status: 'Not Assessed', notes: '' },
                { cid: 'IAC3', requirement: 'Multi-Factor Auth', status: 'Not Assessed', notes: '' },
            ]},
            { fr: 'FR2', name: 'Use Control (UC)', targetSL: 2, controls: [
                { cid: 'UC1', requirement: 'Role-Based Access', status: 'Not Assessed', notes: '' },
                { cid: 'UC2', requirement: 'Principle of Least Privilege', status: 'Not Assessed', notes: '' },
            ]},
            { fr: 'FR3', name: 'System Integrity (SI)', targetSL: 4, controls: [
                { cid: 'SI1', requirement: 'Anti-Malware', status: 'Not Assessed', notes: '' },
                { cid: 'SI2', requirement: 'Patch Management', status: 'Not Assessed', notes: '' },
            ]},
        ]);
       
        const createInitialFlatControls = (frameworkName) => {
            const controlsMap = {
                sans: [
                    { id: 'sans_inventory_devices', name: 'Inventory of Authorized Devices', description: 'Maintain a detailed inventory of all assets.', status: 'Not Assessed', notes: '' },
                    { id: 'sans_vulnerability', name: 'Vulnerability Management', description: 'Implement a continuous vulnerability discovery and remediation process.', status: 'Not Assessed', notes: '' },
                ],
                ciFortify: [
                    { id: 'ci_1_inventory', name: 'Inventory and Control of Hardware Assets', description: 'Actively manage all hardware devices on the network.', status: 'Not Assessed', notes: '' },
                    { id: 'ci_3_mfa', name: 'Multi-Factor Authentication', description: 'Implement MFA for all remote and privileged access.', status: 'Not Assessed', notes: '' },
                ]
            };
            return controlsMap[frameworkName] || [];
        };

        const createNewAsset = (formData, creatorId) => ({
            name: formData.name,
            type: formData.type,
            zone: formData.zone,
            impact: formData.impact,
            createdBy: creatorId,
            riskScore: 50,
            iec62443: createInitialIEC62443(),
            sans: createInitialFlatControls('sans'),
            ciFortify: createInitialFlatControls('ciFortify'),
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
        });

        // --- DATA OPERATIONS ---

        const addAsset = async (formData) => {
            const newAsset = createNewAsset(formData, state.userId);
            try {
                const assetRef = doc(collection(db, `${PUBLIC_DATA_PATH}/assets`));
                await setDoc(assetRef, newAsset);
                notify("Asset added successfully!", 'success');
            } catch (e) {
                notify(`Error adding asset: ${e.message}`, 'error');
            }
        };
       
        const updateAssetControl = async (assetId, framework, controlPath, newStatus) => {
            const assetRef = doc(db, `${PUBLIC_DATA_PATH}/assets`, assetId);
            const assetToUpdate = state.assets.find(a => a.id === assetId);

            if (!assetToUpdate) {
                notify("Asset not found for update.", 'error');
                return;
            }

            try {
                const updatedAsset = JSON.parse(JSON.stringify(assetToUpdate)); // Deep clone
                let updateData = {};

                if (framework === 'iec62443') {
                    const [frIndex, controlIndex] = controlPath;
                    updatedAsset.iec62443[frIndex].controls[controlIndex].status = newStatus;
                    updateData = { iec62443: updatedAsset.iec62443, updatedAt: serverTimestamp() };
                } else {
                    const controlIndex = controlPath;
                    updatedAsset[framework][controlIndex].status = newStatus;
                    updateData = { [framework]: updatedAsset[framework], updatedAt: serverTimestamp() };
                }
                await updateDoc(assetRef, updateData);
                notify("Control status updated.", 'success');
            } catch (e) {
                notify(`Error updating control status: ${e.message}`, 'error');
            }
        };

        const addTask = async (assetName, description, priority = 'Medium') => {
            try {
                const taskRef = collection(db, `${PUBLIC_DATA_PATH}/remediationTasks`);
                await setDoc(doc(taskRef), {
                    assetName,
                    description,
                    priority,
                    status: 'Open',
                    createdBy: state.userId,
                    createdAt: serverTimestamp(),
                });
                notify("Remediation Task added.", 'success');
            } catch (e) {
                notify(`Error adding task: ${e.message}`, 'error');
            }
        };

        const updateTaskStatus = async (taskId, newStatus) => {
            try {
                const taskRef = doc(db, `${PUBLIC_DATA_PATH}/remediationTasks`, taskId);
                await updateDoc(taskRef, { status: newStatus, updatedAt: serverTimestamp() });
                notify(`Task status updated to ${newStatus}.`, 'success');
            } catch (e) {
                notify(`Error updating task status: ${e.message}`, 'error');
            }
        };

        // --- FIREBASE INITIALIZATION & DATA LISTENERS ---

        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                updateState({ firebaseError: "Firebase configuration is missing.", isAuthReady: true });
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, (user) => {
                    updateState({ userId: user ? user.uid : null });
                });
               
                // Sign in logic
                const attemptSignIn = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        notify("Sign-in failed.", 'error');
                    } finally {
                        // CRITICAL: Dismiss loading state
                        updateState({ isAuthReady: true });
                    }
                };

                if (!auth.currentUser) {
                    await attemptSignIn();
                } else {
                    updateState({ isAuthReady: true });
                }

                // Data Listeners
                onSnapshot(query(collection(db, `${PUBLIC_DATA_PATH}/assets`)), (snapshot) => {
                    const fetchedAssets = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        iec62443: doc.data().iec62443 || createInitialIEC62443(),
                        sans: doc.data().sans || createInitialFlatControls('sans'),
                        ciFortify: doc.data().ciFortify || createInitialFlatControls('ciFortify'),
                    })).filter(doc => !doc.deleted);
                    updateState({ assets: fetchedAssets });
                }, (error) => notify(`Error fetching assets: ${error.message}`, 'error'));
               
                onSnapshot(query(collection(db, `${PUBLIC_DATA_PATH}/remediationTasks`)), (snapshot) => {
                    const fetchedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(doc => !doc.deleted);
                    updateState({ tasks: fetchedTasks });
                }, (error) => notify(`Error fetching tasks: ${error.message}`, 'error'));

            } catch (error) {
                updateState({ firebaseError: `Initialization failed: ${error.message}`, isAuthReady: true });
            }
        };

        // --- DOM RENDERER FUNCTIONS ---

        // Helper to convert object to HTML string
        const createHTML = (tag, attrs = {}, children = []) => {
            const attrStr = Object.entries(attrs).map(([key, value]) => {
                if (key.startsWith('on') && typeof value === 'function') {
                    // This is a simplified event handler placement (needs refinement for complex scenarios)
                    // For simplicity in this demo, events are often attached manually after rendering.
                    return '';
                }
                return `${key}="${value}"`;
            }).join(' ');
           
            const content = Array.isArray(children) ? children.join('') : children;
            return `<${tag} ${attrStr}>${content}</${tag}>`;
        };

        // --- UI COMPONENTS ---

        const renderIcon = (name, classes = 'w-5 h-5') => `<i class="lucide ${name} ${classes}"></i>`;

        const ProgressRing = (percentage, color = '#4F46E5', radius = 60, stroke = 10) => {
            const normalizedRadius = radius - stroke * 2;
            const circumference = normalizedRadius * 2 * Math.PI;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;

            return `
                <svg height="${radius * 2}" width="${radius * 2}" class="mx-auto">
                    <circle stroke="#E0E7FF" fill="transparent" stroke-width="${stroke}" r="${normalizedRadius}" cx="${radius}" cy="${radius}" />
                    <circle stroke="${color}" fill="transparent" stroke-width="${stroke}" stroke-dasharray="${circumference} ${circumference}" style="stroke-dashoffset: ${strokeDashoffset}" r="${normalizedRadius}" cx="${radius}" cy="${radius}" class="progress-ring__circle" />
                    <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="1.2em" font-weight="bold" fill="${color}">
                        ${Math.round(percentage)}%
                    </text>
                </svg>
            `;
        };

        const StatCard = (iconName, title, value, color) => createHTML('div', {
            class: `p-5 rounded-xl shadow-lg flex flex-col justify-between transition-all duration-300 transform hover:scale-[1.01] bg-white border-l-4`,
            style: `border-color: ${color}`
        }, [
            createHTML('div', { class: 'flex items-center space-x-4' }, [
                createHTML('div', { class: 'p-3 rounded-full', style: `background-color: ${color}1A` }, [
                    renderIcon(iconName, `w-6 h-6 text-[${color}]`)
                ]),
                createHTML('div', {}, [
                    createHTML('p', { class: 'text-sm font-medium text-gray-500' }, title),
                    createHTML('p', { class: 'text-3xl font-bold text-gray-900' }, value),
                ]),
            ]),
        ]);

        // --- VIEWS ---

        const RiskDashboard = () => {
            const totalControls = state.assets.reduce((sum, asset) =>
                sum + (asset.iec62443?.reduce((cSum, fr) => cSum + (fr.controls?.length || 0), 0) || 0)
            , 0);

            const implementedControls = state.assets.reduce((sum, asset) =>
                sum + (asset.iec62443?.reduce((cSum, fr) =>
                    cSum + (fr.controls?.filter(c => c.status === 'Implemented').length || 0), 0) || 0)
            , 0);

            const overallCompliance = totalControls > 0 ? (implementedControls / totalControls) * 100 : 0;
            const openTasks = state.tasks.filter(t => t.status !== 'Complete').length;
            const highRiskAssets = state.assets.filter(a => a.riskScore > 60).length;

            const content = [
                createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'OT Security Risk Dashboard'),
                createHTML('div', { class: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mt-6' }, [
                    StatCard('cpu', 'Total Assets', state.assets.length, '#3B82F6'),
                    StatCard('alert-triangle', 'High Risk Assets', highRiskAssets, '#DC2626'),
                    StatCard('hard-hat', 'Open Remediation Tasks', openTasks, '#F59E0B'),
                    StatCard('target', 'Target SL Achieved (Mock)', Math.floor(Math.random() * 5), '#10B981'),
                ]),
                createHTML('div', { class: 'grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6' }, [
                    // Compliance Status Ring
                    createHTML('div', { class: 'bg-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center' }, [
                        createHTML('h2', { class: 'text-xl font-semibold text-indigo-700 mb-4' }, 'Overall IEC 62443 Compliance'),
                        ProgressRing(overallCompliance),
                        createHTML('p', { class: 'mt-4 text-center text-sm text-gray-600' }, `${implementedControls} / ${totalControls} Controls Implemented`),
                    ]),
                    // Risk Heatmap
                    createHTML('div', { class: 'lg:col-span-2 bg-white p-6 rounded-xl shadow-lg' }, [
                        createHTML('h2', { class: 'text-xl font-semibold text-indigo-700 mb-4' }, 'Risk Heatmap: Assets by Purdue Zone'),
                        createHTML('p', { class: 'text-sm text-gray-500 mb-4' }, 'This visualization maps asset risk against the physical/logical network segmentation of the Purdue Model.'),
                        '',
                        createHTML('div', { class: 'grid grid-cols-2 sm:grid-cols-5 gap-4 mt-6' }, PURDUE_ZONES.map((zone, index) => {
                            const count = state.assets.filter(a => a.zone === zone).length;
                            const riskLevel = count > 3 ? 'bg-red-500' : count > 0 ? 'bg-yellow-500' : 'bg-green-500';
                            return createHTML('div', { class: `${riskLevel} text-white p-3 rounded-lg text-center font-bold shadow-md` }, [
                                createHTML('div', { class: 'text-xs font-light opacity-80' }, zone.split(': ')[0]),
                                createHTML('div', { class: 'text-2xl' }, count),
                            ]);
                        })),
                    ]),
                ]),
            ];

            return createHTML('div', { class: 'space-y-8' }, content);
        };
       
        const ManagerDashboard = () => {
            const riskScore = (10 - (overallCompliance() / 10)).toFixed(1);

            const frCompliance = (() => {
                const frMap = {};
                state.assets.forEach(asset => {
                    asset.iec62443?.forEach(fr => {
                        if (!frMap[fr.fr]) { frMap[fr.fr] = { total: 0, implemented: 0, name: fr.name }; }
                        frMap[fr.fr].total += fr.controls.length;
                        frMap[fr.fr].implemented += fr.controls.filter(c => c.status === 'Implemented').length;
                    });
                });
                return Object.entries(frMap).map(([fr, data]) => ({
                    fr,
                    name: data.name,
                    percentage: data.total > 0 ? (data.implemented / data.total) * 100 : 0,
                }));
            })();

            const overallCompliance = () => {
                 const totalControls = state.assets.reduce((sum, asset) =>
                    sum + (asset.iec62443?.reduce((cSum, fr) => cSum + (fr.controls?.length || 0), 0) || 0)
                , 0);

                const implementedControls = state.assets.reduce((sum, asset) =>
                    sum + (asset.iec62443?.reduce((cSum, fr) =>
                        cSum + (fr.controls?.filter(c => c.status === 'Implemented').length || 0), 0) || 0)
                , 0);
                return totalControls > 0 ? (implementedControls / totalControls) * 100 : 0;
            };

            const frBars = frCompliance.map(({ fr, name, percentage }) => {
                const color = percentage > 75 ? '#10B981' : percentage > 40 ? '#F59E0B' : '#DC2626';
                return createHTML('div', { key: fr }, [
                    createHTML('div', { class: 'flex justify-between text-sm font-medium text-gray-700 mb-1' }, [
                        createHTML('span', {}, `${fr}: ${name}`),
                        createHTML('span', { class: 'font-bold' }, `${percentage.toFixed(0)}%`),
                    ]),
                    createHTML('div', { class: 'w-full bg-gray-200 rounded-full h-2.5' }, [
                        createHTML('div', {
                            class: 'h-2.5 rounded-full',
                            style: `width: ${percentage}%; background-color: ${color}`
                        }),
                    ]),
                ]);
            });

            const content = [
                createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'Executive Posture Overview'),
                createHTML('div', { class: 'grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6' }, [
                    StatCard('bar-chart-2', 'Mock Risk Score', `${riskScore} / 10`, '#9333EA'),
                    StatCard('shield', 'Overall Compliance', `${overallCompliance().toFixed(1)}%`, '#10B981'),
                    StatCard('target', 'Target SL (Mocked)', 'SL 3 / SL 4', '#F97316'),
                ]),
                createHTML('div', { class: 'bg-white p-6 rounded-xl shadow-lg mt-6' }, [
                    createHTML('h2', { class: 'text-2xl font-semibold text-indigo-700 mb-4' }, 'IEC 62443 Foundational Requirement (FR) Coverage'),
                    createHTML('p', { class: 'text-sm text-gray-500 mb-4' }, 'Progress for key Foundational Requirements based on asset-level control implementation.'),
                    '',
                    createHTML('div', { class: 'space-y-4' }, frBars),
                ]),
            ];
            return createHTML('div', { class: 'space-y-8' }, content);
        };

        const AssetBuilder = () => {
            const AssetModal = () => {
                const formId = 'asset-builder-form';
                const modalHtml = createHTML('div', { id: 'asset-modal', class: 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 print-hide' }, [
                    createHTML('div', { class: 'bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-full overflow-y-auto' }, [
                        createHTML('div', { class: 'flex justify-between items-center p-4 border-b' }, [
                            createHTML('h3', { class: 'text-xl font-bold text-gray-800' }, 'Add New OT Asset'),
                            createHTML('button', { id: 'close-modal-btn', class: 'text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100' }, renderIcon('x', 'w-6 h-6')),
                        ]),
                        createHTML('form', { id: formId, class: 'p-6 space-y-4' }, [
                            createHTML('div', {}, [
                                createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, 'Name'),
                                createHTML('input', { type: 'text', name: 'name', required: true, class: 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm' }),
                            ]),
                            createHTML('div', {}, [
                                createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, 'Type'),
                                createHTML('select', { name: 'type', class: 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm' },
                                    ['PLC', 'HMI', 'Server', 'Historian', 'Workstation'].map(t => createHTML('option', { value: t }, t))
                                ),
                            ]),
                            createHTML('div', {}, [
                                createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, 'Zone'),
                                createHTML('select', { name: 'zone', class: 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm' },
                                    PURDUE_ZONES.map(z => createHTML('option', { value: z }, z))
                                ),
                            ]),
                            createHTML('div', {}, [
                                createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, 'Impact'),
                                createHTML('select', { name: 'impact', class: 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm' },
                                    ['High', 'Medium', 'Low'].map(i => createHTML('option', { value: i }, i))
                                ),
                            ]),
                            createHTML('div', { class: 'flex justify-end pt-4' }, [
                                createHTML('button', { type: 'submit', class: 'flex items-center bg-indigo-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-indigo-700' }, [
                                    renderIcon('save', 'w-5 h-5 mr-2'), ' Add Asset'
                                ]),
                            ]),
                        ]),
                    ]),
                ]);

                // Render Modal and attach handlers
                const root = document.getElementById('root');
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                root.appendChild(modalContainer);

                const closeModal = () => {
                    updateState({ isModalOpen: false });
                    modalContainer.remove();
                };

                document.getElementById('close-modal-btn').onclick = closeModal;
                document.getElementById(formId).onsubmit = async (e) => {
                    e.preventDefault();
                    const formData = {
                        name: e.target.elements.name.value,
                        type: e.target.elements.type.value,
                        zone: e.target.elements.zone.value,
                        impact: e.target.elements.impact.value,
                    };
                    await addAsset(formData);
                    closeModal();
                };
            };
           
            if (state.isModalOpen) { AssetModal(); }

            const filteredAssets = state.assets.filter(a =>
                a.name.toLowerCase().includes(state.assetFilter?.toLowerCase() || '') ||
                a.zone.toLowerCase().includes(state.assetFilter?.toLowerCase() || '')
            );

            const tableRows = filteredAssets.map(asset => createHTML('tr', { key: asset.id, class: 'hover:bg-indigo-50 transition-colors' }, [
                createHTML('td', { class: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900' }, asset.name || 'N/A'),
                createHTML('td', { class: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500' }, asset.type || 'N/A'),
                createHTML('td', { class: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500' }, asset.zone || 'N/A'),
                createHTML('td', { class: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500' }, asset.impact || 'N/A'),
                createHTML('td', { class: 'px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600' }, asset.riskScore || 'N/A'),
            ]));

            const content = [
                createHTML('div', { class: 'flex flex-col sm:flex-row justify-between items-center border-b pb-4' }, [
                    createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 mb-3 sm:mb-0' }, `Asset Inventory (${state.assets.length})`),
                    createHTML('div', { class: 'flex space-x-3 w-full sm:w-auto' }, [
                        createHTML('input', { id: 'asset-filter', type: 'text', placeholder: 'Filter by Name or Zone...', value: state.assetFilter || '', class: 'px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-64' }),
                        createHTML('button', { id: 'add-asset-btn', class: 'flex items-center bg-indigo-600 text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:bg-indigo-700 transition-colors' }, [
                            renderIcon('plus', 'w-5 h-5 mr-2'), ' Add Asset'
                        ]),
                    ]),
                ]),
                createHTML('div', { class: 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive' }, [
                    createHTML('table', { class: 'min-w-full divide-y divide-gray-200' }, [
                        createHTML('thead', { class: 'bg-gray-50' }, [
                            createHTML('tr', {}, [
                                ['Name', 'Type', 'Purdue Zone', 'Impact', 'Risk Score'].map(h => createHTML('th', { class: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, h))
                            ]),
                        ]),
                        createHTML('tbody', { class: 'bg-white divide-y divide-gray-200' }, tableRows),
                    ]),
                ]),
            ];

            const container = createHTML('div', { class: 'space-y-6' }, content);
           
            // Post-render event listeners
            setTimeout(() => {
                document.getElementById('add-asset-btn').onclick = () => updateState({ isModalOpen: true });
                document.getElementById('asset-filter').oninput = (e) => updateState({ assetFilter: e.target.value });
            }, 0);

            return container;
        };
       
        const SecurityControls = () => {
            // Need selectedAssetId and selectedFramework state management
            if (!state.selectedAssetId && state.assets.length > 0) {
                updateState({ selectedAssetId: state.assets[0].id });
            }
            if (!state.selectedFramework) {
                updateState({ selectedFramework: 'iec62443' });
            }

            const asset = state.assets.find(a => a.id === state.selectedAssetId);
           
            if (!asset) {
                return createHTML('div', { class: 'p-6 text-gray-500 bg-white rounded-xl shadow-lg' }, 'Select an asset to begin assessment.');
            }

            const frameworks = {
                iec62443: { name: 'IEC 62443', data: asset.iec62443 },
                sans: { name: 'SANS Critical Controls', data: asset.sans },
                ciFortify: { name: 'CIS Fortify', data: asset.ciFortify },
            };
            const currentFramework = frameworks[state.selectedFramework];

            const renderControlStatusToggle = (control, frIndex, controlIndex, isIEC) => {
                const isGap = control.status === 'Not Implemented' || control.status === 'Partially Implemented';
                const hasEditAccess = hasAccess(['admin', 'engineer']);
                const statusClasses = (status) => {
                    if (status === 'Implemented') return 'bg-green-50 border-green-300 text-green-800';
                    if (status === 'Not Implemented' || status === 'Partially Implemented') return 'bg-red-50 border-red-300 text-red-800';
                    return 'bg-gray-50 border-gray-300';
                };

                const selectId = `control-status-${asset.id}-${control.cid || control.id}-${frIndex}-${controlIndex}`;
                const taskBtnId = `task-btn-${asset.id}-${control.cid || control.id}-${frIndex}-${controlIndex}`;
               
                // HTML structure for the control interaction area
                const html = createHTML('div', { class: 'flex items-center space-x-3' }, [
                    createHTML('select', {
                        id: selectId,
                        class: `px-3 py-1 text-sm rounded-lg border focus:ring-indigo-500 focus:border-indigo-500 ${statusClasses(control.status)}`,
                        disabled: !hasEditAccess,
                    }, CONTROL_STATUSES.map(s => createHTML('option', { value: s, selected: s === control.status }, s))),
                    isGap && hasEditAccess ? createHTML('button', { id: taskBtnId, class: 'flex items-center text-xs bg-red-600 text-white px-2 py-1 rounded-full hover:bg-red-700 transition-colors' }, [
                        renderIcon('plus', 'w-3 h-3 mr-1'), ' Task'
                    ]) : ''
                ]);

                // Post-render event attachment (must be done after element is added to DOM)
                setTimeout(() => {
                    const selectElement = document.getElementById(selectId);
                    if (selectElement) {
                        selectElement.onchange = (e) => {
                            let controlPath = isIEC ? [frIndex, controlIndex] : controlIndex;
                            updateAssetControl(asset.id, state.selectedFramework, controlPath, e.target.value);
                        };
                    }

                    const taskButton = document.getElementById(taskBtnId);
                    if (taskButton) {
                        taskButton.onclick = () => {
                            const taskDescription = isIEC
                                ? `Remediate gap in ${asset.name} (IEC ${control.cid}: ${control.requirement})`
                                : `Remediate gap in ${asset.name} (${control.id}: ${control.name})`;
                            addTask(asset.name, taskDescription, 'High');
                        };
                    }
                }, 0);
               
                return html;
            };

            const IECControlsDisplay = () => {
                return currentFramework.data.map((fr, frIndex) => createHTML('div', { key: fr.fr, class: 'bg-white p-5 rounded-xl shadow-lg border-l-4 border-indigo-500' }, [
                    createHTML('h3', { class: 'text-xl font-bold text-indigo-700 mb-3' }, `${fr.fr}: ${fr.name} (Target SL: ${fr.targetSL})`),
                    createHTML('div', { class: 'divide-y divide-gray-100' },
                        fr.controls.map((control, controlIndex) => createHTML('div', { key: control.cid, class: 'flex justify-between items-center py-3' }, [
                            createHTML('div', { class: 'w-3/5' }, [
                                createHTML('p', { class: 'font-semibold text-gray-800' }, control.cid),
                                createHTML('p', { class: 'text-sm text-gray-600' }, control.requirement),
                            ]),
                            createHTML('div', { class: 'w-2/5 flex justify-end' }, renderControlStatusToggle(control, frIndex, controlIndex, true)),
                        ]))
                    ),
                ]));
            };

            const FlatControlsDisplay = () => {
                const tableRows = currentFramework.data.map((control, controlIndex) => createHTML('tr', { key: control.id, class: 'hover:bg-gray-50' }, [
                    createHTML('td', { class: 'px-6 py-4 text-sm font-medium text-gray-900' }, control.id),
                    createHTML('td', { class: 'px-6 py-4 text-sm text-gray-500' }, control.description),
                    createHTML('td', { class: 'px-6 py-4 text-right' }, renderControlStatusToggle(control, null, controlIndex, false)),
                ]));

                return createHTML('div', { class: 'bg-white rounded-xl shadow-lg overflow-x-auto' }, [
                    createHTML('table', { class: 'min-w-full divide-y divide-gray-200' }, [
                        createHTML('thead', { class: 'bg-gray-50' }, [
                            createHTML('tr', {}, [
                                ['Control', 'Description', 'Status'].map(h => createHTML('th', { class: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, h))
                            ]),
                        ]),
                        createHTML('tbody', { class: 'bg-white divide-y divide-gray-200' }, tableRows),
                    ]),
                ]);
            };

            const content = [
                createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'Security Control Assessment'),
                createHTML('div', { class: 'grid grid-cols-1 sm:grid-cols-3 gap-4 bg-white p-4 rounded-xl shadow-md print-hide' }, [
                    createHTML('div', {}, [
                        createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, 'Select Asset'),
                        createHTML('select', { id: 'asset-select', class: 'mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm' },
                            state.assets.map(a => createHTML('option', { value: a.id, selected: a.id === state.selectedAssetId }, `${a.name} (${a.zone.split(': ')[0]})`))
                        ),
                    ]),
                    createHTML('div', {}, [
                        createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, 'Select Framework'),
                        createHTML('select', { id: 'framework-select', class: 'mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm' },
                            Object.keys(frameworks).map(key => createHTML('option', { value: key, selected: key === state.selectedFramework }, frameworks[key].name))
                        ),
                    ]),
                ]),
                asset ? createHTML('div', { class: 'mt-6' }, [
                    createHTML('h2', { class: 'text-2xl font-bold text-gray-800 mb-4' }, `${currentFramework.name} Controls for: ${asset.name}`),
                    state.selectedFramework === 'iec62443' ? createHTML('div', { class: 'space-y-6' }, IECControlsDisplay()) : FlatControlsDisplay(),
                ]) : '',
            ];

            const container = createHTML('div', { class: 'space-y-6' }, content);

            // Post-render event listeners
            setTimeout(() => {
                const assetSelect = document.getElementById('asset-select');
                if (assetSelect) { assetSelect.onchange = (e) => updateState({ selectedAssetId: e.target.value }); }

                const frameworkSelect = document.getElementById('framework-select');
                if (frameworkSelect) { frameworkSelect.onchange = (e) => updateState({ selectedFramework: e.target.value }); }
            }, 0);

            return container;
        };
       
        const RemediationTasks = () => {
            const hasEditAccess = hasAccess(['admin', 'engineer']);
           
            const getPriorityClass = (priority) => {
                switch (priority) {
                    case 'Critical': return 'bg-red-500';
                    case 'High': return 'bg-orange-500';
                    case 'Medium': return 'bg-yellow-500';
                    case 'Low': return 'bg-green-500';
                    default: return 'bg-gray-400';
                }
            };
           
            const getStatusClass = (status) => {
                switch (status) {
                    case 'Open': return 'bg-red-100 text-red-800';
                    case 'In Progress': return 'bg-yellow-100 text-yellow-800';
                    case 'Complete': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
           
            const tableRows = state.tasks.map(task => {
                const selectId = `task-status-${task.id}`;
               
                const html = createHTML('tr', { key: task.id, class: 'hover:bg-indigo-50 transition-colors' }, [
                    createHTML('td', { class: 'px-6 py-4 whitespace-nowrap' },
                        createHTML('span', { class: `px-2 py-0.5 text-xs font-semibold rounded-full text-white ${getPriorityClass(task.priority)}` }, task.priority || 'N/A')
                    ),
                    createHTML('td', { class: 'px-6 py-4 text-sm text-gray-900' }, task.description || 'N/A'),
                    createHTML('td', { class: 'px-6 py-4 text-sm text-indigo-600 font-medium' }, task.assetName || 'N/A'),
                    createHTML('td', { class: 'px-6 py-4 whitespace-nowrap' },
                        hasEditAccess ? createHTML('select', { id: selectId, class: `px-3 py-1 text-sm rounded-lg border focus:ring-indigo-500 focus:border-indigo-500 ${getStatusClass(task.status)}` },
                            ['Open', 'In Progress', 'Complete'].map(s => createHTML('option', { value: s, selected: s === task.status }, s))
                        ) : createHTML('span', { class: `px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(task.status)}` }, task.status)
                    ),
                    createHTML('td', { class: 'px-6 py-4 text-sm text-gray-500' }, MOCK_USERS.find(u => u.uid === task.createdBy)?.role || 'N/A'),
                ]);

                if (hasEditAccess) {
                    setTimeout(() => {
                        const selectElement = document.getElementById(selectId);
                        if (selectElement) { selectElement.onchange = (e) => updateTaskStatus(task.id, e.target.value); }
                    }, 0);
                }
                return html;
            });

            const content = [
                createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'Remediation Task Management'),
                createHTML('div', { class: 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive mt-6' }, [
                    createHTML('table', { class: 'min-w-full divide-y divide-gray-200' }, [
                        createHTML('thead', { class: 'bg-gray-50' }, [
                            createHTML('tr', {}, [
                                ['Priority', 'Description', 'Asset Name', 'Status', 'Created By'].map(h => createHTML('th', { class: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, h))
                            ]),
                        ]),
                        createHTML('tbody', { class: 'bg-white divide-y divide-gray-200' }, tableRows),
                    ]),
                ]),
            ];

            return createHTML('div', { class: 'space-y-6' }, content);
        };

        const Reports = () => createHTML('div', { class: 'space-y-6 bg-white p-6 rounded-xl shadow-lg' }, [
            createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'Reporting & Export'),
            createHTML('p', { class: 'text-gray-600' }, 'Generate comprehensive reports on compliance, risk scores, and remediation status. Use the browser\'s print/PDF feature on the main dashboards for a detailed view.'),
            createHTML('div', { class: 'p-4 border border-indigo-200 rounded-xl space-y-4' }, [
                createHTML('div', { class: 'grid grid-cols-1 sm:grid-cols-3 gap-4' }, [
                    ['Report Type', 'Executive Summary'],
                    ['Filter by Zone', 'All Zones'],
                    ['Date Range', 'Q4 2025']
                ].map(([label, mockValue]) => createHTML('div', {}, [
                    createHTML('label', { class: 'block text-sm font-medium text-gray-700' }, label),
                    createHTML('input', { type: 'text', disabled: true, value: mockValue, placeholder: mockValue, class: 'mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm bg-gray-50' })
                ]))),
                createHTML('button', { disabled: true, class: 'flex items-center bg-gray-400 text-white px-4 py-2 rounded-xl font-semibold cursor-not-allowed' }, [
                    renderIcon('download', 'w-5 h-5 mr-2'), ' Generate & Export Report (Disabled)'
                ]),
            ]),
        ]);

        const SettingsPage = () => createHTML('div', { class: 'space-y-6 bg-white p-6 rounded-xl shadow-lg' }, [
            createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'Assessment Settings'),
            createHTML('p', { class: 'text-gray-600' }, 'Define global targets and assessment parameters here. (Admin access only)'),
            createHTML('div', { class: 'grid grid-cols-1 sm:grid-cols-2 gap-4' }, [
                createHTML('div', { class: 'p-4 border rounded-xl' }, [
                    createHTML('h3', { class: 'font-bold text-indigo-700 mb-2' }, 'Target Security Level (SL)'),
                    createHTML('p', { class: 'text-sm text-gray-500 mb-2' }, 'The security level to be achieved across the OT network.'),
                    createHTML('select', { disabled: true, class: 'mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm bg-gray-50' }, [
                        ['SL 1', 'SL 2', 'SL 3 (Recommended)', 'SL 4'].map(o => createHTML('option', {}, o))
                    ]),
                ]),
                createHTML('div', { class: 'p-4 border rounded-xl' }, [
                    createHTML('h3', { class: 'font-bold text-indigo-700 mb-2' }, 'Assessment Cadence'),
                    createHTML('p', { class: 'text-sm text-gray-500 mb-2' }, 'How often should full compliance checks be performed?'),
                    createHTML('select', { disabled: true, class: 'mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm bg-gray-50' }, [
                        ['Quarterly', 'Semi-Annually', 'Annually'].map(o => createHTML('option', {}, o))
                    ]),
                ]),
            ]),
        ]);

        const AdminDashboard = () => createHTML('div', { class: 'space-y-6 bg-white p-6 rounded-xl shadow-lg' }, [
            createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'Admin Dashboard & System Info'),
            createHTML('div', { class: 'grid grid-cols-1 md:grid-cols-2 gap-4 mt-4' }, [
                createHTML('div', { class: 'bg-gray-50 p-4 rounded-lg border' }, [
                    createHTML('h3', { class: 'font-bold text-lg text-red-700 flex items-center' }, [renderIcon('layers', 'w-5 h-5 mr-2'), ' Application ID (Mandatory Path)']),
                    createHTML('p', { class: 'text-sm text-gray-600 mt-1' }, `This ID is used in the Firestore public path: ${createHTML('code', { class: 'font-mono text-xs text-indigo-600 break-all' }, `/artifacts/<strong>${appId}</strong>/public/data/...`)}`),
                    createHTML('code', { class: 'block mt-2 p-2 bg-white rounded font-mono text-sm break-all' }, appId),
                ]),
                createHTML('div', { class: 'bg-gray-50 p-4 rounded-lg border' }, [
                    createHTML('h3', { class: 'font-bold text-lg text-indigo-700 flex items-center' }, [renderIcon('key', 'w-5 h-5 mr-2'), ' Current Session User ID']),
                    createHTML('p', { class: 'text-sm text-gray-600 mt-1' }, 'The unique UID assigned to this session by Firebase Authentication.'),
                    createHTML('code', { class: 'block mt-2 p-2 bg-white rounded font-mono text-sm break-all' }, state.userId || 'N/A'),
                ]),
            ]),
            createHTML('h2', { class: 'text-2xl font-semibold text-gray-800 pt-4' }, 'Mock User Management'),
            createHTML('div', { class: 'bg-gray-50 rounded-xl overflow-x-auto' }, [
                createHTML('table', { class: 'min-w-full divide-y divide-gray-200' }, [
                    createHTML('thead', { class: 'bg-gray-100' }, [
                        createHTML('tr', {}, [['Role', 'Email (Mock)', 'Full Firestore UID'].map(h => createHTML('th', { class: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, h))]),
                    ]),
                    createHTML('tbody', { class: 'bg-white divide-y divide-gray-200' }, MOCK_USERS.map(user => createHTML('tr', { key: user.uid, class: 'hover:bg-gray-50' }, [
                        createHTML('td', { class: 'px-6 py-4 whitespace-nowrap' }, createHTML('span', { class: `px-2 py-0.5 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'}` }, user.role)),
                        createHTML('td', { class: 'px-6 py-4 text-sm text-gray-900' }, user.email),
                        createHTML('td', { class: 'px-6 py-4 text-sm font-mono text-gray-600 break-all' }, user.uid),
                    ]))),
                ]),
            ]),
        ]);

        const UserGuide = () => createHTML('div', { class: 'space-y-6 bg-white p-6 rounded-xl shadow-lg' }, [
            createHTML('h1', { class: 'text-3xl font-extrabold text-gray-800 border-b pb-2' }, 'OT Guardian User Guide / Help'),
            createHTML('div', { class: 'space-y-4 text-gray-700' }, [
                createHTML('p', {}, 'Welcome to the OT Guardian Security Posture Management simulator. Use the <strong>Role Selector</strong> in the header to switch roles and test access control.'),
                createHTML('h2', { class: 'text-xl font-semibold text-indigo-700 pt-2 flex items-center' }, [renderIcon('cpu', 'w-5 h-5 mr-2'), ' Asset Builder']),
                createHTML('p', {}, 'Use this view to add new assets (PLCs, HMIs, etc.). When an asset is created, its compliance structures (IEC 62443, SANS) are automatically initialized with all controls set to <strong>\'Not Assessed\'</strong>.'),
                createHTML('h2', { class: 'text-xl font-semibold text-indigo-700 pt-2 flex items-center' }, [renderIcon('check-circle', 'w-5 h-5 mr-2'), ' Security Controls']),
                createHTML('p', {}, 'This is where engineers assess controls. Select an <strong>Asset</strong> and a <strong>Framework</strong> to see the control list. Use the status dropdown to mark compliance. If status is \'Not Implemented\' or \'Partially Implemented\', a <strong>Create Task</strong> button appears to log a remediation gap.'),
                createHTML('h2', { class: 'text-xl font-semibold text-indigo-700 pt-2 flex items-center' }, [renderIcon('shield', 'w-5 h-5 mr-2'), ' Risk Dashboards']),
                createHTML('p', {}, 'The dashboards provide a rollup of compliance data. The <strong>Risk Dashboard</strong> focuses on operational metrics and high-risk assets, while the <strong>Manager Dashboard</strong> provides an executive view of Foundational Requirement coverage.'),
            ]),
        ]);


        // --- MAIN RENDER LOGIC ---

        const renderApp = () => {
            const root = document.getElementById('root');
            let contentHtml = '';

            const navItems = [
                { view: 'riskDashboard', label: 'Risk Dashboard', icon: 'shield', roles: ['admin', 'manager', 'engineer'] },
                { view: 'managerDashboard', label: 'Manager Dashboard', icon: 'bar-chart-2', roles: ['admin', 'manager'] },
                { view: 'assetBuilder', label: 'Asset Builder', icon: 'cpu', roles: ['admin', 'engineer'] },
                { view: 'securityControls', label: 'Controls', icon: 'check-circle', roles: ['admin', 'engineer'] },
                { view: 'remediationTasks', label: 'Remediation Tasks', icon: 'hard-hat', roles: ['admin', 'manager', 'engineer'] },
                { view: 'reports', label: 'Reports', icon: 'file-text', roles: ['admin', 'manager'] },
                { view: 'userGuide', label: 'User Guide', icon: 'book-open', roles: ['admin', 'manager', 'engineer'] },
                { view: 'settings', label: 'Settings', icon: 'settings', roles: ['admin'] },
                { view: 'adminDashboard', label: 'Admin', icon: 'user', roles: ['admin'] },
            ].filter(item => hasAccess(item.roles));

            // Loading/Error States
            if (state.firebaseError) {
                contentHtml = createHTML('div', { class: 'flex flex-col items-center justify-center p-20 bg-red-50 rounded-xl shadow-lg border-2 border-red-300 mt-10' }, [
                    renderIcon('alert-triangle', 'w-12 h-12 text-red-500 mb-4'),
                    createHTML('h2', { class: 'text-2xl font-bold text-red-800 mb-2' }, 'Critical Error'),
                    createHTML('p', { class: 'text-gray-700 text-center max-w-md' }, state.firebaseError),
                ]);
            } else if (!state.isAuthReady) {
                contentHtml = createHTML('div', { class: 'flex flex-col items-center justify-center p-20 bg-white rounded-xl shadow-lg mt-10' }, [
                    createHTML('div', { class: 'animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mb-4' }),
                    createHTML('span', { class: 'text-xl font-medium text-indigo-700' }, 'Initializing Firebase connection...'),
                ]);
            } else {
                // Main Application Layout
                let mainContent = '';
                switch (state.currentView) {
                    case 'riskDashboard': mainContent = RiskDashboard(); break;
                    case 'managerDashboard': mainContent = ManagerDashboard(); break;
                    case 'assetBuilder': mainContent = AssetBuilder(); break;
                    case 'securityControls': mainContent = SecurityControls(); break;
                    case 'remediationTasks': mainContent = RemediationTasks(); break;
                    case 'reports': mainContent = Reports(); break;
                    case 'settings': mainContent = SettingsPage(); break;
                    case 'adminDashboard': mainContent = AdminDashboard(); break;
                    case 'userGuide': mainContent = UserGuide(); break;
                    default: mainContent = RiskDashboard();
                }

                const navBar = createHTML('nav', { id: 'main-nav', class: 'flex space-x-1 p-3 rounded-xl bg-white shadow-lg print-hide overflow-x-auto whitespace-nowrap mb-6' },
                    navItems.map(item => createHTML('button', {
                        'data-view': item.view,
                        class: `nav-btn flex items-center px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-150 ${
                            state.currentView === item.view ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-700 hover:bg-indigo-100'
                        }`
                    }, [
                        renderIcon(item.icon, 'w-4 h-4 mr-2'), item.label
                    ]))
                );

                contentHtml = [
                    createHTML('header', { class: 'bg-indigo-800 text-white shadow-xl print-hide' }, [
                        createHTML('div', { class: 'container mx-auto px-4 py-3 flex justify-between items-center' }, [
                            createHTML('h1', { class: 'text-2xl font-bold flex items-center' }, [
                                renderIcon('shield', 'w-6 h-6 mr-2'), 'OT Guardian Security Posture Management'
                            ]),
                            createHTML('div', { class: 'flex items-center space-x-4' }, [
                                // Role Selector
                                createHTML('div', { class: 'text-sm flex items-center bg-indigo-700 p-2 rounded-lg' }, [
                                    createHTML('span', { class: 'mr-2' }, 'View as:'),
                                    createHTML('select', { id: 'role-selector', class: 'bg-indigo-600 text-white rounded-md p-1 font-semibold focus:ring-2 focus:ring-white' },
                                        ['admin', 'manager', 'engineer'].map(role => createHTML('option', { value: role, selected: role === state.userRole }, role))
                                    ),
                                ]),
                                createHTML('span', { class: 'text-sm font-medium hidden sm:inline' }, `Current User: ${createHTML('code', { class: 'bg-indigo-700 px-2 py-1 rounded-md text-xs break-all' }, state.userId || 'N/A')}`),
                                createHTML('button', { title: 'Sign Out (Placeholder)', class: 'p-2 rounded-full bg-indigo-700 hover:bg-indigo-600 transition-colors shadow-lg' }, renderIcon('log-out', 'w-5 h-5'))
                            ]),
                        ]),
                    ]),
                    createHTML('div', { class: 'flex-grow container mx-auto px-4 py-4 print-full' }, [
                        createHTML('div', { id: 'message-box', style: 'display: none;' }),
                        navBar,
                        createHTML('main', { class: 'p-1 sm:p-4' }, mainContent)
                    ])
                ].join('');
            }
           
            root.innerHTML = contentHtml;

            // Post-render event listeners for navigation and role switching
            if (state.isAuthReady && !state.firebaseError) {
                // Navigation
                document.querySelectorAll('.nav-btn').forEach(button => {
                    button.onclick = (e) => updateState({ currentView: e.currentTarget.getAttribute('data-view') });
                });
                // Role Selector
                document.getElementById('role-selector').onchange = (e) => updateState({ userRole: e.target.value, currentView: 'riskDashboard' });
            }
           
            // Re-initialize Lucide icons
            lucide.createIcons();
        };

        // Initialize the application
        initializeFirebase();

    </script>
</body>
</html>
