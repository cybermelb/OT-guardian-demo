<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian Deployment Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM (UMD development builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel to process JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
   
    <style>
        @media print {
            .print-hide { display: none !important; }
            .print-full { max-width: none !important; margin: 0 !important; padding: 0 !important; }
            body, .bg-gray-100 { background-color: white !important; }
            .table-responsive td, .table-responsive th { white-space: normal !important; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #A5B4FC; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #E0E7FF; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div id="root"></div>

    <!--
        CRUCIAL FIX: Replacing dynamic 'await import()' with static module imports.
        This loads Firebase immediately and exposes the required functions to the global 'window.firebase'
        object, which is more robust against network restrictions than dynamic module loading.
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import * as firebaseAuth from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import * as firebaseFirestore from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose all necessary functions to the global scope for the React/Babel script to use
        window.firebase = {
            // App
            initializeApp: initializeApp,

            // Auth
            getAuth: firebaseAuth.getAuth,
            onAuthStateChanged: firebaseAuth.onAuthStateChanged,
            signInWithEmailAndPassword: firebaseAuth.signInWithEmailAndPassword,
            createUserWithEmailAndPassword: firebaseAuth.createUserWithEmailAndPassword,
            signOut: firebaseAuth.signOut,

            // Firestore
            getFirestore: firebaseFirestore.getFirestore,
            doc: firebaseFirestore.doc,
            setDoc: firebaseFirestore.setDoc,
            collection: firebaseFirestore.collection,
            query: firebaseFirestore.query,
            onSnapshot: firebaseFirestore.onSnapshot,
            serverTimestamp: firebaseFirestore.serverTimestamp,
            setLogLevel: firebaseFirestore.setLogLevel,
            addDoc: firebaseFirestore.addDoc,
            getDoc: firebaseFirestore.getDoc,
            updateDoc: firebaseFirestore.updateDoc,
            deleteDoc: firebaseFirestore.deleteDoc,
            where: firebaseFirestore.where,
            orderBy: firebaseFirestore.orderBy,
        };
        console.log("Firebase module functions loaded and exposed to window.firebase");
    </script>
   
    <!-- The entire React application -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- INLINE SVG ICONS (Same as before) ---
        const Shield = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>);
        const LogOut = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const Loader = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>);
        const Mail = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>);
        const Lock = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>);
        const Key = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 18 16 4l3 3 7 7-3 3-3-3zM2 18l3-3 7 7-3 3zM16 4l-3 3-7 7 3-3z"></path><circle cx="16" cy="4" r="2"></circle><circle cx="5" cy="15" r="2"></circle></svg>);
        const UserPlus = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>);
        const AlertTriangle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/></svg>);
        const BarChart2 = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>);
        const Target = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>);
        const Zap = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>);
        const Cpu = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><polyline points="9 9 15 9 15 15 9 15 9 9"></polyline><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="15" x2="23" y2="15"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="15" x2="4" y2="15"></line></svg>);
        const CheckCircle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.68"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
        const HardHat = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 11h-1.5a1.5 1.5 0 0 1 0-3H19a1.5 1.5 0 0 1 0 3z"/><path d="M12 19V9l6.3-2.61a1.68 1.68 0 0 0-.6-3.2l-5.6-2.58a1.68 1.68 0 0 0-2.6 1.3V5h-.48a.48.48 0 0 0-.48.48V7.5l-2 1.5V11h4v4h-4v4h4v3.5a.5.5 0 0 0 1 0V19z"/></svg>);
        const User = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        // --- END OF INLINE SVG ICONS ---

        // Helper function to check if Firebase is globally loaded
        const isFirebaseLoaded = () => typeof window.firebase !== 'undefined' && typeof window.firebase.initializeApp === 'function';

        // --- COMMON UI COMPONENTS (Same as before) ---

        const Card = ({ title, children, className = '' }) => (
            <div className={`p-5 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow ${className}`}>
                {title && <h3 className="text-lg font-bold text-gray-800 mb-3">{title}</h3>}
                {children}
            </div>
        );
       
        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, type = 'button' }) => {
            let baseStyle = "px-4 py-2 font-semibold text-sm rounded-lg transition-all duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2";
            let variantStyle = '';
           
            switch (variant) {
                case 'secondary':
                    variantStyle = 'bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-500';
                    break;
                case 'danger':
                    variantStyle = 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500';
                    break;
                case 'success':
                    variantStyle = 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500';
                    break;
                default: // primary
                    variantStyle = 'bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500';
            }
           
            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    type={type}
                    className={`${baseStyle} ${variantStyle} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'}`}
                >
                    {children}
                </button>
            );
        };
       
        const InputField = ({ label, name, type = 'text', value, onChange, required = false, icon: Icon, placeholder = '' }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <div className="relative flex items-center">
                    {Icon && <Icon className="absolute left-3 w-5 h-5 text-gray-400" />}
                    <input
                        type={type}
                        name={name}
                        value={value}
                        onChange={onChange}
                        required={required}
                        placeholder={placeholder}
                        className={`w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 ${Icon ? 'pl-10' : ''}`}
                    />
                </div>
            </div>
        );


        // --- AUTHENTICATION GATE COMPONENT ---

        const AuthGate = ({ initError }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
           
            // Display the detailed initialization error if it exists
            if (initError) {
                // If initError is a string, it means we hit a fatal error during setupFirebase.
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                        <Card className="w-full max-w-xl p-8 text-center border-red-500 border-2">
                            <AlertTriangle className="w-8 h-8 mx-auto text-red-500 mb-4" />
                            <h2 className="text-xl font-bold text-red-700 mb-2">FIREBASE CONFIGURATION ERROR</h2>
                            <p className="text-gray-600 whitespace-pre-wrap text-sm text-left font-mono bg-red-50 p-3 rounded-lg overflow-x-auto">
                                **Details:** {initError}
                            </p>
                            <p className="mt-4 text-sm text-gray-700 text-left">
                                **Action Required:** The system failed to parse the Firebase configuration. Please ensure the Vercel environment variable **<code className="font-bold text-black">__firebase_config</code>** is set, and its value is a single, valid, non-escaped JSON string (e.g., <code className="font-bold text-black">{"{"}apiKey: "...", ...{"}"}</code>).
                            </p>
                        </Card>
                    </div>
                );
            }
           
            // If Firebase modules were not loaded statically
            if (!isFirebaseLoaded()) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                        <Card className="w-full max-w-xl p-8 text-center border-red-500 border-2">
                            <AlertTriangle className="w-8 h-8 mx-auto text-red-500 mb-4" />
                            <h2 className="text-xl font-bold text-red-700 mb-2">SDK MODULE LOAD FAILURE</h2>
                            <p className="text-gray-600 text-sm mt-2">
                                The Firebase module scripts failed to load statically. This usually indicates a network or Content Security Policy (CSP) restriction blocking
                                access to <code className="font-mono text-black">https://www.gstatic.com</code>.
                            </p>
                        </Card>
                    </div>
                );
            }

            // If we made it past initialization, proceed with the login form
            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError(null);
                setIsLoading(true);
                const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.firebase;

                try {
                    const auth = getAuth();
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        console.log("User registered and signed in.");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        console.log("User signed in.");
                    }
                } catch (err) {
                    let msg = 'An unknown error occurred.';
                    if (err.code) {
                        if (err.code === 'auth/operation-not-allowed') {
                            // Specific fix for the user's reported error
                            msg = `Operation Not Allowed (Code: auth/operation-not-allowed).
                                PLEASE GO TO YOUR FIREBASE CONSOLE -> AUTHENTICATION -> SIGN-IN METHOD, and ensure the Email/Password provider is ENABLED.`;
                        } else {
                            // Clean up standard Firebase error codes
                            msg = err.code.replace('auth/', '').replace(/-/g, ' ');
                            msg = msg.charAt(0).toUpperCase() + msg.slice(1);
                        }
                    } else if (err.message) {
                        msg = err.message;
                    }
                    setAuthError(msg);
                    console.error("Auth Error:", err);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <Card className="w-full max-w-md p-8">
                        <h2 className="text-3xl font-bold text-center text-indigo-700 mb-6 flex items-center justify-center">
                            <Shield className="w-8 h-8 mr-2" /> OT Guardian Login
                        </h2>
                       
                        {authError && (
                            <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm flex items-center">
                                <AlertTriangle className="w-4 h-4 mr-2 flex-shrink-0" />
                                <span className="break-words whitespace-pre-wrap">{authError}</span>
                            </div>
                        )}

                        <form onSubmit={handleAuth}>
                            <InputField
                                label="Email Address"
                                name="email"
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                                placeholder="user@domain.com (e.g., cybermelb@gmail.com)"
                                icon={Mail}
                            />
                            <InputField
                                label="Password"
                                name="password"
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                                placeholder="minimum 6 characters"
                                icon={Lock}
                            />

                            <Button
                                type="submit"
                                className="w-full mt-6 flex items-center justify-center"
                                disabled={isLoading || !email || password.length < 6}
                            >
                                {isLoading ? <Loader className="w-5 h-5 mr-2 animate-spin" /> : (
                                    isRegistering ? <UserPlus className="w-5 h-5 mr-2" /> : <Key className="w-5 h-5 mr-2" />
                                )}
                                {isRegistering ? 'Register Account' : 'Sign In'}
                            </Button>
                        </form>

                        <p className="mt-6 text-center text-sm text-gray-600">
                            {isRegistering ? (
                                <>
                                    Already have an account?{' '}
                                    <button
                                        onClick={() => { setIsRegistering(false); setAuthError(null); }}
                                        className="font-semibold text-indigo-600 hover:text-indigo-800"
                                    >
                                        Sign In
                                    </button>
                                </>
                            ) : (
                                <>
                                    Don't have an account?{' '}
                                    <button
                                        onClick={() => { setIsRegistering(true); setAuthError(null); }}
                                        className="font-semibold text-indigo-600 hover:text-indigo-800"
                                    >
                                        Register
                                    </button>
                                </>
                            )}
                        </p>
                    </Card>
                </div>
            );
        };


        // --- VIEW COMPONENTS (Same as before) ---
       
        const OverviewDashboard = ({ userId, risks, assets, deploymentStatus }) => {
            const totalAssets = assets.length;
            const highRiskCount = risks.filter(r => r.severity === 'High').length;
            const criticalAssets = assets.filter(a => a.criticality === 'High').length;
            const onlineStatus = deploymentStatus?.status === 'Online';
           
            const AssetSummaryTable = () => (
                <div className="overflow-x-auto table-responsive custom-scrollbar">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-indigo-50">
                            <tr>
                                <th className="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider rounded-tl-lg">Name</th>
                                <th className="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Type</th>
                                <th className="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Criticality</th>
                                <th className="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider rounded-tr-lg">Location</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-100">
                            {assets.slice(0, 5).map((asset) => (
                                <tr key={asset.id} className="hover:bg-gray-50 transition-colors">
                                    <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{asset.name}</td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{asset.type}</td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm">
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                            asset.criticality === 'High' ? 'bg-red-100 text-red-800' :
                                            asset.criticality === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }`}>
                                            {asset.criticality}
                                        </span>
                                    </td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{asset.location}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );

            return (
                <div className="space-y-6">
                    <h2 className="text-3xl font-extrabold text-gray-900">OT Security Overview</h2>
                   
                    {/* Status Cards Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <Card className="border-t-4 border-indigo-500">
                            <BarChart2 className="w-8 h-8 text-indigo-500 mb-2" />
                            <p className="text-sm text-gray-500">Total Assets</p>
                            <p className="text-2xl font-bold text-gray-900">{totalAssets}</p>
                        </Card>
                        <Card className="border-t-4 border-red-500">
                            <AlertTriangle className="w-8 h-8 text-red-500 mb-2" />
                            <p className="text-sm text-gray-500">High Severity Risks</p>
                            <p className="text-2xl font-bold text-gray-900">{highRiskCount}</p>
                        </Card>
                        <Card className="border-t-4 border-yellow-500">
                            <Target className="w-8 h-8 text-yellow-500 mb-2" />
                            <p className="text-sm text-gray-500">Critical Assets</p>
                            <p className="text-2xl font-bold text-gray-900">{criticalAssets}</p>
                        </Card>
                        <Card className={`border-t-4 ${onlineStatus ? 'border-green-500' : 'border-gray-400'}`}>
                            <Zap className={`w-8 h-8 mb-2 ${onlineStatus ? 'text-green-500' : 'text-gray-400'}`} />
                            <p className="text-sm text-gray-500">System Status</p>
                            <p className={`text-2xl font-bold ${onlineStatus ? 'text-green-700' : 'text-gray-700'}`}>
                                {deploymentStatus?.status || 'Offline'}
                            </p>
                        </Card>
                    </div>

                    <Card title="Latest Asset Registrations">
                        {totalAssets > 0 ? <AssetSummaryTable /> : <p className="text-gray-500">No assets registered yet.</p>}
                    </Card>
                   
                    <p className="text-sm text-gray-500 italic">User ID: {userId}</p>
                </div>
            );
        };
       
        const PlaceholderView = ({ title, icon: Icon }) => (
            <div className="flex flex-col items-center justify-center h-96 bg-white rounded-xl shadow-lg p-6">
                <Icon className="w-16 h-16 text-indigo-400 mb-4" />
                <h2 className="text-3xl font-bold text-gray-800">{title}</h2>
                <p className="text-gray-500 mt-2">This feature is coming soon! Check back for updates.</p>
            </div>
        );

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [currentView, setCurrentView] = useState('overview');
            const [authUser, setAuthUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [risks, setRisks] = useState([]);
            const [assets, setAssets] = useState([]);
            const [deploymentStatus, setDeploymentStatus] = useState(null);
           
            // Firebase State
            const [fbApp, setFbApp] = useState(null); // Holds the initialized Firebase App instance
            const [initError, setInitError] = useState(null); // Holds initialization errors
            const fb = window.firebase; // Global access to Firebase functions

            // 1. Firebase Initialization Effect
            useEffect(() => {
                if (!isFirebaseLoaded()) {
                    setInitError("SDK Module Load Failure: window.firebase object not found after static script execution.");
                    setIsAuthLoading(false);
                    return;
                }

                const setupFirebase = () => {
                    let rawConfig = 'N/A';
                    let firebaseConfig = {};

                    try {
                        // 1. Safely retrieve the environment variable
                        rawConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';

                        // 2. Perform a robust parse. Trim any whitespace/quotes that might have been
                        // accidentally introduced during deployment configuration.
                        let cleanedConfig = rawConfig.trim();
                        // Attempt to strip surrounding quotes if they exist (common Vercel issue)
                        if (cleanedConfig.startsWith('"') && cleanedConfig.endsWith('"')) {
                            cleanedConfig = cleanedConfig.substring(1, cleanedConfig.length - 1);
                        }
                       
                        // 3. Final attempt to parse
                        firebaseConfig = JSON.parse(cleanedConfig);

                        if (!firebaseConfig || !firebaseConfig.apiKey) {
                            throw new Error(`Invalid Config: Parsed object is missing an 'apiKey' or is empty.`);
                        }
                    } catch (e) {
                        // If any step fails, catch the error and format it clearly
                        const errorMsg = `Config Parsing Failed: ${e.message}.
Raw Input (first 100 chars): ${rawConfig.substring(0, 100)}...`;
                        console.error("Config Error:", errorMsg);
                        setInitError(errorMsg);
                        setIsAuthLoading(false);
                        return;
                    }

                    try {
                        // 4. Initialize App and Services using globally available functions
                        const app = fb.initializeApp(firebaseConfig);
                        const auth = fb.getAuth(app);
                        const db = fb.getFirestore(app);
                        fb.setLogLevel('Debug');
                       
                        setFbApp({ app, auth, db });
                        console.log("Firebase services initialized successfully.");
                       
                        // 5. Setup Auth Listener
                        fb.onAuthStateChanged(auth, (user) => {
                            setAuthUser(user);
                            setIsAuthLoading(false);
                        });

                    } catch (e) {
                        const errorMsg = `Firebase Initialization Failed: ${e.message}. Ensure your config values (like 'projectId') are correct.`;
                        console.error("Critical Firebase Init Error:", e);
                        setInitError(errorMsg);
                        setIsAuthLoading(false);
                    }
                };
                setupFirebase();
            }, []); // Empty dependency array ensures this runs once

            const userId = authUser?.uid;
            const userEmail = authUser?.email || 'N/A';
           
            // Firestore Collection Ref Getter
            const getPublicCollectionRef = (collectionName) => {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // IMPORTANT: Use the full path for collections
                return fbApp?.db ? fb.collection(fbApp.db, `artifacts/${appId}/public/data/${collectionName}`) : null;
            };

            // 2. Data Fetching Effect (Assets, Risks, Status)
            useEffect(() => {
                // IMPORTANT: Ensure everything is ready before trying to attach listeners
                if (!userId || isAuthLoading || initError || !fb || !fbApp) return;

                const setupPublicListener = (collectionName, setState) => {
                    const colRef = getPublicCollectionRef(collectionName);
                    if (colRef) {
                        // Note: Sorting is done in JS as per instructions to avoid index errors
                        const q = fb.query(colRef);
                        const unsubscribe = fb.onSnapshot(q, (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            // Sort data in memory
                            data.sort((a, b) => {
                                const timeA = a.createdAt?.seconds || 0;
                                const timeB = b.createdAt?.seconds || 0;
                                return timeB - timeA;
                            });
                            setState(data);
                        }, (error) => {
                            console.error(`Error listening to ${collectionName}:`, error);
                        });
                        return unsubscribe;
                    }
                    return () => {};
                };

                const unsubscribeAssets = setupPublicListener('assets', setAssets);
                const unsubscribeRisks = setupPublicListener('risks', setRisks);

                // Listener for single document status
                const statusCollectionRef = getPublicCollectionRef('status');
                let unsubscribeStatus = () => {};

                if (statusCollectionRef) {
                    unsubscribeStatus = fb.onSnapshot(
                        fb.doc(statusCollectionRef, 'current'),
                        (docSnapshot) => {
                            if (docSnapshot.exists()) {
                                setDeploymentStatus(docSnapshot.data());
                            } else {
                                // Initialize default status if it doesn't exist
                                if(userId) {
                                    const defaultStatus = { status: 'Online', lastCheck: fb.serverTimestamp() };
                                    fb.setDoc(fb.doc(statusCollectionRef, 'current'), defaultStatus, { merge: true })
                                        .catch(e => console.error("Error setting initial status:", e));
                                    setDeploymentStatus(defaultStatus);
                                }
                            }
                        }, (error) => {
                            console.error("Error listening to deployment status:", error);
                        }
                    );
                }

                return () => {
                    unsubscribeAssets();
                    unsubscribeRisks();
                    unsubscribeStatus();
                };
            }, [userId, isAuthLoading, initError, fb, fbApp]);

            const checkAdminAccess = () => {
                // Admin check based on email (cybermelb@gmail.com added for demo)
                return userEmail === 'admin@otguardian.com' || userEmail === 'cybermelb@gmail.com';
            };
           
            const renderView = () => {
                if (isAuthLoading) {
                    // Show a specific error if init failed, otherwise show loading
                    if(initError) {
                        // initError is guaranteed to be a string here due to checks in setupFirebase
                        return <AuthGate initError={initError} />;
                    }
                   
                    if (!isFirebaseLoaded()) {
                         return <div className="text-center p-12 text-gray-500 flex flex-col items-center">
                            <Loader className="w-8 h-8 animate-spin-slow text-red-500 mb-4" />
                            <p>Waiting for Static Firebase SDK Load...</p>
                            <p className="text-xs mt-2 text-red-500">If this persists, the CDN link is blocked.</p>
                        </div>;
                    }

                    return <div className="text-center p-12 text-gray-500 flex flex-col items-center">
                        <Loader className="w-8 h-8 animate-spin-slow text-indigo-500 mb-4" />
                        <p>Authenticating User...</p>
                        <p className="text-xs mt-2">Connecting to OT Guardian Security services.</p>
                    </div>;
                }
               
                if (!userId) {
                    // Render AuthGate for sign-in
                    return <AuthGate initError={initError} />;
                }
               
                // Content Views
                switch (currentView) {
                    case 'overview':
                        return <OverviewDashboard userId={userId} risks={risks} assets={assets} deploymentStatus={deploymentStatus} />;
                    case 'assetBuilder':
                        return <PlaceholderView title="Asset Builder" icon={Cpu} />;
                    case 'riskDashboard':
                        return <PlaceholderView title="Risk Dashboard" icon={Shield} />;
                    case 'securityControls':
                        return <PlaceholderView title="Security Controls" icon={CheckCircle} />;
                    case 'remediationTasks':
                        return <PlaceholderView title="Remediation Tasks" icon={HardHat} />;
                    case 'admin':
                        return checkAdminAccess() ? <PlaceholderView title="Admin Panel" icon={User} /> : <div className="text-center p-12 text-red-500">Access Denied: Admin Privileges Required.</div>;
                    default:
                        return <OverviewDashboard userId={userId} risks={risks} assets={assets} deploymentStatus={deploymentStatus} />;
                }
            };
           
            const handleLogout = async () => {
                if (fb && fbApp?.auth) {
                    try {
                        await fb.signOut(fbApp.auth);
                        console.log("User signed out successfully.");
                    } catch (error) {
                        console.error("Error during sign out:", error);
                    }
                }
            };


            return (
                <div className="min-h-screen bg-gray-50 flex flex-col items-center">
                    <div className="w-full max-w-6xl bg-white shadow-xl rounded-xl mt-6 mb-6 print-full">
                       
                        {/* Header */}
                        <header className="flex justify-between items-center p-4 border-b bg-indigo-800 text-white rounded-t-xl print-hide">
                            <h1 className="text-2xl font-bold flex items-center">
                                <Shield className="w-6 h-6 mr-2" /> OT Guardian Deployment
                            </h1>
                            {userId ? (
                                <div className="flex items-center space-x-3">
                                    <span className="text-sm font-medium opacity-80 hidden sm:inline">
                                        {userEmail}
                                    </span>
                                    <button
                                        onClick={handleLogout}
                                        className='p-2 bg-indigo-700 hover:bg-indigo-600 rounded-full transition duration-150 shadow-md'
                                        aria-label="Log Out"
                                        title="Log Out"
                                    >
                                        <LogOut className='w-5 h-5' />
                                    </button>
                                </div>
                            ) : (
                                <span className="text-sm font-medium opacity-80">
                                    Sign In Required
                                </span>
                            )}
                        </header>

                        {/* Navigation Bar - Only show if authenticated */}
                        {userId && (
                            <nav className="flex space-x-1 p-3 border-b bg-gray-50 overflow-x-auto whitespace-nowrap print-hide custom-scrollbar">
                                {[
                                    { view: 'overview', label: 'Overview', icon: <BarChart2 className="w-4 h-4 mr-2" /> },
                                    { view: 'riskDashboard', label: 'Risk Dashboard', icon: <Shield className="w-4 h-4 mr-2" /> },
                                    { view: 'assetBuilder', label: 'Asset Builder', icon: <Cpu className="w-4 h-4 mr-2" /> },
                                    { view: 'securityControls', label: 'Controls', icon: <CheckCircle className="w-4 h-4 mr-2" /> },
                                    { view: 'remediationTasks', label: 'Remediation', icon: <HardHat className="w-4 h-4 mr-2" /> },
                                    ...(checkAdminAccess() ? [{ view: 'admin', label: 'Admin', icon: <User className="w-4 h-4 mr-2" /> }] : []),
                                ].map(item => {
                                    return (
                                        <button
                                            key={item.view}
                                            onClick={() => setCurrentView(item.view)}
                                            className={`flex items-center px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-150 ${
                                                currentView === item.view ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-700 hover:bg-indigo-100'
                                            }`}
                                        >
                                            {item.icon}
                                            {item.label}
                                        </button>
                                    );
                                })}
                            </nav>
                        )}
                       
                        {/* Deployment Status Bar - Only show if authenticated */}
                        {userId && deploymentStatus && (
                            <div className={`p-3 text-sm font-semibold rounded-xl text-center shadow-inner mx-4 mt-4 print-hide ${
                                deploymentStatus?.status === 'Online' ? 'bg-green-100 text-green-800' :
                                deploymentStatus?.status === 'Warning' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }`}>
                                <Zap className="w-4 h-4 inline mr-1" />
                                Deployment Status: {deploymentStatus?.status || 'Loading...'} |
                                Last Check: {deploymentStatus?.lastCheck?.seconds ? new Date(deploymentStatus.lastCheck.seconds * 1000).toLocaleString() : 'N/A'}
                            </div>
                        )}

                        {/* Main Content Area */}
                        <main className="p-4 md:p-6">
                            {renderView()}
                        </main>
                    </div>
                </div>
            );
        };

        // Standard React 18 rendering code
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
