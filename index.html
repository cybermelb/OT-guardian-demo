<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian -ICS/OT Cyber Security Posture Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons for UI -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Mobile sidebar visibility classes */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-visible {
            transform: translateX(0) !important;
        }
        /* Style for required form fields */
        input:required:invalid, select:required:invalid, textarea:required:invalid {
            border-color: #fca5a5; /* Red-300 */
        }
        /* Base font */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel, addDoc, getDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App State variables
        let app = null;
        let db = null;
        let auth = null;
        
        // Provided environment variables (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "dummy-key",
            authDomain: "dummy-domain.firebaseapp.com",
            projectId: "default-app-id",
            storageBucket: "dummy-bucket.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:a1b2c3d4e5f6g7h8i9j0"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Use the environment variable config
        const MANUAL_FIREBASE_CONFIG = firebaseConfig;

        // --- Application State ---
        const appState = {
            isFirebaseReady: false,
            isAuthReady: false,
            userId: null,
            email: null,
            appId: appId,
            currentView: 'Dashboard', // Default view
            error: null,
            data: {
                tasks: [],
                sites: [],
                users: [],
            },
            modal: {
                isOpen: false,
                content: '',
                onConfirm: null,
                isConfirming: false,
                confirmButtonText: 'Confirm',
                title: 'Confirm Action',
                type: 'confirm' // 'confirm', 'form', 'info'
            },
            sidebarOpen: false,
            taskForm: {
                id: null, // For editing
                title: '',
                siteId: '',
                description: '',
                severity: 'Medium',
                status: 'Open',
                dueDate: '',
                assignedTo: ''
            }
        };

        // --- Firestore Utilities ---

        /**
         * Generates the public data path for a given collection.
         * @param {string} collectionName
         * @returns {string}
         */
        function getPublicCollectionPath(collectionName) {
            return `artifacts/${appState.appId}/public/data/${collectionName}`;
        }

        // --- State Management and Rendering ---

        /**
         * Renders the application content by updating the DOM.
         */
        function render() {
            const appEl = document.getElementById('app');
            if (!appEl) return;

            if (appState.error) {
                appEl.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100 rounded-lg m-4">${appState.error}</div>`;
                return;
            }

            if (!appState.isAuthReady) {
                // Show a simple loading state until auth is checked
                appEl.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center p-8 bg-white shadow-xl rounded-xl">
                            <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-lg font-medium text-gray-700">Connecting to OT Guardian...</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Main application structure
            const currentViewFn = VIEWS[`${appState.currentView}View`];
            const content = currentViewFn ? currentViewFn() : `
                <div class="text-center p-12">
                    <h2 class="text-2xl font-bold text-gray-800">404 - View Not Found</h2>
                    <p class="text-gray-600 mt-2">The requested view (${appState.currentView}) could not be loaded.</p>
                </div>
            `;

            appEl.innerHTML = `
                <div class="min-h-screen flex">
                    ${renderSidebar()}
                    <div class="flex-1 flex flex-col overflow-hidden">
                        ${renderNav()}
                        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6 custom-scrollbar">
                            ${content}
                        </main>
                    </div>
                </div>
                ${renderModal()}
            `;

            // Re-run lucide icon replacement
            if (window.lucide) {
                window.lucide.createIcons();
            }

            // Close sidebar on navigation click on mobile
            if (appState.sidebarOpen) {
                toggleSidebar();
            }
        }

        // --- Authentication Logic ---

        /**
         * Attempts to sign in using the provided initial custom token.
         */
        async function attemptCustomTokenSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Custom token sign-in successful.");
                } else {
                    console.warn("No environment token found. Signing in anonymously.");
                    await signInAnonymously(auth);
                }
            } catch (e) {
                // If custom token fails, fall back to anonymous or just log the error
                console.error("Custom token sign-in failed. Attempting Anonymous Sign-in.", e);
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Anonymous sign-in also failed:", anonError);
                    appState.error = "Failed to sign in. Please check console.";
                    render();
                }
            }
        }

        /**
         * Updates the global state when the Firebase Auth state changes.
         * @param {firebase.User} user
         */
        function updateAuthState(user) {
            if (user) {
                appState.userId = user.uid;
                appState.email = user.email; // Will be null for anonymous users
                
                // If it's the first time the auth state is ready, set up listeners
                if (!appState.isAuthReady) {
                    setupDataListeners();
                    // If the user signed in anonymously (which happens if no token), nudge them to log in/register
                    if (user.isAnonymous) {
                         // Open the LogIn modal automatically for anonymous users to prompt them to register/login
                         openModal(VIEWS.LogInView(), 'Sign In or Register', 'info');
                    }
                }
            } else {
                appState.userId = null;
                appState.email = null;
                // If the user logs out, reset view and data
                appState.currentView = 'Dashboard';
                appState.data.tasks = [];
                appState.data.sites = [];
                appState.data.users = [];
            }
            appState.isAuthReady = true;
            render();
        }

        /**
         * Handles user sign-out.
         */
        async function handleSignOut() {
            try {
                closeModal();
                // Instead of just signing out, sign out and then sign back in anonymously
                await signOut(auth);
                await signInAnonymously(auth);
                appState.error = null;
            } catch (e) {
                console.error("Sign out error:", e);
                appState.error = "Sign out failed. See console for details.";
                render();
            }
        }

        /**
         * Handles user login/registration.
         * @param {Event} e 
         */
        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            
            const formType = e.target.getAttribute('data-form-type');
            const email = e.target.email.value;
            const password = e.target.password.value;
            const isRegister = formType === 'register';

            appState.modal.isConfirming = true;
            renderModal();

            try {
                if (isRegister) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    await saveUserProfile(email, auth.currentUser.uid);
                    appState.error = null;
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    appState.error = null;
                }
                closeModal();
            } catch (error) {
                console.error("Auth Error:", error);
                // Update modal content to show error without closing
                const errorMsg = error.message.includes('email-already-in-use') ? "Email already in use. Please log in or use a different email." :
                                 error.message.includes('wrong-password') || error.message.includes('user-not-found') ? "Invalid email or password." :
                                 error.message.includes('weak-password') ? "Password must be at least 6 characters." :
                                 "Authentication failed. See console for details.";
                document.getElementById('auth-error-message').innerText = errorMsg;
            } finally {
                appState.modal.isConfirming = false;
                renderModal();
            }
        }

        /**
         * Saves a basic user profile (public data) after registration.
         * @param {string} email 
         * @param {string} uid 
         */
        async function saveUserProfile(email, uid) {
            if (!db) return;
            const userRef = doc(db, getPublicCollectionPath('users'), uid);
            await setDoc(userRef, {
                userId: uid,
                email: email,
                role: 'Analyst', // Default role
                createdAt: serverTimestamp()
            }, { merge: true });
        }


        // --- Data Listeners ---

        /**
         * Sets up real-time Firestore listeners for core application data.
         */
        function setupDataListeners() {
            if (!db || !appState.userId) {
                console.warn("Firestore or User ID not ready for listener setup.");
                return;
            }
            console.log("Setting up data listeners for user:", appState.userId);

            // 1. Tasks Listener (Public data)
            const tasksColRef = collection(db, getPublicCollectionPath('tasks'));
            const tasksQuery = query(tasksColRef);

            onSnapshot(tasksQuery, (snapshot) => {
                appState.data.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort tasks by severity (High, Medium, Low) and then by Due Date
                const severityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                appState.data.tasks.sort((a, b) => {
                    const sevA = severityOrder[a.severity] || 0;
                    const sevB = severityOrder[b.severity] || 0;
                    if (sevA !== sevB) return sevB - sevA;
                    // Then sort by due date
                    return new Date(a.dueDate || '3000-01-01') - new Date(b.dueDate || '3000-01-01');
                });
                render();
            }, (error) => {
                console.error("Tasks listener failed:", error);
                appState.error = "Failed to load tasks. See console for details.";
                render();
            });

            // 2. Sites/Assets Listener (Public data)
            const sitesColRef = collection(db, getPublicCollectionPath('sites'));
            const sitesQuery = query(sitesColRef);

            onSnapshot(sitesQuery, (snapshot) => {
                appState.data.sites = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => {
                console.error("Sites listener failed:", error);
                appState.error = "Failed to load sites/assets. See console for details.";
                render();
            });
            
            // 3. Users Listener (Public data)
            const usersColRef = collection(db, getPublicCollectionPath('users'));
            const usersQuery = query(usersColRef);

            onSnapshot(usersQuery, (snapshot) => {
                appState.data.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => {
                console.error("Users listener failed:", error);
                appState.error = "Failed to load user list. See console for details.";
                render();
            });
        }

        // --- Navigation and UI Helpers ---

        /**
         * Changes the current view.
         * @param {string} viewName - The name of the view to switch to.
         */
        function navigate(viewName) {
            appState.currentView = viewName;
            render();
        }

        /**
         * Toggles the mobile sidebar visibility.
         */
        function toggleSidebar() {
            appState.sidebarOpen = !appState.sidebarOpen;
            render();
        }

        // --- Modal Logic ---

        /**
         * Opens the modal with dynamic content and optional confirmation handler.
         * @param {string} contentHtml - The HTML content for the modal body.
         * @param {string} [title='Confirm Action'] - The title of the modal.
         * @param {string} [type='confirm'] - 'confirm', 'form', or 'info'.
         * @param {function} [onConfirm=null] - The callback function for the confirm button.
         * @param {string} [confirmButtonText='Confirm'] - Text for the confirm button.
         */
        function openModal(contentHtml, title = 'Confirm Action', type = 'confirm', onConfirm = null, confirmButtonText = 'Confirm') {
            appState.modal = {
                isOpen: true,
                content: contentHtml,
                onConfirm: onConfirm,
                isConfirming: false,
                confirmButtonText: confirmButtonText,
                title: title,
                type: type
            };
            renderModal();
        }

        /**
         * Closes the modal.
         */
        function closeModal() {
            appState.modal.isOpen = false;
            appState.modal.onConfirm = null;
            renderModal();
        }

        /**
         * Handles the confirmation button click inside the modal.
         */
        async function handleModalConfirm() {
            if (appState.modal.onConfirm) {
                appState.modal.isConfirming = true;
                renderModal();
                try {
                    await appState.modal.onConfirm();
                } catch (e) {
                    console.error("Modal confirmation failed:", e);
                    // Optionally display error within the modal
                } finally {
                    appState.modal.isConfirming = false;
                    closeModal(); // Close after success or failure, or handle error inside the modal content
                }
            } else {
                closeModal();
            }
        }
        
        /**
         * Renders only the modal component.
         */
        function renderModal() {
            const modalEl = document.getElementById('modal-container');
            if (!modalEl) return;
            
            if (!appState.modal.isOpen) {
                modalEl.innerHTML = '';
                return;
            }

            const isConfirmType = appState.modal.type === 'confirm';
            const isFormType = appState.modal.type === 'form';
            const isInfoType = appState.modal.type === 'info';
            
            const footerContent = isFormType ? `
                <div id="auth-error-message" class="text-sm text-red-500 font-medium mb-2"></div>
                <!-- Form handled by the content, buttons are outside the form to submit it -->
                <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button type="submit" form="modal-form" class="px-4 py-2 ml-3 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50" ${appState.modal.isConfirming ? 'disabled' : ''}>
                    ${appState.modal.isConfirming ? `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...` : appState.modal.confirmButtonText}
                </button>
            ` : isConfirmType ? `
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button onclick="handleModalConfirm()" class="px-4 py-2 ml-3 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center disabled:opacity-50" ${appState.modal.isConfirming ? 'disabled' : ''}>
                    ${appState.modal.isConfirming ? `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...` : appState.modal.confirmButtonText}
                </button>
            ` : `
                 <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">
                    Close
                </button>
            `;

            modalEl.innerHTML = `
                <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <!-- Background overlay -->
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>

                        <!-- Modal content container -->
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="sm:flex sm:items-start">
                                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900 border-b pb-2 mb-4" id="modal-title">
                                            ${appState.modal.title}
                                        </h3>
                                        <div class="mt-2 text-sm text-gray-500">
                                            ${appState.modal.content}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                ${footerContent}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CRUD Operations for Tasks ---

        /**
         * Opens the modal for creating or editing a task.
         * @param {string | null} taskId - The ID of the task to edit, or null for new task.
         */
        function showTaskModal(taskId = null) {
            let task = appState.data.tasks.find(t => t.id === taskId);

            if (taskId && task) {
                // Editing existing task
                appState.taskForm = {
                    id: task.id,
                    title: task.title || '',
                    siteId: task.siteId || '',
                    description: task.description || '',
                    severity: task.severity || 'Medium',
                    status: task.status || 'Open',
                    dueDate: task.dueDate || '',
                    assignedTo: task.assignedTo || ''
                };
            } else {
                // Creating new task
                appState.taskForm = {
                    id: null,
                    title: '',
                    siteId: '',
                    description: '',
                    severity: 'Medium',
                    status: 'Open',
                    dueDate: '',
                    assignedTo: appState.userId // Default assignment
                };
            }

            openModal(VIEWS.TaskFormView(), taskId ? 'Edit Task' : 'Create New Task', 'form', null, taskId ? 'Save Changes' : 'Create Task');
        }

        /**
         * Handles the submission of the task creation/editing form.
         * @param {Event} e 
         */
        async function handleTaskCreation(e) {
            e.preventDefault();
            if (!db || !appState.userId) return;

            const formData = new FormData(e.target);
            const taskData = Object.fromEntries(formData.entries());

            // Update appState.taskForm with current form values for persistence
            appState.taskForm = { ...appState.taskForm, ...taskData };
            
            // Clean and finalize data for Firestore
            const finalTaskData = {
                ...taskData,
                siteId: taskData.siteId, // Site ID
                severity: taskData.severity,
                status: taskData.status,
                dueDate: taskData.dueDate,
                assignedTo: taskData.assignedTo,
                lastUpdatedBy: appState.userId,
                updatedAt: serverTimestamp()
            };

            appState.modal.isConfirming = true;
            renderModal();
            
            try {
                if (appState.taskForm.id) {
                    // Update existing task
                    const taskRef = doc(db, getPublicCollectionPath('tasks'), appState.taskForm.id);
                    await setDoc(taskRef, finalTaskData, { merge: true });
                } else {
                    // Create new task
                    const tasksColRef = collection(db, getPublicCollectionPath('tasks'));
                    await addDoc(tasksColRef, {
                        ...finalTaskData,
                        createdBy: appState.userId,
                        createdAt: serverTimestamp()
                    });
                }
                closeModal();
                // Optionally navigate back to Dashboard or Task Overview
                navigate('TaskOverview'); 
            } catch (e) {
                console.error("Error saving task:", e);
                // Simple error display for now
                document.getElementById('task-form-error').innerText = "Error saving task. Check console.";
            } finally {
                appState.modal.isConfirming = false;
                renderModal();
            }
        }

        /**
         * Prepares and opens the confirmation modal for task deletion.
         * @param {string} taskId 
         */
        function confirmDeleteTask(taskId) {
            const task = appState.data.tasks.find(t => t.id === taskId);
            if (!task) return;

            const content = `Are you sure you want to delete the task: **${task.title}**? This action cannot be undone.`;
            openModal(
                content,
                'Delete Task',
                'confirm',
                () => deleteTask(taskId),
                'Delete Permanently'
            );
        }

        /**
         * Deletes a task from Firestore.
         * @param {string} taskId 
         */
        async function deleteTask(taskId) {
            if (!db || !taskId) return;
            const taskRef = doc(db, getPublicCollectionPath('tasks'), taskId);
            await deleteDoc(taskRef);
            appState.error = null;
        }

        // --- Render Components (Views, Navigation, Sidebar) ---
        
        // --- VIEW COMPONENT DEFINITION (FIXES THE ORIGINAL ERROR) ---
        // Define VIEWS object globally before any functions that rely on it
        const VIEWS = {};
        
        /**
         * Renders the mobile-friendly sidebar.
         */
        function renderSidebar() {
            const navItems = [
                { name: 'Dashboard', icon: 'layout-dashboard' },
                { name: 'TaskOverview', label: 'Tasks', icon: 'list-checks' },
                { name: 'SiteManagement', label: 'Sites & Assets', icon: 'factory' },
                { name: 'UserManagement', label: 'Users & Roles', icon: 'users' },
            ];

            const navLinks = navItems.map(item => `
                <a href="#" onclick="navigate('${item.name}')" class="flex items-center px-4 py-2 mt-2 text-sm font-medium ${appState.currentView === item.name ? 'bg-indigo-700 text-white shadow-md' : 'text-indigo-200 hover:bg-indigo-600'} transition-colors duration-200 rounded-lg">
                    <i data-lucide="${item.icon}" class="w-5 h-5 mr-3"></i>
                    <span>${item.label || item.name.replace(/([A-Z])/g, ' $1').trim()}</span>
                </a>
            `).join('');

            return `
                <div class="fixed inset-y-0 left-0 w-64 bg-indigo-800 text-white p-4 z-40 sidebar-transition ${appState.sidebarOpen ? 'sidebar-visible' : '-translate-x-full'} md:relative md:translate-x-0 md:flex md:flex-col print-hide shadow-lg">
                    <div class="text-2xl font-bold mb-6 flex items-center justify-between">
                        OT Guardian
                        <button class="md:hidden text-indigo-200 hover:text-white" onclick="toggleSidebar()">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <nav class="flex-1 space-y-2 custom-scrollbar overflow-y-auto">
                        ${navLinks}
                    </nav>
                </div>
            `;
        }

        /**
         * Renders the top navigation bar.
         */
        function renderNav() {
            const userStatus = appState.userId ? 
                (appState.email ? `<i data-lucide="mail" class="w-4 h-4 mr-1"></i> ${appState.email}` : `<i data-lucide="user" class="w-4 h-4 mr-1"></i> Anonymous User`) : 
                'Not Signed In';

            let authButtons = '';
            if (appState.userId && !auth.currentUser.isAnonymous) {
                authButtons = `
                    <button onclick="openModal('You are about to sign out. Are you sure?', 'Sign Out', 'confirm', handleSignOut, 'Yes, Sign Out')" class="ml-4 flex items-center text-sm font-medium text-red-600 hover:text-red-700 transition duration-150">
                        <i data-lucide="log-out" class="w-5 h-5 mr-1"></i>
                        Sign Out
                    </button>
                `;
            } else {
                 authButtons = `
                    <button onclick="openModal(VIEWS.LogInView(), 'Sign In or Register', 'form', handleAuthFormSubmit, 'Submit')" class="ml-4 flex items-center px-3 py-1 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition duration-150">
                        <i data-lucide="log-in" class="w-4 h-4 mr-1"></i>
                        Log In
                    </button>
                `;
            }

            return `
                <header class="flex items-center justify-between p-4 bg-white border-b print-hide shadow-sm">
                    <button class="md:hidden text-gray-600 hover:text-gray-800" onclick="toggleSidebar()">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <div class="hidden md:block text-xl font-semibold text-gray-800">${appState.currentView.replace(/([A-Z])/g, ' $1').trim()}</div>
                    
                    <div class="flex items-center text-gray-600 text-sm">
                        <span class="flex items-center mr-4">
                            ${userStatus}
                        </span>
                        ${authButtons}
                    </div>
                </header>
            `;
        }

        // ---------------------------------------------
        // --- VIEW COMPONENTS (HTML Content Generators) ---
        // ---------------------------------------------

        /**
         * Login/Registration Form View for Modal.
         */
        VIEWS.LogInView = () => {
            return `
                <form id="modal-form" data-form-type="login" onsubmit="handleAuthFormSubmit(event)" class="space-y-4">
                    <p class="text-sm text-gray-700">Please sign in or register to access full application features.</p>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" name="email" required autocomplete="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex justify-between items-center pt-2">
                         <a href="#" onclick="document.getElementById('modal-form').setAttribute('data-form-type', 'register'); document.querySelector('#modal-form button[type=submit]').innerText = 'Register'; document.getElementById('modal-title').innerText = 'Register New Account'; return false;" class="text-sm text-indigo-600 hover:text-indigo-500">
                            Need an account? Register
                        </a>
                        <a href="#" onclick="document.getElementById('modal-form').setAttribute('data-form-type', 'login'); document.querySelector('#modal-form button[type=submit]').innerText = 'Submit'; document.getElementById('modal-title').innerText = 'Sign In or Register'; return false;" class="text-sm text-gray-500 hover:text-gray-700">
                            Already registered? Sign In
                        </a>
                    </div>
                </form>
            `;
        };

        /**
         * Dashboard View.
         */
        VIEWS.DashboardView = () => {
            const openTasks = appState.data.tasks.filter(t => t.status === 'Open').length;
            const highSeverityTasks = appState.data.tasks.filter(t => t.severity === 'High' && t.status === 'Open').length;
            const totalSites = appState.data.sites.length;
            const anonWarning = auth.currentUser && auth.currentUser.isAnonymous ? `
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-lg" role="alert">
                    <p class="font-bold">Anonymous Access</p>
                    <p>You are currently signed in anonymously. To save and secure your data, please <a href="#" onclick="openModal(VIEWS.LogInView(), 'Sign In or Register', 'form', handleAuthFormSubmit, 'Submit')" class="font-medium underline text-yellow-800">Log In or Register</a>.</p>
                </div>
            ` : '';

            // Simple Task Summary Table
            const top5Tasks = appState.data.tasks.slice(0, 5);

            const taskRows = top5Tasks.map(task => {
                const severityColor = task.severity === 'High' ? 'bg-red-500' : task.severity === 'Medium' ? 'bg-yellow-500' : 'bg-green-500';
                return `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="navigate('TaskOverview')">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${severityColor} text-white">
                                ${task.severity}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(task.dueDate).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${appState.data.sites.find(s => s.id === task.siteId)?.name || 'N/A'}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="space-y-6">
                    ${anonWarning}
                    <h1 class="text-3xl font-bold text-gray-900">Security Posture Dashboard</h1>

                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-500">Open Tasks</p>
                                <i data-lucide="list-checks" class="w-6 h-6 text-indigo-500"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${openTasks}</p>
                            <p class="text-sm text-gray-400 mt-2">Currently being remediated</p>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-500">High Severity</p>
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${highSeverityTasks}</p>
                            <p class="text-sm text-gray-400 mt-2">Requiring immediate attention</p>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-500">Total Sites/Assets</p>
                                <i data-lucide="factory" class="w-6 h-6 text-green-500"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${totalSites}</p>
                            <p class="text-sm text-gray-400 mt-2">Across all locations</p>
                        </div>
                    </div>

                    <!-- Recent Tasks Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-900 flex justify-between items-center">
                                Top Priority Tasks
                                <button onclick="navigate('TaskOverview')" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center">
                                    View All
                                    <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                                </button>
                            </h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${taskRows.length > 0 ? taskRows : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No open tasks found.</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        /**
         * Task Overview View.
         */
        VIEWS.TaskOverviewView = () => {
            const tasks = appState.data.tasks;
            
            const taskCards = tasks.map(task => {
                const severityClass = task.severity === 'High' ? 'border-red-500 bg-red-50' : 
                                      task.severity === 'Medium' ? 'border-yellow-500 bg-yellow-50' : 
                                      'border-green-500 bg-green-50';
                const statusColor = task.status === 'Open' ? 'text-red-600' : 
                                    task.status === 'In Progress' ? 'text-yellow-600' : 
                                    'text-green-600';
                const assignedUser = appState.data.users.find(u => u.userId === task.assignedTo);
                const site = appState.data.sites.find(s => s.id === task.siteId);

                return `
                    <div class="bg-white p-5 rounded-xl shadow-md border-t-4 ${severityClass} hover:shadow-lg transition duration-200">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-semibold text-gray-900">${task.title}</h3>
                            <span class="text-xs font-medium ${statusColor}">${task.status}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</p>
                        
                        <div class="mt-4 text-xs space-y-1">
                            <p class="flex items-center text-gray-700">
                                <i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Due: ${new Date(task.dueDate).toLocaleDateString()}
                            </p>
                            <p class="flex items-center text-gray-700">
                                <i data-lucide="factory" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Site: ${site ? site.name : 'N/A'}
                            </p>
                            <p class="flex items-center text-gray-700">
                                <i data-lucide="user-check" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Assigned: ${assignedUser ? assignedUser.email || 'Anonymous' : 'Unassigned'}
                            </p>
                        </div>
                        <div class="mt-4 flex space-x-3">
                            <button onclick="showTaskModal('${task.id}')" class="flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-700">
                                <i data-lucide="edit-3" class="w-4 h-4 mr-1"></i> Edit
                            </button>
                            <button onclick="confirmDeleteTask('${task.id}')" class="flex items-center text-sm font-medium text-red-600 hover:text-red-700">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-gray-900">Task Overview (${tasks.length} Total)</h1>
                        <button onclick="showTaskModal(null)" class="flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> New Task
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar">
                        ${taskCards.length > 0 ? taskCards : '<div class="col-span-full p-10 text-center text-gray-500 bg-white rounded-xl shadow-md">No tasks have been created yet.</div>'}
                    </div>
                </div>
            `;
        };
        
        /**
         * Task Creation/Edit Form View for Modal.
         */
        VIEWS.TaskFormView = () => {
            const form = appState.taskForm;
            const isEdit = !!form.id;

            // Options for select inputs
            const severityOptions = ['Low', 'Medium', 'High'];
            const statusOptions = ['Open', 'In Progress', 'Completed', 'On Hold'];
            const siteOptions = appState.data.sites;
            const assignedUserOptions = appState.data.users.map(u => ({ id: u.userId, label: u.email || `Anonymous: ${u.userId.substring(0, 8)}...` }));
            
            return `
                <form id="modal-form" data-form-type="task" onsubmit="handleTaskCreation(event)" class="space-y-4">
                    <p id="task-form-error" class="text-sm text-red-500 font-medium"></p>
                    
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">Title <span class="text-red-500">*</span></label>
                        <input type="text" id="title" name="title" value="${form.title}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="siteId" class="block text-sm font-medium text-gray-700">Affected Site/Asset <span class="text-red-500">*</span></label>
                        <select id="siteId" name="siteId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Select Site/Asset --</option>
                            ${siteOptions.map(site => 
                                `<option value="${site.id}" ${form.siteId === site.id ? 'selected' : ''}>${site.name} (${site.type})</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Description <span class="text-red-500">*</span></label>
                        <textarea id="description" name="description" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">${form.description}</textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="severity" class="block text-sm font-medium text-gray-700">Severity <span class="text-red-500">*</span></label>
                            <select id="severity" name="severity" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                ${severityOptions.map(opt => 
                                    `<option value="${opt}" ${form.severity === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status <span class="text-red-500">*</span></label>
                            <select id="status" name="status" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                ${statusOptions.map(opt => 
                                    `<option value="${opt}" ${form.status === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="dueDate" class="block text-sm font-medium text-gray-700">Due Date <span class="text-red-500">*</span></label>
                            <input type="date" id="dueDate" name="dueDate" value="${form.dueDate}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="assignedTo" class="block text-sm font-medium text-gray-700">Assigned To <span class="text-red-500">*</span></label>
                            <select id="assignedTo" name="assignedTo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Select User --</option>
                                ${assignedUserOptions.map(user => 
                                    `<option value="${user.id}" ${form.assignedTo === user.id ? 'selected' : ''}>${user.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                </form>
            `;
        };

        /**
         * Site Management View (Stub for future implementation).
         */
        VIEWS.SiteManagementView = () => {
             const siteRows = appState.data.sites.map(site => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${site.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900">Edit</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-gray-900">Sites & Asset Management (${appState.data.sites.length} Total)</h1>
                        <button class="flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> New Site
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${siteRows.length > 0 ? siteRows : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No sites/assets defined.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        /**
         * User Management View (Stub for future implementation).
         */
        VIEWS.UserManagementView = () => {
            const userRows = appState.data.users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.email || user.userId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role || 'Analyst'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.userId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900">Edit Role</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <h1 class="text-3xl font-bold text-gray-900">User & Role Management (${appState.data.users.length} Total)</h1>
                    
                    <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID / Email</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full User ID</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${userRows.length > 0 ? userRows : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No user profiles found.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };


        // --- Expose global functions for inline handlers ---
        window.navigate = navigate;
        window.toggleSidebar = toggleSidebar;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.handleModalConfirm = handleModalConfirm;
        window.handleSignOut = handleSignOut;
        window.handleAuthFormSubmit = handleAuthFormSubmit;
        window.showTaskModal = showTaskModal;
        window.handleTaskCreation = handleTaskCreation;
        window.confirmDeleteTask = confirmDeleteTask;
        window.VIEWS = VIEWS; // Ensure VIEWS is also available globally


        // --- Initialization ---
        window.onload = function () {
            // Append modal container to the body once
            const modalContainer = document.createElement('div');
            modalContainer.id = 'modal-container';
            document.body.appendChild(modalContainer);
            
            try {
                // Initialize using the configuration
                const app = initializeApp(MANUAL_FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                appState.isFirebaseReady = true;
                appState.appId = MANUAL_FIREBASE_CONFIG.projectId;
                
                // Set up auth listener (this updates appState.isAuthReady and calls render/data listeners)
                onAuthStateChanged(auth, updateAuthState);

                // Start the sign-in process
                attemptCustomTokenSignIn();

            } catch (e) {
                console.error("Fatal Firebase Initialization Error:", e);
                appState.error = "Fatal Firebase Error: Check console for configuration details or missing imports.";
                appState.isAuthReady = true;
                appState.isFirebaseReady = false;
                render();
            }
        };

    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div id="app">
        <!-- Content generated by render() -->
    </div>
</body>
</html>
