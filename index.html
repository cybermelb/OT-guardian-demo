<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian Production Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
        FIREBASE SDK LOADING (UMD/Compat) - Essential for Vanilla JS
    -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Custom styles */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #A5B4FC; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #E0E7FF; }
        .error-pre { white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto; }

        /* Status colors */
        .status-high { background-color: #FEE2E2; color: #DC2626; }
        .status-medium { background-color: #FEF3C7; color: #D97706; }
        .status-low { background-color: #D1FAE5; color: #059669; }
        .status-online { background-color: #D1FAE5; color: #059669; }
        .status-offline { background-color: #E5E7EB; color: #4B5563; }
        .status-warning { background-color: #FEF3C7; color: #D97706; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">
        <!-- Initial loading message -->
        <div id="loading-initial" class="text-center p-12 text-gray-500 flex flex-col items-center">
            <svg class="w-8 h-8 animate-spin-slow text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
            <p>Initializing OT Guardian services...</p>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIGURATION ---
        const appContainer = document.getElementById('app-container');

        // Global Firebase instances
        let fbApp, auth, db;
        let authUser = null;
        let currentView = 'overview';
        let currentUserId = null;
        let currentUserEmail = 'N/A';
        
        // Data State
        let risks = [];
        let assets = [];
        let deploymentStatus = null;

        // --- CONSTANTS & UTILITIES ---
        
        const ADMIN_EMAIL = 'cybermelb@gmail.com';
        const ENGINEER_EMAIL = 'faysalhasan2001@yahoo.com';

        const ICONS = {
            Shield: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
            LogOut: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            Loader: `<svg class="w-5 h-5 mr-2 animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`,
            Mail: `<svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 w-5 h-5 text-gray-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>`,
            Lock: `<svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 w-5 h-5 text-gray-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
            Key: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18 16 4l3 3 7 7-3 3-3-3zM2 18l3-3 7 7-3 3zM16 4l-3 3-7 7 3-3z"></path><circle cx="16" cy="4" r="2"></circle><circle cx="5" cy="15" r="2"></circle></svg>`,
            UserPlus: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>`,
            AlertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2 flex-shrink-0" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/></svg>`,
            BarChart2: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
            Target: `<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
            Zap: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
            Cpu: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><polyline points="9 9 15 9 15 15 9 15 9 9"></polyline><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="15" x2="23" y2="15"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="15" x2="4" y2="15"></line></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.68"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            HardHat: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11h-1.5a1.5 1.5 0 0 1 0-3H19a1.5 1.5 0 0 1 0 3z"/><path d="M12 19V9l6.3-2.61a1.68 1.68 0 0 0-.6-3.2l-5.6-2.58a1.68 1.68 0 0 0-2.6 1.3V5h-.48a.48.48 0 0 0-.48.48V7.5l-2 1.5V11h4v4h-4v4h4v3.5a.5.5 0 0 0 1 0V19z"/></svg>`,
            User: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            Users: `<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            Plus: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
        };

        const checkAdminAccess = () => currentUserEmail === ADMIN_EMAIL;
        
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.seconds) return 'N/A';
            return new Date(timestamp.seconds * 1000).toLocaleString();
        };

        const getStatusStyles = (status) => {
            switch (status) {
                case 'High': return 'bg-red-100 text-red-800';
                case 'Medium': return 'bg-yellow-100 text-yellow-800';
                case 'Low': return 'bg-green-100 text-green-800';
                case 'Online': return 'bg-green-100 text-green-800';
                case 'Warning': return 'bg-yellow-100 text-yellow-800';
                case 'Offline': return 'bg-gray-200 text-gray-700';
                case 'Compliant': return 'bg-green-100 text-green-800';
                case 'Non-Compliant': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-600';
            }
        };

        // --- FIREBASE DATA MANAGEMENT ---

        let unsubscribeListeners = [];

        const getPublicCollectionRef = (collectionName) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return db ? db.collection(`artifacts/${appId}/public/data/${collectionName}`) : null;
        };
        
        const setupDataListeners = () => {
            if (!db) return;

            // Clear previous listeners
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const createListener = (collectionName, stateSetter) => {
                const colRef = getPublicCollectionRef(collectionName);
                if (colRef) {
                    const unsubscribe = colRef.onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Sort by creation time (descending)
                        data.sort((a, b) => {
                            const timeA = a.createdAt?.seconds || 0;
                            const timeB = b.createdAt?.seconds || 0;
                            return timeB - timeA;
                        });
                        stateSetter(data);
                        renderApp(); // Re-render the app on data change
                    }, (error) => {
                        console.error(`Error listening to ${collectionName}:`, error);
                    });
                    unsubscribeListeners.push(unsubscribe);
                }
            };
            
            // Set up state setters
            const setAssetsState = (data) => { assets = data; };
            const setRisksState = (data) => { risks = data; };
            const setDeploymentStatusState = (data) => { 
                // Status is a single document, so we look for the first (or specific) one
                deploymentStatus = data[0]; 
            };

            createListener('assets', setAssetsState);
            createListener('risks', setRisksState);
            createListener('status', setDeploymentStatusState); 
            
            // Initial Status document creation (if not exists)
            const statusDocRef = getPublicCollectionRef('status')?.doc('current');
            if (statusDocRef) {
                statusDocRef.get().then(docSnapshot => {
                    if (!docSnapshot.exists) {
                        const defaultStatus = { 
                            status: 'Online', 
                            description: 'All OT Guardian services are operational.',
                            lastCheck: firebase.firestore.FieldValue.serverTimestamp() 
                        };
                        statusDocRef.set(defaultStatus, { merge: true })
                            .catch(e => console.error("Error setting initial status:", e));
                        deploymentStatus = defaultStatus;
                    }
                }).catch(e => console.error("Error checking initial status:", e));
            }
        };

        const createAsset = async (name, type, criticality, location) => {
            if (!db || !currentUserId) return false;
            try {
                const assetData = {
                    name,
                    type,
                    criticality,
                    location,
                    status: 'Active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserEmail
                };
                const colRef = getPublicCollectionRef('assets');
                await colRef.add(assetData);
                return true;
            } catch (error) {
                console.error("Error creating asset:", error);
                return false;
            }
        };

        const deleteAsset = async (assetId) => {
            if (!db || !checkAdminAccess()) return false;
            try {
                const docRef = getPublicCollectionRef('assets').doc(assetId);
                await docRef.delete();
                return true;
            } catch (error) {
                console.error("Error deleting asset:", error);
                return false;
            }
        };


        // --- UI RENDERING CORE FUNCTIONS ---
        
        /** Renders a standard Tailwind card. */
        const renderCard = (content, title = '', className = '') => `
            <div class="p-5 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow ${className}">
                ${title ? `<h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>` : ''}
                ${content}
            </div>
        `;

        /** Renders an error box. */
        const renderErrorBox = (message) => `
            <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm flex items-start">
                ${ICONS.AlertTriangle}
                <span class="break-words whitespace-pre-wrap">${message}</span>
            </div>
        `;

        const renderLoadingScreen = (message, isError = false) => {
            const color = isError ? 'text-red-500' : 'text-indigo-500';
            const icon = isError ? ICONS.AlertTriangle : ICONS.Loader;
            appContainer.innerHTML = `
                <div class="text-center p-12 text-gray-500 flex flex-col items-center">
                    ${icon.replace('class="', `class="w-8 h-8 animate-spin-slow mb-4 ${color}`)}
                    <p class="text-lg font-semibold ${color}">${message}</p>
                </div>
            `;
        };
        
        // --- AUTHENTICATION VIEW ---
        
        const renderAuthGate = (authError = null, isLoading = false, isRegistering = false, initError = null) => {
            if (initError) {
                const content = `
                    <h2 class="text-xl font-bold text-red-700 mb-2">FIREBASE CONFIGURATION ERROR</h2>
                    <p class="text-gray-600 text-sm text-left">
                        **Details:** <span class="text-red-600 font-semibold">${initError.title}</span>
                    </p>
                    <p class="text-gray-600 whitespace-pre-wrap text-sm text-left font-mono bg-red-50 p-3 rounded-lg mt-2 error-pre">
                        **Raw Config Received:** <pre class="text-xs font-mono">${initError.rawInput}</pre>
                    </p>
                    <p class="mt-4 text-sm text-gray-700 text-left">
                        **Action Required:** Ensure the environment variable (e.g., <code class="font-bold text-black">__firebase_config</code>) is a valid, unescaped JSON string.
                    </p>
                `;
                appContainer.innerHTML = `<div class="w-full max-w-xl p-8 text-center border-red-500 border-2">${renderCard(content, 'Critical Error', 'border-t-4 border-red-500')}</div>`;
                return;
            }

            const submitButtonText = isRegistering ? 'Register Account' : 'Sign In';
            const switchLinkText = isRegistering ? 'Already have an account? Sign In' : 'Don\'t have an account? Register';
            const submitIcon = isRegistering ? ICONS.UserPlus : ICONS.Key;

            const content = `
                ${authError ? renderErrorBox(authError) : ''}
                <form id="auth-form" onsubmit="handleAuth(event, ${isRegistering})">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="email">Email Address</label>
                        <div class="relative flex items-center">
                            ${ICONS.Mail}
                            <input
                                type="email"
                                id="email"
                                name="email"
                                required
                                placeholder="Admin: ${ADMIN_EMAIL} | Engineer: ${ENGINEER_EMAIL}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 pl-10"
                            />
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label>
                        <div class="relative flex items-center">
                            ${ICONS.Lock}
                            <input
                                type="password"
                                id="password"
                                name="password"
                                required
                                placeholder="minimum 6 characters"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 pl-10"
                            />
                        </div>
                    </div>

                    <button
                        type="submit"
                        id="auth-submit-btn"
                        class="w-full mt-6 flex items-center justify-center px-4 py-2 font-semibold text-sm rounded-lg transition-all duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 ${isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'}"
                        ${isLoading ? 'disabled' : ''}
                    >
                        ${isLoading ? ICONS.Loader : submitIcon}
                        ${submitButtonText}
                    </button>
                </form>

                <p class="mt-6 text-center text-sm text-gray-600">
                    <button
                        onclick="toggleAuthMode(${!isRegistering})"
                        class="font-semibold text-indigo-600 hover:text-indigo-800"
                    >
                        ${switchLinkText}
                    </button>
                </p>
            `;
            appContainer.innerHTML = `<div class="w-full max-w-md">${renderCard(content, 'OT Guardian Login', 'border-t-4 border-indigo-500')}</div>`;
        };
        
        // --- AUTH LOGIC (Functions exposed to global scope for button clicks) ---
        
        const handleAuth = async (e, isRegistering) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const btn = document.getElementById('auth-submit-btn');
            btn.innerHTML = `${ICONS.Loader} Authenticating...`;
            btn.disabled = true;

            try {
                if (isRegistering) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (err) {
                let msg = err.code || err.message || 'An unknown error occurred.';
                if (err.code) {
                    msg = err.code.replace('auth/', '').replace(/-/g, ' ');
                    msg = msg.charAt(0).toUpperCase() + msg.slice(1);
                }
                renderAuthGate(msg, false, isRegistering);
            }
        };

        const handleLogout = async () => {
            if (auth) {
                try {
                    await auth.signOut();
                    // AuthStateChanged listener will handle the re-render
                } catch (error) {
                    console.error("Error during sign out:", error);
                }
            }
        };

        const toggleAuthMode = (newMode) => {
            renderAuthGate(null, false, newMode);
        };
        
        const setView = (viewName) => {
            currentView = viewName;
            renderApp();
        };

        // --- DASHBOARD VIEW RENDERING ---

        const renderHeader = () => `
            <header class="flex justify-between items-center p-4 border-b bg-indigo-800 text-white rounded-t-xl">
                <h1 class="text-2xl font-bold flex items-center">
                    ${ICONS.Shield} OT Guardian Deployment
                </h1>
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium opacity-80 hidden sm:inline">
                        ${currentUserEmail} ${checkAdminAccess() ? '(Admin)' : '(Engineer)'}
                    </span>
                    <button 
                        onclick="handleLogout()"
                        class='p-2 bg-indigo-700 hover:bg-indigo-600 rounded-full transition duration-150 shadow-md'
                        aria-label="Log Out"
                        title="Log Out"
                    >
                        ${ICONS.LogOut}
                    </button>
                </div>
            </header>
        `;

        const renderNavBar = () => {
            const navItems = [
                { view: 'overview', label: 'Overview', icon: ICONS.BarChart2 },
                { view: 'assetBuilder', label: 'Asset Builder', icon: ICONS.Cpu },
                { view: 'riskDashboard', label: 'Risk Dashboard', icon: ICONS.Shield },
                { view: 'securityControls', label: 'Compliance Checks', icon: ICONS.CheckCircle },
                { view: 'remediationTasks', label: 'Remediation Tasks', icon: ICONS.HardHat },
            ];
            
            if (checkAdminAccess()) {
                navItems.push({ view: 'admin', label: 'Admin Panel', icon: ICONS.User });
            }

            const buttons = navItems.map(item => `
                <button
                    onclick="setView('${item.view}')"
                    class="flex items-center px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-150 ${
                        currentView === item.view ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-700 hover:bg-indigo-100'
                    }"
                >
                    ${item.icon}
                    ${item.label}
                </button>
            `).join('');

            return `
                <nav class="flex space-x-1 p-3 border-b bg-gray-50 overflow-x-auto whitespace-nowrap custom-scrollbar">
                    ${buttons}
                </nav>
            `;
        };

        const renderStatusBar = () => {
            const status = deploymentStatus?.status || 'Offline';
            const isOnline = status === 'Online';
            const statusClass = isOnline ? 'bg-green-100 text-green-800' : 
                                status === 'Warning' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
            const lastCheck = formatTimestamp(deploymentStatus?.lastCheck);

            return `
                <div class="p-3 text-sm font-semibold rounded-xl text-center shadow-inner mx-4 mt-4 ${statusClass}">
                    ${ICONS.Zap}
                    Deployment Status: ${status} | 
                    Last Check: ${lastCheck}
                </div>
            `;
        };
        
        // --- MAIN VIEW RENDERS ---

        const renderOverview = () => {
            const totalAssets = assets.length;
            const highRiskCount = risks.filter(r => r.severity === 'High').length;
            const criticalAssets = assets.filter(a => a.criticality === 'High').length;
            const onlineStatus = deploymentStatus?.status === 'Online';

            const cardData = [
                { title: 'Total Assets', value: totalAssets, icon: ICONS.Cpu.replace('class="w-4 h-4 mr-2"', 'class="w-8 h-8 mb-2"'), border: 'border-indigo-500' },
                { title: 'High Severity Risks', value: highRiskCount, icon: ICONS.AlertTriangle.replace('w-4 h-4 mr-2 flex-shrink-0', 'w-8 h-8 mb-2'), border: 'border-red-500', iconColor: 'text-red-500' },
                { title: 'Critical Assets', value: criticalAssets, icon: ICONS.Target.replace('class="w-8 h-8"', 'class="w-8 h-8 mb-2"'), border: 'border-yellow-500', iconColor: 'text-yellow-500' },
                { title: 'System Status', value: deploymentStatus?.status || 'Offline', icon: ICONS.Zap.replace('class="w-4 h-4 mr-1"', `class="w-8 h-8 mb-2 ${onlineStatus ? 'text-green-500' : 'text-gray-400'}"`), border: onlineStatus ? 'border-green-500' : 'border-gray-400', valueColor: onlineStatus ? 'text-green-700' : 'text-gray-700' },
            ];

            const renderSummaryTable = (data, title, columns, statusKey) => {
                const head = columns.map(c => `<th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">${c}</th>`).join('');
                const rows = data.slice(0, 5).map(item => {
                    const statusClass = getStatusStyles(item[statusKey] || item.criticality || item.severity);
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.name || item.risk || item.control}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${item.type || item.impact || item.complianceStandard}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${item[statusKey] || item.criticality || item.severity}
                                </span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${item.location || item.asset || item.lastCheck}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50"><tr>${head}</tr></thead>
                            <tbody class="bg-white divide-y divide-gray-100">${rows}</tbody>
                        </table>
                    </div>
                `;
            };

            const riskCols = ['Risk', 'Impact', 'Severity', 'Affected Asset'];
            const assetCols = ['Name', 'Type', 'Criticality', 'Location'];

            const content = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">OT Security Overview</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    ${cardData.map(d => `
                        <div class="p-5 bg-white rounded-xl shadow-lg border-t-4 ${d.border}">
                            <div class="flex items-start justify-between">
                                <span class="${d.iconColor || 'text-indigo-500'}">${d.icon}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">${d.title}</p>
                            <p class="text-3xl font-bold ${d.valueColor || 'text-gray-900'}">${d.value}</p>
                        </div>
                    `).join('')}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${renderCard(
                        assets.length > 0 ? renderSummaryTable(assets, 'Asset', assetCols, 'criticality') : `<p class="text-gray-500">No assets registered yet.</p>`,
                        "Top 5 Assets by Criticality"
                    )}
                    ${renderCard(
                        risks.length > 0 ? renderSummaryTable(risks, 'Risk', riskCols, 'severity') : `<p class="text-gray-500">No risks identified yet.</p>`,
                        "Top 5 High/Medium Risks"
                    )}
                </div>
            `;
            return content;
        };

        const renderAssetBuilder = () => {
            const handleSubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const success = await createAsset(
                    form.assetName.value,
                    form.assetType.value,
                    form.criticality.value,
                    form.location.value
                );
                
                let message = success ? 'Asset successfully added!' : 'Failed to add asset. Check console for errors.';
                let color = success ? 'green' : 'red';
                
                alertUser(message, color); // Use custom alert
                if (success) {
                    form.reset();
                }
            };
            
            const renderAssetForm = () => `
                <form onsubmit="handleSubmitWrapper(event)" class="space-y-4" id="asset-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Asset Name</label>
                            <input type="text" name="assetName" required placeholder="PLC-01-A" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Asset Type</label>
                            <select name="assetType" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select Type</option>
                                <option value="PLC">PLC (Programmable Logic Controller)</option>
                                <option value="HMI">HMI (Human-Machine Interface)</option>
                                <option value="Historian">Historian Server</option>
                                <option value="Firewall">Industrial Firewall</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Criticality</label>
                            <select name="criticality" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="High">High (Direct impact on safety/production)</option>
                                <option value="Medium">Medium (Impact on quality/efficiency)</option>
                                <option value="Low">Low (Informational/Support)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Location</label>
                            <input type="text" name="location" required placeholder="Assembly Line 1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <button type="submit" class="flex items-center justify-center bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                        ${ICONS.Plus} Add Asset
                    </button>
                </form>
            `;

            const renderAssetList = () => {
                if (assets.length === 0) return `<p class="text-gray-500 mt-4">No assets have been registered yet.</p>`;

                const tableRows = assets.map(asset => {
                    const statusClass = getStatusStyles(asset.criticality);
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${asset.name}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${asset.type}</td>
                            <td class="px-3 py-2 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${asset.criticality}</span></td>
                            <td class="px-3 py-2 text-sm text-gray-500">${asset.location}</td>
                            ${checkAdminAccess() ? `
                                <td class="px-3 py-2 text-sm text-right">
                                    <button onclick="handleDeleteAsset('${asset.id}', '${asset.name}')" class="text-red-600 hover:text-red-900 text-sm font-medium">Delete</button>
                                </td>
                            ` : '<td></td>'}
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="mt-8 overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Name</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Type</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Criticality</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Location</th>
                                    ${checkAdminAccess() ? '<th class="px-3 py-2 text-right text-xs font-medium text-indigo-700 uppercase">Actions</th>' : '<th></th>'}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            };
            
            // Expose asset submission globally for form to call
            window.handleSubmitWrapper = handleSubmit;
            
            return `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Industrial Asset Builder</h2>
                ${renderCard(renderAssetForm(), "Register New Asset", "mb-6")}
                ${renderCard(renderAssetList(), "Registered Assets")}
            `;
        };

        const handleDeleteAsset = (assetId, assetName) => {
            showModal({
                title: 'Confirm Asset Deletion',
                message: `Are you sure you want to permanently delete the asset: ${assetName}? This action cannot be undone.`,
                confirmAction: async () => {
                    const success = await deleteAsset(assetId);
                    alertUser(success ? `Asset ${assetName} deleted.` : `Failed to delete asset ${assetName}.`, success ? 'green' : 'red');
                    // Re-render handled by listener
                    hideModal();
                },
                cancelAction: hideModal
            });
        };
        
        const renderRiskDashboard = () => {
            const highRisks = risks.filter(r => r.severity === 'High');
            const mediumRisks = risks.filter(r => r.severity === 'Medium');
            const lowRisks = risks.filter(r => r.severity === 'Low');
            
            const totalRisks = risks.length;

            const renderRiskList = (list, title, color) => {
                if (list.length === 0) return `<p class="text-gray-500 italic">No ${title} risks currently identified.</p>`;
                
                const items = list.map(r => `
                    <li class="p-3 mb-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-900">${r.risk}</p>
                            <p class="text-sm text-gray-500">Asset: ${r.asset || 'N/A'} | Impact: ${r.impact}</p>
                        </div>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${getStatusStyles(r.severity)}">${r.severity}</span>
                    </li>
                `).join('');

                return `
                    <h4 class="text-lg font-bold mt-4 mb-2 text-${color}-700">${title} (${list.length})</h4>
                    <ul class="space-y-2">${items}</ul>
                `;
            };

            const content = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">OT Risk Management Dashboard</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    ${renderCard(`
                        <p class="text-sm text-gray-500">Total Risks</p>
                        <p class="text-4xl font-extrabold text-gray-900">${totalRisks}</p>
                    `, 'Risk Summary', 'border-t-4 border-indigo-500')}
                    ${renderCard(`
                        <p class="text-sm text-gray-500">High Risks</p>
                        <p class="text-4xl font-extrabold text-red-600">${highRisks.length}</p>
                    `, 'Focus Area', 'border-t-4 border-red-500')}
                    ${renderCard(`
                        <p class="text-sm text-gray-500">Remediation Tasks</p>
                        <p class="text-4xl font-extrabold text-indigo-600">5</p>
                    `, 'Active Tasks', 'border-t-4 border-indigo-500')}
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    ${renderCard(renderRiskList(highRisks, 'High Severity Risks', 'red'), "High Risks")}
                    ${renderCard(renderRiskList(mediumRisks, 'Medium Severity Risks', 'yellow'), "Medium Risks")}
                    ${renderCard(renderRiskList(lowRisks, 'Low Severity Risks', 'green'), "Low Risks")}
                </div>
            `;
            return content;
        };

        const renderSecurityControls = () => {
            const controls = [
                { id: 1, control: 'Perimeter Segmentation (IEC 62443)', status: 'Compliant', lastCheck: '2023-12-01', complianceStandard: 'IEC 62443' },
                { id: 2, control: 'Endpoint Hardening (Critical Assets)', status: 'Non-Compliant', lastCheck: '2023-11-28', complianceStandard: 'NIST 800-82' },
                { id: 3, control: 'Password Complexity Policy', status: 'Compliant', lastCheck: '2023-12-01', complianceStandard: 'Company Policy' },
                { id: 4, control: 'Remote Access VPN/MFA', status: 'Compliant', lastCheck: '2023-12-01', complianceStandard: 'IEC 62443' },
                { id: 5, control: 'Network Monitoring Coverage', status: 'Warning', lastCheck: '2023-11-29', complianceStandard: 'NIST 800-82' },
            ];

            const totalControls = controls.length;
            const compliantCount = controls.filter(c => c.status === 'Compliant').length;
            const nonCompliantCount = controls.filter(c => c.status === 'Non-Compliant').length;
            const warningCount = controls.filter(c => c.status === 'Warning').length;

            const renderComplianceTable = () => {
                const tableRows = controls.map(c => {
                    const statusClass = getStatusStyles(c.status);
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${c.control}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${c.complianceStandard}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${c.lastCheck}</td>
                            <td class="px-3 py-2 text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${c.status}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="mt-4 overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Control Check</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Standard</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Last Check</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            const content = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Compliance Checks & Security Controls</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    ${renderCard(`
                        <p class="text-sm text-gray-500">Total Controls</p>
                        <p class="text-4xl font-extrabold text-gray-900">${totalControls}</p>
                    `, 'Control Summary', 'border-t-4 border-indigo-500')}
                    ${renderCard(`
                        <p class="text-sm text-gray-500">Compliant</p>
                        <p class="text-4xl font-extrabold text-green-600">${compliantCount}</p>
                    `, 'Success', 'border-t-4 border-green-500')}
                    ${renderCard(`
                        <p class="text-sm text-gray-500">Non-Compliant/Warning</p>
                        <p class="text-4xl font-extrabold text-red-600">${nonCompliantCount + warningCount}</p>
                    `, 'Action Needed', 'border-t-4 border-red-500')}
                </div>
                
                ${renderCard(renderComplianceTable(), "Control Checklist", "p-6")}
            `;
            return content;
        };

        const renderRemediationTasks = () => {
             const tasks = [
                { id: 1, task: 'Patch firmware on all HMI devices.', status: 'In Progress', priority: 'High', assignedTo: 'Faysal', dueDate: '2023-12-15' },
                { id: 2, task: 'Implement MFA for remote access.', status: 'To Do', priority: 'High', assignedTo: 'Admin', dueDate: '2023-12-30' },
                { id: 3, task: 'Segment Historian Network.', status: 'Completed', priority: 'Medium', assignedTo: 'Faysal', dueDate: '2023-11-20' },
                { id: 4, task: 'Review network policies.', status: 'To Do', priority: 'Low', assignedTo: 'Admin', dueDate: '2024-01-15' },
            ];

            const renderTaskList = () => {
                const tableRows = tasks.map(t => {
                    const priorityClass = getStatusStyles(t.priority);
                    const statusClass = t.status === 'Completed' ? 'bg-green-100 text-green-800' : t.status === 'In Progress' ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-600';
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${t.task}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${t.assignedTo}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${t.dueDate}</td>
                            <td class="px-3 py-2 text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${priorityClass}">
                                    ${t.priority}
                                </span>
                            </td>
                            <td class="px-3 py-2 text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${t.status}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="mt-4 overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Task Description</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Assigned To</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Due Date</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Priority</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            const content = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Remediation and Action Items</h2>
                ${renderCard(renderTaskList(), "Active Remediation Tasks", "p-6")}
                <p class="mt-4 text-sm text-gray-600 italic">Note: These tasks are based on identified risks and compliance gaps.</p>
            `;
            return content;
        };

        const renderAdminPanel = () => {
            if (!checkAdminAccess()) {
                return `<div class="text-center p-12 bg-red-50 rounded-xl shadow-lg">
                    ${ICONS.AlertTriangle.replace('w-4 h-4', 'w-10 h-10')}
                    <h2 class="text-2xl font-bold text-red-700 mt-4">Access Denied</h2>
                    <p class="text-gray-600 mt-2">You must be logged in as the Admin (${ADMIN_EMAIL}) to access this panel.</p>
                </div>`;
            }

            const users = [
                { id: 1, email: ADMIN_EMAIL, role: 'Admin', lastLogin: '1 minute ago' },
                { id: 2, email: ENGINEER_EMAIL, role: 'Engineer', lastLogin: '5 minutes ago' },
                { id: 3, email: 'guest@example.com', role: 'Viewer', lastLogin: '1 day ago' },
            ];

            const renderUserTable = () => {
                 const tableRows = users.map(u => `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${u.email}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${u.role}</td>
                            <td class="px-3 py-2 text-sm text-gray-500">${u.lastLogin}</td>
                        </tr>
                    `).join('');

                return `
                    <div class="mt-4 overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">User Email</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Role</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Last Login</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            const content = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Admin & System Management Panel</h2>
                
                ${renderCard(`
                    <p class="text-sm text-gray-500">System is stable. Control data access and user roles here.</p>
                    <div class="flex items-center space-x-4 mt-4">
                        <button class="flex items-center bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                            ${ICONS.Users.replace('w-8 h-8', 'w-5 h-5')} Manage Roles
                        </button>
                        <button class="flex items-center bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition duration-150 shadow-md">
                            System Logs
                        </button>
                    </div>
                `, 'System Health', 'mb-6 border-t-4 border-green-500')}

                ${renderCard(renderUserTable(), "User Roles and Access")}
            `;
            return content;
        };

        const renderMainContent = () => {
            switch (currentView) {
                case 'overview': return renderOverview();
                case 'assetBuilder': return renderAssetBuilder();
                case 'riskDashboard': return renderRiskDashboard();
                case 'securityControls': return renderSecurityControls();
                case 'remediationTasks': return renderRemediationTasks();
                case 'admin': return renderAdminPanel();
                default: return renderOverview();
            }
        };

        // --- MASTER RENDER FUNCTION ---

        const renderApp = () => {
            if (!authUser) {
                renderAuthGate();
                return;
            }

            const mainHtml = `
                <div class="w-full max-w-6xl bg-white shadow-xl rounded-xl mt-6 mb-6">
                    ${renderHeader()}
                    ${renderNavBar()}
                    ${renderStatusBar()}
                    <main class="p-4 md:p-6">
                        ${renderMainContent()}
                    </main>
                </div>
            `;
            appContainer.innerHTML = mainHtml;
        };
        
        // --- MODAL / ALERT IMPLEMENTATION (Replacing window.alert/confirm) ---

        const alertUser = (message, type = 'blue') => {
            // Simple notification system
            const colorMap = {
                green: 'bg-green-500',
                red: 'bg-red-500',
                blue: 'bg-blue-500'
            };
            const bar = document.createElement('div');
            bar.className = `fixed top-4 right-4 p-3 rounded-lg shadow-xl text-white ${colorMap[type]} transition-opacity duration-300`;
            bar.style.opacity = '1';
            bar.textContent = message;
            document.body.appendChild(bar);
            
            setTimeout(() => {
                bar.style.opacity = '0';
                setTimeout(() => bar.remove(), 300);
            }, 3000);
        };
        
        const showModal = ({ title, message, confirmAction, cancelAction }) => {
            // Modal backdrop
            let backdrop = document.getElementById('custom-modal-backdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'custom-modal-backdrop';
                backdrop.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity';
                document.body.appendChild(backdrop);
            }
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform';
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold text-gray-900 mb-3">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 hover:bg-gray-300 transition">Cancel</button>
                    <button id="modal-confirm" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Confirm</button>
                </div>
            `;
            
            backdrop.innerHTML = '';
            backdrop.appendChild(modalContent);
            
            document.getElementById('modal-cancel').onclick = cancelAction;
            document.getElementById('modal-confirm').onclick = confirmAction;
        };

        const hideModal = () => {
            const backdrop = document.getElementById('custom-modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        };


        // --- FIREBASE INITIALIZATION ---

        const initializeFirebase = () => {
            const fb = window.firebase;

            if (typeof fb === 'undefined' || typeof fb.initializeApp !== 'function') {
                renderLoadingScreen('Firebase SDK failed to load. Check CDN access.', true);
                return;
            }

            let rawConfig = 'N/A';
            let firebaseConfig = {};
            
            try {
                // Config Parsing
                rawConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                let cleanedConfig = rawConfig.trim();
                
                // Robust string unescaping
                if ((cleanedConfig.startsWith('"') && cleanedConfig.endsWith('"')) || (cleanedConfig.startsWith("'") && cleanedConfig.endsWith("'"))) {
                    cleanedConfig = cleanedConfig.substring(1, cleanedConfig.length - 1);
                }
                
                firebaseConfig = JSON.parse(cleanedConfig);

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error(`Invalid Config: Missing 'apiKey' or empty.`);
                }
            } catch (e) {
                renderAuthGate(null, false, false, { title: `Config Parsing Failed: ${e.message}`, rawInput: rawConfig });
                return;
            }

            try {
                // Service Initialization
                fbApp = fb.initializeApp(firebaseConfig);
                auth = fb.auth(fbApp);
                db = fb.firestore(fbApp);
                db.settings({ experimentalForceLongPolling: true });
                fb.firestore.setLogLevel('debug');
                
                // Auth Listener
                auth.onAuthStateChanged((user) => {
                    authUser = user;
                    if (user) {
                        currentUserId = user.uid;
                        currentUserEmail = user.email || 'N/A';
                        setupDataListeners(); // Start listening to data once authenticated
                        renderApp();
                    } else {
                        currentUserId = null;
                        currentUserEmail = 'N/A';
                        unsubscribeListeners.forEach(unsub => unsub()); // Stop listening when logged out
                        unsubscribeListeners = [];
                        renderApp();
                    }
                });

            } catch (e) {
                renderLoadingScreen(`Initialization Error: ${e.message}`, true);
            }
        };

        // Start the application lifecycle
        window.onload = initializeFirebase;
    </script>
</body>
</html>
