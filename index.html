<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Guardian App </title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Load Lucide Icons (Vanilla JS Friendly SVG icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Print/PDF Optimization -->
    <style>
        @media print {
            .print-hide { display: none !important; }
            .print-full { max-width: none !important; margin: 0 !important; padding: 0 !important; }
            body, .bg-gray-100 { background-color: white !important; }
            .table-responsive td, .table-responsive th { white-space: normal !important; }
        }
    </style>

    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase services globally for Vanilla JS to use
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel };
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-[Inter]">
    <!-- This is the container where the Vanilla JS app will render -->
    <div id="root" class="min-h-screen"></div>

    <script>
        // --- GLOBAL APP STATE ---
        const appState = {
            currentView: 'riskDashboard',
            isAuthenticated: false,
            isAuthReady: false,
            isFirebaseReady: false,
            userId: null,
            userRole: 'Engineer', // Default role
            data: { assets: [], controls: [], risks: [], tasks: [] },
            deploymentStatus: { status: 'Unknown', message: 'Initializing...', lastCheck: null },
            error: null,
            db: null,
            auth: null,
            appId: 'default-app-id',
            // Mock data fallback for non-deployed/unconfigured environments
            mockData: {
                assets: [{ id: 'a1', name: 'PLC-101', location: 'Floor 1', type: 'Controller' }],
                controls: [{ id: 'c1', name: 'Network Segmentation', status: 'Deployed' }],
                risks: [{ id: 'r1', description: 'Unpatched firmware', assetId: 'a1', severity: 'Critical', status: 'Open' }],
                tasks: []
            }
        };

        // --- FIREBASE CONFIGURATION SETUP (ROBUST DEPLOYMENT FIX) ---
        let firebaseConfig = null;

        function initializeConfig() {
            try {
                // 1. Attempt to load platform config (Gemini environment)
                const fConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                appState.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (fConfig && fConfig.projectId) {
                    firebaseConfig = fConfig;
                } else {
                    console.warn("Platform Firebase config missing. Checking manual fallback.");
                   
                    // 2. Fallback for external deployment (e.g., Git) - MANUAL CONFIG GOES HERE
                    
                    firebaseConfig = {
                        apiKey: "AIzaSyAyDKqA-j9yjp4KeGPGR49Cr6_q_drxBVs",
  authDomain: "otgaurdian.firebaseapp.com",
  projectId: "otgaurdian",
  storageBucket: "otgaurdian.firebasestorage.app",
  messagingSenderId: "719542806938",
  appId: "1:719542806938:web:ed9376fcc7d04851e47223",
  measurementId: "G-9FMPGC5C93"
                    };
                    

                    if (!firebaseConfig) {
                        const failMsg = "CRITICAL: No Firebase configuration available. Running in read-only mock mode.";
                        console.error(failMsg);
                        appState.error = failMsg + " (Manually add config for external deployment.)";
                    }
                }
            } catch (e) {
                console.error("Error parsing Firebase config:", e);
                appState.error = "Error initializing configuration.";
            }
        }
       
        // --- HELPER FUNCTIONS ---
       
        function createElement(tag, classes = '', content = '') {
            const el = document.createElement(tag);
            if (classes) el.className = classes;
            if (typeof content === 'string') {
                el.innerHTML = content;
            } else if (content instanceof Node) {
                el.appendChild(content);
            } else if (Array.isArray(content)) {
                content.forEach(c => el.appendChild(c));
            }
            return el;
        }

        function getIcon(name, classes = 'w-5 h-5') {
            const iconElement = document.createElement('i');
            iconElement.className = classes;
            iconElement.innerHTML = `<svg data-lucide="${name}" class="${classes}"></svg>`;
            return iconElement;
        }

        function createMessageBox(type, message, onClose) {
            if (!message) return createElement('div');
           
            let colorClass, IconName;

            switch (type) {
                case 'success':
                    colorClass = "bg-green-100 text-green-800 border border-green-300";
                    IconName = 'check-circle';
                    break;
                case 'error':
                    colorClass = "bg-red-100 text-red-800 border border-red-300";
                    IconName = 'alert-triangle';
                    break;
                default:
                    colorClass = "bg-blue-100 text-blue-800 border border-blue-300";
                    IconName = 'info';
            }

            const box = createElement('div', `p-4 rounded-xl shadow-lg flex items-center mb-4 transition-all duration-300 ${colorClass}`);
           
            box.appendChild(getIcon(IconName, 'w-5 h-5 mr-3 flex-shrink-0'));
            box.appendChild(createElement('span', 'text-sm font-medium flex-grow', message));
           
            if (onClose) {
                const closeBtn = createElement('button', 'ml-4 text-gray-500 hover:text-gray-700');
                closeBtn.appendChild(getIcon('x', 'w-4 h-4'));
                closeBtn.addEventListener('click', onClose);
                box.appendChild(closeBtn);
            }
           
            return box;
        }

        // --- VIEW CREATION FUNCTIONS ---

        function createLoadingView() {
            const container = createElement('div', 'flex justify-center items-center h-96');
            const spinner = createElement('div', 'animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500');
            const text = createElement('p', 'ml-4 text-lg text-gray-600', 'Loading Application Data...');
            container.append(spinner, text);
            return container;
        }

        function createRiskDashboardView(data) {
            const container = createElement('div', 'space-y-6');
            container.appendChild(createElement('h2', 'text-3xl font-extrabold text-gray-900 border-b pb-2', 'OT Risk Dashboard'));
           
            // Key Metrics Cards
            const cardsData = [
                { title: "Total Assets", value: data.assets.length, icon: 'cpu', color: "text-indigo-500", bg: "bg-indigo-50" },
                { title: "Critical Risks", value: data.risks.filter(r => r.severity === 'Critical').length, icon: 'shield', color: "text-red-500", bg: "bg-red-50" },
                { title: "Controls Deployed", value: data.controls.filter(c => c.status === 'Deployed').length, icon: 'check-circle', color: "text-green-500", bg: "bg-green-50" },
            ];

            const cardsGrid = createElement('div', 'grid grid-cols-1 md:grid-cols-3 gap-6');
            cardsData.forEach(card => {
                const cardEl = createElement('div', `p-6 rounded-xl shadow-lg ${card.bg} border-l-4 border-indigo-400`);
                const content = createElement('div', 'flex items-center');
                content.appendChild(getIcon(card.icon, `w-8 h-8 ${card.color} mr-4`));
                content.appendChild(createElement('div', '', [
                    createElement('p', 'text-sm font-medium text-gray-500', card.title),
                    createElement('p', 'text-3xl font-bold text-gray-900', card.value.toString())
                ]));
                cardEl.appendChild(content);
                cardsGrid.appendChild(cardEl);
            });
            container.appendChild(cardsGrid);

            // Risk Breakdown Table
            container.appendChild(createElement('h3', 'text-2xl font-semibold text-gray-800 pt-4', 'Top 5 Outstanding Risks'));
           
            const tableContainer = createElement('div', 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive');
            const table = createElement('table', 'min-w-full divide-y divide-gray-200');
            const thead = createElement('thead', 'bg-gray-50');
            const trHead = createElement('tr');
            ['Risk ID', 'Description', 'Asset', 'Severity', 'Status'].forEach(header => {
                trHead.appendChild(createElement('th', 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider', header));
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = createElement('tbody', 'bg-white divide-y divide-gray-200');
            data.risks.slice(0, 5).forEach(risk => {
                const trBody = createElement('tr', 'hover:bg-gray-50 transition-colors');
                const assetName = data.assets.find(a => a.id === risk.assetId)?.name || 'N/A';
               
                const severityClass = risk.severity === 'Critical' ? 'bg-red-100 text-red-800' :
                                      risk.severity === 'High' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-blue-100 text-blue-800';

                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900', risk.id.substring(0, 8)));
                trBody.appendChild(createElement('td', 'px-6 py-4 text-sm text-gray-500', risk.description));
                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500', assetName));
               
                const severityTd = createElement('td', 'px-6 py-4 whitespace-nowrap text-sm font-semibold');
                severityTd.appendChild(createElement('span', `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${severityClass}`, risk.severity));
                trBody.appendChild(severityTd);
               
                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500', risk.status));
               
                tbody.appendChild(trBody);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);

            return container;
        }

        function createAdminView() {
            const { userId, userRole, isFirebaseReady } = appState;
           
            const mockUsers = [
                { id: 1, email: 'faysalhasan2001@yahoo.com', role: 'Engineer', lastLogin: '2025-11-28' },
                { id: 2, email: 'auditor@otg.com', role: 'Auditor', lastLogin: '2025-11-27' },
                { id: 3, email: 'CYBERMELB@GMAIL.COM', role: 'Admin', lastLogin: '2025-11-29' },
            ];

            let userEmail = 'N/A (Anonymous/Uninitialized)';
            if (isFirebaseReady && appState.auth && appState.auth.currentUser) {
                userEmail = appState.auth.currentUser.email || appState.auth.currentUser.uid;
            }

            const currentUserInfo = {
                id: 99,
                email: userEmail,
                role: userRole || 'Loading...',
                lastLogin: new Date().toLocaleDateString(),
                isCurrent: true
            };

            const allUsers = [currentUserInfo, ...mockUsers.filter(u => u.email !== currentUserInfo.email)];

            const container = createElement('div', 'space-y-6');
            container.appendChild(createElement('h2', 'text-3xl font-extrabold text-gray-900 border-b pb-2 flex items-center', [
                getIcon('users', 'w-7 h-7 mr-2 text-indigo-600'),
                createElement('span', '', 'User & Application Management')
            ]));
           
            const statusBox = createElement('div', 'bg-indigo-50 border-l-4 border-indigo-400 text-indigo-700 p-4 rounded-xl shadow-md');
            statusBox.appendChild(createElement('p', 'font-bold', 'Your Current Role Status:'));
            statusBox.appendChild(createElement('p', 'text-sm', `User ID: ` + `<span class="font-mono bg-indigo-100 p-1 rounded text-xs">${userId}</span>`));
            statusBox.appendChild(createElement('p', 'text-sm', `Authenticated Role (from token claims): ` + `<span class="font-bold text-lg text-indigo-900">${userRole}</span>`));
            container.appendChild(statusBox);

            container.appendChild(createElement('h3', 'text-2xl font-semibold text-gray-800 pt-4', 'Mock User Management (Demonstration)'));

            const tableContainer = createElement('div', 'bg-white rounded-xl shadow-lg overflow-x-auto table-responsive');
            const table = createElement('table', 'min-w-full divide-y divide-gray-200');
           
            // Table Head
            const thead = createElement('thead', 'bg-gray-50');
            const trHead = createElement('tr');
            ['Email', 'Role', 'Last Login', 'Status'].forEach(header => {
                trHead.appendChild(createElement('th', 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider', header));
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Table Body
            const tbody = createElement('tbody', 'bg-white divide-y divide-gray-200');
            allUsers.forEach(user => {
                const trBody = createElement('tr', `${user.isCurrent ? 'bg-indigo-50 font-bold' : 'hover:bg-gray-50'} transition-colors`);
               
                const roleClass = user.role === 'Admin' ? 'bg-red-100 text-red-800' :
                                  user.role === 'Engineer' ? 'bg-green-100 text-green-800' :
                                  'bg-blue-100 text-blue-800';

                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-900', user.email));
               
                const roleTd = createElement('td', 'px-6 py-4 whitespace-nowrap text-sm font-semibold');
                roleTd.appendChild(createElement('span', `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}`, user.role));
                trBody.appendChild(roleTd);
               
                trBody.appendChild(createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500', user.lastLogin));
               
                const statusTd = createElement('td', 'px-6 py-4 whitespace-nowrap text-sm text-gray-500');
                statusTd.innerHTML = user.isCurrent ? '<span class="text-indigo-600 font-bold">Current User</span>' : 'Active';
                trBody.appendChild(statusTd);
               
                tbody.appendChild(trBody);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);

            return container;
        }

        // Placeholder Views
        function createPlaceholderView(title, roleRequired) {
            const container = createElement('div', 'p-6 bg-white rounded-xl shadow-lg');
            container.appendChild(createElement('h2', 'text-2xl font-bold', title));
            container.appendChild(createElement('p', 'text-gray-600 mt-2', `Manage this feature here. (Requires: ${roleRequired})`));
            return container;
        }


        // --- MAIN RENDER LOOP ---

        function render() {
            const root = document.getElementById('root');
            root.innerHTML = ''; // Clear existing content

            const container = createElement('div', 'min-h-screen bg-gray-100 print-full');
            const maxWDiv = createElement('div', 'max-w-7xl mx-auto');
            container.appendChild(maxWDiv);

            // --- 1. Message Box Area ---
            const msgArea = createElement('div', 'p-4 pt-8 print-hide');
           
            const message = appState.error || (appState.isFirebaseReady && appState.isAuthenticated ? `Welcome, User ID: ${appState.userId}. Current Role: ${appState.userRole}` : "Connecting/Initializing...");
            const type = appState.error ? 'error' : 'info';
           
            msgArea.appendChild(createMessageBox(type, message, () => {
                appState.error = null;
                render();
            }));
            maxWDiv.appendChild(msgArea);

            // --- 2. Header ---
            const header = createElement('header', 'flex justify-between items-center p-4 bg-white shadow-md rounded-b-xl print-hide');
           
            const logo = createElement('div', 'flex items-center');
            logo.appendChild(getIcon('shield', 'w-8 h-8 text-indigo-600 mr-3'));
            logo.appendChild(createElement('h1', 'text-2xl font-bold text-gray-900', 'OT Guardian <span class="text-indigo-600">Demo</span>'));
            header.appendChild(logo);

            const userControls = createElement('div', 'flex items-center space-x-4');
            userControls.appendChild(createElement('span', 'text-sm font-medium text-gray-600 hidden sm:block',
                `Role: <span class="font-semibold ${appState.userRole === 'Admin' ? 'text-red-600' : 'text-indigo-600'}">${appState.userRole}</span>`
            ));
           
            if (appState.isAuthenticated) {
                const signOutBtn = createElement('button', 'flex items-center p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-all shadow-md', getIcon('log-out', 'w-5 h-5'));
                signOutBtn.title = "Sign Out";
                signOutBtn.addEventListener('click', handleSignOut);
                userControls.appendChild(signOutBtn);
            }
            header.appendChild(userControls);
            maxWDiv.appendChild(header);

            // --- 3. Navigation Bar ---
            const nav = createElement('nav', 'flex space-x-1 p-3 border-b bg-white shadow-inner rounded-xl mt-4 mx-4 overflow-x-auto whitespace-nowrap print-hide');
           
            const navItems = [
                { view: 'riskDashboard', label: 'Dashboard', icon: 'bar-chart-2', roles: ['Engineer', 'Auditor', 'Admin'] },
                { view: 'assetBuilder', label: 'Assets', icon: 'cpu', roles: ['Engineer', 'Admin'] },
                { view: 'securityControls', label: 'Controls', icon: 'check-circle', roles: ['Engineer', 'Auditor', 'Admin'] },
                { view: 'remediationTasks', label: 'Remediation', icon: 'hard-hat', roles: ['Engineer', 'Admin'] },
                { view: 'admin', label: 'Admin', icon: 'users', roles: ['Admin'] },
            ];

            navItems.forEach(item => {
                if (!item.roles.includes(appState.userRole)) return; // Role-based visibility check

                const btn = createElement('button', `flex items-center px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-150`);
                btn.classList.add(appState.currentView === item.view ? 'bg-indigo-700', 'text-white', 'shadow-md' : 'text-gray-700', 'hover:bg-indigo-100');
               
                const icon = getIcon(item.icon, 'w-4 h-4 mr-2');
                const label = document.createTextNode(item.label);
               
                btn.append(icon, label);
                btn.addEventListener('click', () => {
                    appState.currentView = item.view;
                    render();
                });
                nav.appendChild(btn);
            });
            maxWDiv.appendChild(nav);

            // --- 4. Deployment Status Bar ---
            const statusClass = appState.deploymentStatus.status === 'Online' ? 'bg-green-100 text-green-800' :
                                appState.deploymentStatus.status === 'Warning' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800';
           
            const lastCheckTime = appState.deploymentStatus.lastCheck?.seconds ?
                new Date(appState.deploymentStatus.lastCheck.seconds * 1000).toLocaleString() : 'N/A';

            const statusBar = createElement('div', `p-3 text-sm font-semibold rounded-xl text-center shadow-md mt-4 mx-4 ${statusClass} print-hide`);
            statusBar.innerHTML = `${getIcon('zap', 'w-4 h-4 inline mr-1').outerHTML} Deployment Status: ${appState.deploymentStatus.status} | Last Check: ${lastCheckTime}`;
            maxWDiv.appendChild(statusBar);


            // --- 5. Main Content Area ---
            const main = createElement('main', 'p-4 sm:p-6');
            const contentBox = createElement('div', 'bg-white p-6 rounded-xl shadow-2xl');
            main.appendChild(contentBox);

            let contentElement;

            if (!appState.isAuthReady) {
                contentElement = createLoadingView();
            } else if (!appState.isFirebaseReady) {
                // Mock Mode View
                const mockModeContainer = createElement('div', 'text-center');
                mockModeContainer.appendChild(createElement('h2', 'text-3xl font-bold text-red-600 mb-4', 'MOCK DATA MODE'));
                mockModeContainer.appendChild(createElement('p', 'text-xl text-gray-700 mb-8', 'Data persistence is disabled. Fix the configuration to enable live data.'));
                mockModeContainer.appendChild(createRiskDashboardView(appState.mockData));
                contentElement = mockModeContainer;
            } else {
                // Live View (Role and View based)
                const currentData = appState.data.assets.length > 0 ? appState.data : appState.mockData; // Use live data if available, otherwise mock

                switch (appState.currentView) {
                    case 'riskDashboard':
                        contentElement = createRiskDashboardView(currentData);
                        break;
                    case 'assetBuilder':
                        if (appState.userRole === 'Engineer' || appState.userRole === 'Admin') {
                            contentElement = createPlaceholderView('Asset Builder', 'Engineer/Admin');
                        } else {
                            contentElement = createElement('div', 'p-6 text-red-500 font-bold', 'Access Denied: Requires Engineer or Admin role.');
                        }
                        break;
                    case 'securityControls':
                        if (appState.userRole === 'Engineer' || appState.userRole === 'Auditor' || appState.userRole === 'Admin') {
                            contentElement = createPlaceholderView('Security Controls', 'Engineer/Auditor/Admin');
                        } else {
                            contentElement = createElement('div', 'p-6 text-red-500 font-bold', 'Access Denied: Requires Engineer, Auditor, or Admin role.');
                        }
                        break;
                    case 'remediationTasks':
                        if (appState.userRole === 'Engineer' || appState.userRole === 'Admin') {
                            contentElement = createPlaceholderView('Remediation Tasks', 'Engineer/Admin');
                        } else {
                            contentElement = createElement('div', 'p-6 text-red-500 font-bold', 'Access Denied: Requires Engineer or Admin role.');
                        }
                        break;
                    case 'admin':
                        if (appState.userRole === 'Admin') {
                            contentElement = createAdminView();
                        } else {
                            contentElement = createElement('div', 'p-6 text-red-500 font-bold', 'Access Denied: Requires Admin role.');
                        }
                        break;
                    default:
                        contentElement = createRiskDashboardView(currentData);
                }
            }
           
            contentBox.appendChild(contentElement);
            maxWDiv.appendChild(main);
            root.appendChild(container);

            // Feather icons replacement (using lucide icons in this version)
            // This ensures the SVG icons render correctly after DOM manipulation
            lucide.createIcons();
        }

        // --- FIREBASE LOGIC ---

        async function updateAuthState(user) {
            if (user) {
                appState.isAuthenticated = true;
                appState.userId = user.uid;
               
                // CRITICAL: Force token refresh to read custom claims (role)
                try {
                    const idTokenResult = await user.getIdTokenResult(true);
                    const role = idTokenResult.claims.role || 'Engineer';
                    appState.userRole = role;
                    console.log("User Role set from token claims:", role);
                } catch (e) {
                    console.error("Failed to get ID token result:", e);
                    appState.userRole = 'Engineer';
                }
            } else {
                appState.isAuthenticated = false;
                appState.userId = null;
                appState.userRole = 'Engineer';
            }
            appState.isAuthReady = true;
            render(); // Rerender when auth state changes
           
            if (appState.isFirebaseReady && appState.isAuthenticated && !appState.dataInitialized) {
                // Initialize data listeners after authentication is complete
                initializeDataListeners();
            }
        }

        async function initializeDataListeners() {
            if (!appState.db || !appState.userId) return;

            // Prevent multiple initializations
            appState.dataInitialized = true;

            const userIdPath = appState.userId;

            const collectionsToListen = [
                { stateKey: 'assets', path: `artifacts/${appState.appId}/users/${userIdPath}/assets` },
                { stateKey: 'controls', path: `artifacts/${appState.appId}/users/${userIdPath}/controls` },
                { stateKey: 'risks', path: `artifacts/${appState.appId}/users/${userIdPath}/risks` },
                { stateKey: 'tasks', path: `artifacts/${appState.appId}/users/${userIdPath}/tasks` },
            ];

            collectionsToListen.forEach(({ stateKey, path }) => {
                const colRef = window.firebase.collection(appState.db, path);
                const q = window.firebase.query(colRef);
                window.firebase.onSnapshot(q, (snapshot) => {
                    appState.data[stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render(); // Rerender when data updates
                }, (err) => {
                    console.error(`Error fetching ${stateKey}:`, err);
                    appState.error = `Failed to load ${stateKey} data. Check Firestore rules.`;
                    render();
                });
            });

            // Deployment status listener (public data)
            const statusDocRef = window.firebase.doc(appState.db, `artifacts/${appState.appId}/public/data/deployment/status`);
            window.firebase.onSnapshot(statusDocRef, (doc) => {
                if (doc.exists()) {
                    appState.deploymentStatus = doc.data();
                } else {
                    const defaultStatus = { status: 'Online', lastCheck: window.firebase.serverTimestamp(), message: 'Initial deployment successful.' };
                    window.firebase.setDoc(statusDocRef, defaultStatus).catch(e => console.error("Error setting default status:", e));
                    appState.deploymentStatus = defaultStatus;
                }
                render();
            }, (err) => {
                console.error("Error fetching deployment status:", err);
                appState.error = "Failed to load deployment status.";
                render();
            });
        }

        async function signInUser() {
            if (!appState.auth) return;
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(appState.auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await window.firebase.signInAnonymously(appState.auth);
                    console.log("Signed in anonymously.");
                }
            } catch (e) {
                console.error("Authentication Error:", e.message);
                appState.error = "Authentication failed. Check deployment configuration.";
                appState.isAuthReady = true;
                render();
            }
        }

        async function handleSignOut() {
            if (appState.auth) {
                try {
                    await window.firebase.signOut(appState.auth);
                    appState.currentView = 'riskDashboard';
                    appState.error = "Successfully signed out.";
                    render();
                } catch (e) {
                    console.error("Sign out error:", e);
                    appState.error = "Failed to sign out.";
                    render();
                }
            }
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            initializeConfig();
           
            if (firebaseConfig) {
                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    appState.db = window.firebase.getFirestore(app);
                    appState.auth = window.firebase.getAuth(app);
                    window.firebase.setLogLevel('debug');
                    appState.isFirebaseReady = true;

                    // Set up auth listener before signing in
                    window.firebase.onAuthStateChanged(appState.auth, updateAuthState);

                    // Attempt initial sign-in
                    signInUser();
                } catch (e) {
                    console.error("Fatal Firebase Init Error:", e);
                    appState.error = "Fatal Firebase Initialization Error: Check console.";
                    appState.isAuthReady = true;
                }
            } else {
                // If no config, set auth ready and render mock mode immediately
                appState.isAuthReady = true;
            }
           
            render(); // Initial render (will show loading screen or mock mode)
        };
    </script>
</body>
</html>

